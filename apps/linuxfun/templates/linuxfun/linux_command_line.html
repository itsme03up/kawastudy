{% extends 'base.html' %}

{% block title %}æ¥½ã—ã„Linux - Kawada Study{% endblock %}

{% block extra_css %}
<style>
/* çœç•¥ã›ãšã«å¿…è¦ãªCSSå…¨ä½“ã‚’å¾©å…ƒ */
.terminal-container {
    display: flex;
    flex-direction: column;
    background-color: #000;
    color: #00ff00;
    font-family: "Courier New", "Monaco", "Menlo", monospace;
    height: calc(100vh - 140px); /* ãƒŠãƒ“ãƒãƒ¼ã‚„ä½™ç™½ã‚’è€ƒæ…®ã—ã¦é«˜ã•ã‚’èª¿æ•´ */
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.terminal-header {
    background: #333;
    color: #fff;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    border-bottom: 1px solid #555;
}

.terminal-controls {
    display: flex;
    gap: 8px;
}

.terminal-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    cursor: pointer;
}

.btn-close { background: #ff5f56; }
.btn-minimize { background: #ffbd2e; }
.btn-maximize { background: #27ca3f; }

.main-content {
    display: flex;
    flex-grow: 1;
    min-height: 0;
    overflow: hidden;
}

.story-panel {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: #88ff88;
    padding: 20px;
    width: 300px;
    border-right: 3px solid #00ff00;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0, 255, 0, 0.1);
}

.story-panel h3 {
    color: #00ffff;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 16px;
    border-bottom: 2px solid #00ff00;
    padding-bottom: 8px;
}

.story-panel p {
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 14px;
}

.story-hint {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 13px;
}

.story-hint strong {
    color: #ffff00;
}

.log-panel {
    flex-grow: 1;
    min-height: 0;
    background-color: #000;
    padding: 15px;
    overflow-y: auto;
    border-right: 1px solid #333;
    position: relative;
}

.log-panel::-webkit-scrollbar {
    width: 8px;
}

.log-panel::-webkit-scrollbar-track {
    background: #111;
}

.log-panel::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 4px;
}

.log-panel::-webkit-scrollbar-thumb:hover {
    background: #555;
}

#logOutput {
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
    min-height: 100%;
}

.input-area {
    display: flex;
    align-items: center;
    background: #111;
    padding: 12px 15px;
    border-top: 1px solid #333;
}

.prompt {
    color: #00ff00;
    margin-right: 10px;
    font-weight: bold;
    white-space: nowrap;
}

#commandInput {
    background: transparent;
    border: none;
    color: #00ff00;
    font-family: inherit;
    font-size: 14px;
    flex-grow: 1;
    outline: none;
    padding: 0;
}

#commandInput::placeholder {
    color: #666;
}

.command-output {
    color: #fff;
}

.error-output {
    color: #ff6b6b;
}

.success-output {
    color: #51cf66;
}

.hidden-output {
    color: #ffff00;
    background: rgba(255, 255, 0, 0.1);
    padding: 2px 4px;
    border-radius: 2px;
}

.container-fluid {
    padding: 20px;
    padding-top: 10px; /* ãƒŠãƒ“ãƒãƒ¼åˆ†ã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ç¢ºä¿ */
    height: 100vh;
    box-sizing: border-box;
}

.navbar .container-fluid {
    padding-top: 0 !important;
}

.back-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    text-decoration: none;
    transition: background 0.3s;
    font-size: 12px;
}

.back-btn:hover {
    background: rgba(0, 0, 0, 0.95);
    color: white;
    text-decoration: none;
}

.stage-progress {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 12px;
    text-align: center;
}

@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }

    .story-panel {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 3px solid #00ff00;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- å‰Šé™¤: ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <div class="terminal-container">
        <div class="terminal-header">
            <span>ğŸ§ Kawada Linux Terminal - ãƒŸã‚¹ãƒ†ãƒªãƒ¼å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰</span>
            <div class="terminal-controls">
                <div class="terminal-btn btn-close"></div>
                <div class="terminal-btn btn-minimize"></div>
                <div class="terminal-btn btn-maximize"></div>
            </div>
        </div>
        <div class="main-content">
            <div class="story-panel">
                <div class="stage-progress">
                    <strong>ã‚¹ãƒ†ãƒ¼ã‚¸ <span id="currentStage">1</span> / 5</strong>
                </div>
                <h3 id="stageTitle">ğŸ§© ã‚¹ãƒ†ãƒ¼ã‚¸1ï¼šæ¶ˆãˆãŸå·ç”°å…ˆç”Ÿã®è¬</h3>
                <p id="storyText">
                    ã‚ã‚‹æ—¥ã€å·ç”°å…ˆç”ŸãŒæ•™å®¤ã‹ã‚‰å¿½ç„¶ã¨å§¿ã‚’æ¶ˆã—ãŸã€‚<br>
                    æœºã®ä¸Šã«ã¯ã€Linuxã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒé–‹ã‹ã‚ŒãŸã¾ã¾ã®ãƒ‘ã‚½ã‚³ãƒ³ãŒæ®‹ã•ã‚Œã¦ã„ãŸ...<br><br>
                    ã€Œå…ˆç”Ÿã®ç—•è·¡ã‚’æ¢ã™ãŸã‚ã«ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€<br>
                    å›ã¯å·ç”°å…ˆç”Ÿã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã›ã‚‹ã‹ï¼Ÿ
                </p>
                <div class="story-hint">
                    <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong><br>
                    <span id="hintText">ã¾ãšã¯ 'ls -la' ã‚³ãƒãƒ³ãƒ‰ã§è©³ç´°ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚æ€ªã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã¯ãš...</span>
                </div>
            </div>
            <div class="log-panel">
                <pre id="logOutput">ğŸ§ Kawada Linux Mystery Terminal
=================================
ä½•ã‹é‡è¦ãªæ‰‹ãŒã‹ã‚ŠãŒéš ã•ã‚Œã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

kawada@research-lab:~$ </pre>
            </div>
        </div>
        <div class="input-area">
            <span class="prompt" id="prompt">kawada@research-lab:~$</span>
            <input type="text" id="commandInput" autocomplete="off" placeholder="ã‚³ãƒãƒ³ãƒ‰ã‚’å…¥åŠ›ã—ã¦è¬ã‚’è§£ãæ˜ã‹ãã†..." />
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const commandInput = document.getElementById('commandInput');
    const logOutput = document.getElementById('logOutput');
    const stageTitle = document.getElementById('stageTitle');
    const storyText = document.getElementById('storyText');
    const hintText = document.getElementById('hintText');
    const currentStageSpan = document.getElementById('currentStage');

    // --- Game State ---
    let currentStage = 1;
    let currentPath = '/home/kawada';
    const promptSpan = document.getElementById('prompt');

    // --- File System Simulation ---
    const fs = {
        '/home/kawada': {
            type: 'dir',
            files: ['research_notes.txt', 'secret_log.txt', 'kawada_diary.log', 'backup_data', '.hidden_clue']
        },
        '/mnt': { type: 'dir', files: ['kawada'] },
        '/mnt/kawada': { type: 'dir', files: ['memory'] },
        '/mnt/kawada/memory': { type: 'dir', files: [] }, // core.dump appears in stage 3
        '/lost+found': { type: 'dir', files: [] } // kawada.id appears in stage 5
    };

    const fileContents = {
        'secret_log.txt': `...
[LOG] System check... OK
[LOG] User 'kawada' logged in.
[LOG] Running simulation...
[ERROR] Unhandled exception caught.
[LOG] Generating core dump...
æœ€çµ‚è¨˜éŒ²: /mnt/kawada/memory/core.dump ã«ç•°å¸¸ãªãƒ‘ã‚±ãƒƒãƒˆãƒ­ã‚°`,
        '.hidden_clue': `ğŸ“ .hidden_clue ã®å†…å®¹:\nå·ç”°å…ˆç”Ÿã®æœ€å¾Œã®è¨€è‘‰ãŒæ®‹ã•ã‚Œã¦ã„ã‚‹â€¦â€¦ï¼\n\n"ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€çµ‚è¡Œã‚’è¦‹ã‚â€¦"\n\nâ†’ ãƒ’ãƒ³ãƒˆ: cat secret_log.txt | tail -n 1`,
        'core.dump': `ğŸ“¦ core.dump ã®å†…å®¹:\n\n[è¨˜æ†¶ãƒ­ã‚°æ–­ç‰‡]\n...è§£æå¯¾è±¡: [az1._resonance]...\n...è­¦å‘Š: memory overflow at sector 0x1f...\n\n== BEGIN TRANSMISSION ==\nk4w4d4::ifconfig_eth0_down::echo_"ã•ã‚ˆãªã‚‰ä¸–ç•Œ"\n== END TRANSMISSION ==`,
        'kawada.id': `ğŸ‘¤ å·ç”°ã®IDãƒ•ã‚¡ã‚¤ãƒ«\n\n"å›ãŒç§ã‚’å†æ§‹æˆã—ã¦ãã‚ŒãŸã®ã‹...æ„Ÿè¬ã™ã‚‹ã€‚\nã“ã®ä¸–ç•Œã®ã‚³ã‚¢(/system/core)ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’å›ã«è¨—ã™ã€‚\næœ€å¾Œã®é¸æŠã‚’ã—ã¦ãã‚Œ..."\n\nâ†’ ãƒ’ãƒ³ãƒˆ: sudo reboot --rescue-kawada`
    };

    // --- Stage Definitions ---
    const stages = {
        1: {
            title: "ğŸ§© ã‚¹ãƒ†ãƒ¼ã‚¸1ï¼šæ¶ˆãˆãŸå·ç”°å…ˆç”Ÿã®è¬",
            story: `ã‚ã‚‹æ—¥ã€å·ç”°å…ˆç”ŸãŒæ•™å®¤ã‹ã‚‰å¿½ç„¶ã¨å§¿ã‚’æ¶ˆã—ãŸã€‚<br>æœºã®ä¸Šã«ã¯ã€Linuxã‚¿ãƒ¼ãƒŸãƒŠãƒ«ãŒé–‹ã‹ã‚ŒãŸã¾ã¾ã®ãƒ‘ã‚½ã‚³ãƒ³ãŒæ®‹ã•ã‚Œã¦ã„ãŸ...<br><br>ã€Œå…ˆç”Ÿã®ç—•è·¡ã‚’æ¢ã™ãŸã‚ã«ã€ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€<br>å›ã¯å·ç”°å…ˆç”Ÿã®ç§˜å¯†ã‚’è§£ãæ˜ã‹ã›ã‚‹ã‹ï¼Ÿ`,
            hint: "ã¾ãšã¯ 'ls -la' ã‚³ãƒãƒ³ãƒ‰ã§è©³ç´°ãªãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’ç¢ºèªã—ã¦ã¿ã‚ˆã†ã€‚æ€ªã—ã„ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã¯ãš..."
        },
        2: {
            title: "ğŸ“œ ã‚¹ãƒ†ãƒ¼ã‚¸2ï¼šç§˜å¯†ã®ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«",
            story: `éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã€ãƒ­ã‚°ã®æœ€çµ‚è¡Œã«é‡è¦ãªæƒ…å ±ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã£ãŸã€‚<br>ãƒ­ã‚°ãŒé•·å¤§ã§èª­ã¿ã«ãã„...æœ«å°¾ã ã‘ã‚’ã†ã¾ãè¡¨ç¤ºã™ã‚‹æ–¹æ³•ã¯ãªã„ã ã‚ã†ã‹ï¼Ÿ`,
            hint: "ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ«å°¾ã‚’è¦‹ã‚‹ã«ã¯ 'tail' ã‚³ãƒãƒ³ãƒ‰ãŒä¾¿åˆ©ã ã€‚ï¼ˆä¾‹: tail -n 1 secret_log.txtï¼‰"
        },
        3: {
            title: "ğŸ§  ã‚¹ãƒ†ãƒ¼ã‚¸3ï¼šå·ç”°ã®è¨˜æ†¶é ˜åŸŸã¸ã‚¢ã‚¯ã‚»ã‚¹",
            story: `ç•°å¸¸ãƒ‘ã‚±ãƒƒãƒˆã®é€ä¿¡å…ˆã€Œ/mnt/kawada/memory/core.dumpã€ã‚’ç¢ºèªã›ã‚ˆã€‚<br>ã“ã®ãƒ¡ãƒ¢ãƒªé ˜åŸŸã«ã¯ã€å·ç”°å…ˆç”Ÿã®ç²¾ç¥ãƒ‡ãƒ¼ã‚¿ã®æ–­ç‰‡ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã€‚<br><br>æ¬¡ã¯ã€core.dump ã‚’èª¿æŸ»ã™ã‚‹ã“ã¨ã§ã•ã‚‰ãªã‚‹æ‰‹ãŒã‹ã‚Šã‚’å¾—ã‚ˆã†ã€‚`,
            hint: "'cd /mnt/kawada/memory' ã—ã¦ã‹ã‚‰ 'ls' ã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã€'cat core.dump' ã‚’è©¦ã—ã¦ã¿ã‚ˆã†",
            onEnter: () => { fs['/mnt/kawada/memory'].files = ['core.dump']; }
        },
        4: {
            title: "ğŸ’¾ ã‚¹ãƒ†ãƒ¼ã‚¸4ï¼šå¤±ã‚ã‚ŒãŸã‚¢ã‚¯ã‚»ã‚¹æ¨©é™",
            story: `core.dump ã®ä¸­ã‹ã‚‰å¥‡å¦™ãªã‚³ãƒãƒ³ãƒ‰ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã£ãŸã€‚<br>ã€Œecho "ã•ã‚ˆãªã‚‰ä¸–ç•Œ"ã€â”€â”€ãã‚ŒãŒéµã«ãªã‚‹ã‹ã‚‚ã—ã‚Œãªã„ã€‚<br><br>å›ã®å£°ãŒå·ç”°å…ˆç”Ÿã«å±Šã‘ã°ã€ç²¾ç¥ã¯å†æ§‹æˆã•ã‚Œã‚‹ã¯ãšã ã€‚`,
            hint: "echo 'ã•ã‚ˆãªã‚‰ä¸–ç•Œ' ã‚’å®Ÿè¡Œã—ã¦ã¿ã‚ˆã†"
        },
        5: {
            title: "ğŸ”“ ã‚¹ãƒ†ãƒ¼ã‚¸5ï¼šå†æ§‹æˆã•ã‚ŒãŸæ€å¿µ",
            story: `è¨˜æ†¶æ–­ç‰‡ã®å†æ§‹æˆãŒæˆåŠŸã—ã€æ–°ãŸãªã‚¢ã‚¯ã‚»ã‚¹ãƒ‘ã‚¹ãŒé–‹ã‹ã‚ŒãŸã€‚<br>å·ç”°å…ˆç”Ÿã®æ„è­˜ã¯ã¾ã ã€ãƒ‡ãƒ¼ã‚¿ã®æµ·ã®ã©ã“ã‹ã«ã‚ã‚‹ã€‚<br><br>/lost+found ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æ½œã‚€ã€Œå½¼è‡ªèº«ã®IDã€ã‚’ç™ºè¦‹ã—ã‚ˆã†ã€‚`,
            hint: "'cd /lost+found' ã—ã¦ 'ls' ã—ã‚ˆã†",
            onEnter: () => { fs['/lost+found'].files = ['kawada.id']; }
        },
        6: {
            title: "ğŸ”¥ æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¸ï¼šé¸æŠã®æ™‚",
            story: `å·ç”°å…ˆç”Ÿã®ç²¾ç¥ã¯å†æ§‹æˆã•ã‚ŒãŸã€‚ã ãŒã€ã²ã¨ã¤ã®é¸æŠãŒæ±‚ã‚ã‚‰ã‚Œã‚‹ã€‚<br><br>å½¼ã‚’æ•‘ã†ã‹ã€ãã‚Œã¨ã‚‚è‡ªã‚‰ãŒã“ã®Linuxä¸–ç•Œã«æ®‹ã‚‹ã‹â”€â”€<br><br>sudoæ¨©é™ã‚’ä½¿ã£ã¦ã€ä¸–ç•Œã‚’æ›¸ãæ›ãˆã‚‹ã“ã¨ãŒã§ãã‚‹...`,
            hint: "IDãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã‹ã‚ŒãŸæœ€å¾Œã®ãƒ’ãƒ³ãƒˆã‚’å®Ÿè¡Œã—ã‚ˆã†"
        }
    };

    // --- Command Definitions ---
    const commands = {
        'help': () => `ğŸ§ åˆ©ç”¨å¯èƒ½ã‚³ãƒãƒ³ãƒ‰: help, ls, cd, cat, tail, echo, pwd, whoami, date, clear, hint, sudo`,
        'ls': args => {
            const dir = fs[currentPath];
            if (!dir || dir.type !== 'dir') return 'ls: cannot access '.concat(currentPath, ': No such file or directory');
            
            const showHidden = args.includes('-la') || args.includes('-a');
            const files = showHidden ? dir.files : dir.files.filter(f => !f.startsWith('.'));
            return files.join('  ');
        },
        'cd': args => {
            const target = args[0] || '/home/kawada';
            let newPath;

            if (target.startsWith('/')) {
                // Absolute path
                newPath = target;
            } else {
                // Relative path
                const currentParts = currentPath.split('/').filter(p => p);
                const targetParts = target.split('/').filter(p => p);

                for (const part of targetParts) {
                    if (part === '..') {
                        currentParts.pop();
                    } else if (part !== '.') {
                        currentParts.push(part);
                    }
                }
                newPath = '/' + currentParts.join('/');
            }

            // Normalize path (e.g., /mnt/kawada/ -> /mnt/kawada)
            if (newPath !== '/' && newPath.endsWith('/')) {
                newPath = newPath.slice(0, -1);
            }
            
            if (fs[newPath] && fs[newPath].type === 'dir') {
                if (newPath.startsWith('/mnt/kawada/memory') && currentStage < 3) return `cd: no such file or directory: ${target}`;
                if (newPath.startsWith('/lost+found') && currentStage < 5) return `cd: no such file or directory: ${target}`;
                currentPath = newPath;
                updatePrompt();
                return null; // Success, no output
            }
            return `cd: no such file or directory: ${target}`;
        },
        'cat': args => {
            const fileName = args[0];
            if (!fileName) return 'cat: missing operand';
            if (fs[currentPath].files.includes(fileName)) {
                if (fileName === '.hidden_clue' && currentStage === 1) setTimeout(() => advanceStage(2), 500);
                if (fileName === 'core.dump' && currentStage === 3) setTimeout(() => advanceStage(4), 500);
                if (fileName === 'kawada.id' && currentStage === 5) setTimeout(() => advanceStage(6), 500);
                return fileContents[fileName] || `cat: ${fileName}: Is a directory or content is empty`;
            }
            return `cat: ${fileName}: No such file or directory`;
        },
        'tail': args => {
            const fileName = args.find(arg => !arg.startsWith('-'));
            if (!fileName) return 'tail: missing operand';

            const nArgIndex = args.indexOf('-n');
            const n = nArgIndex !== -1 && args.length > nArgIndex + 1 ? parseInt(args[nArgIndex + 1]) : 10;

            if (fs[currentPath].files.includes(fileName) && fileContents[fileName]) {
                if (fileName === 'secret_log.txt' && currentStage === 2) {
                    setTimeout(() => advanceStage(3), 500);
                }
                return fileContents[fileName].split('\n').slice(-n).join('\n');
            }
            return `tail: cannot open '${fileName}' for reading: No such file or directory`;
        },
        'echo': args => {
            const message = args.join(' ');
            if (currentStage === 4 && (message === '"ã•ã‚ˆãªã‚‰ä¸–ç•Œ"' || message === "'ã•ã‚ˆãªã‚‰ä¸–ç•Œ'")) {
                setTimeout(() => advanceStage(5), 500);
                return 'ğŸ’¡ å·ç”°ã®è¨˜æ†¶ã«å…±é³´ã—ãŸ... æ–°ãŸãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ã‚’å¾—ãŸ';
            }
            return message;
        },
        'pwd': () => currentPath,
        'whoami': () => 'kawada',
        'date': () => new Date().toLocaleString('ja-JP'),
        'clear': () => { logOutput.textContent = ''; return null; },
        'hint': () => stages[currentStage].hint,
        'sudo': args => {
            if (currentStage === 6 && args.join(' ') === 'reboot --rescue-kawada') {
                logOutput.innerHTML += `
<div class="game-clear-animation">
    <p>ã‚·ã‚¹ãƒ†ãƒ ã‚’å†èµ·å‹•ã—ã¾ã™...</p>
    <p>å·ç”°ã®ç²¾ç¥ãƒ‡ãƒ¼ã‚¿ã‚’ç¾å®Ÿä¸–ç•Œã¸è»¢é€...</p>
    <p>è»¢é€å®Œäº†ã€‚æ¥ç¶šã‚’åˆ‡æ–­ã—ã¾ã™ã€‚</p>
    <p>ã‚ã‚ŠãŒã¨ã†ã€ã¾ãŸä¼šã†æ—¥ã¾ã§...</p>
    <hr>
    <h3>GAME CLEAR</h3>
</div>`;
                commandInput.disabled = true;
                return null;
            }
            return 'sudo: you do not have sudo privileges or command is incorrect';
        }
    };

    // --- Core Functions ---
    function updatePrompt() {
        promptSpan.textContent = `kawada@research-lab:${currentPath.replace('/home/kawada', '~')}$`;
    }

    function addToLog(text, cls = '') {
        if (text === null) return;
        const line = document.createElement('div');
        if (cls) line.classList.add(cls);
        line.innerHTML = text.replace(/\n/g, '<br>');
        logOutput.appendChild(line);
        logOutput.parentElement.scrollTop = logOutput.parentElement.scrollHeight;
    }

    function advanceStage(nextStage) {
        if (currentStage >= nextStage) return;
        currentStage = nextStage;
        currentStageSpan.textContent = currentStage;
        const stage = stages[nextStage];
        stageTitle.textContent = stage.title;
        storyText.innerHTML = stage.story;
        hintText.textContent = stage.hint;
        if (stage.onEnter) stage.onEnter();
    }

    commandInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !commandInput.disabled) {
            const input = e.target.value.trim();
            addToLog(`${promptSpan.textContent} ${input}`);
            e.target.value = '';
            if (input === '') return;

            const [cmd, ...args] = input.split(/\s+/);
            const commandFunc = commands[cmd];
            
            if (commandFunc) {
                const out = commandFunc(args);
                addToLog(out);
            } else {
                addToLog(`bash: ${cmd}: command not found`, 'error-output');
            }
        }
    });

    // --- Initialization ---
    updatePrompt();
    document.querySelector('.terminal-container').addEventListener('click', () => commandInput.focus());
    commandInput.focus();
});
</script>
{% endblock %}
