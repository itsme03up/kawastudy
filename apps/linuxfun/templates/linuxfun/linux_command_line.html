{% extends 'base.html' %}

{% block title %}楽しいLinux - Kawada Study{% endblock %}

{% block extra_css %}
<style>
/* 省略せずに必要なCSS全体を復元 */
.terminal-container {
    display: flex;
    flex-direction: column;
    background-color: #000;
    color: #00ff00;
    font-family: "Courier New", "Monaco", "Menlo", monospace;
    height: calc(100vh - 140px); /* ナビバーや余白を考慮して高さを調整 */
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    overflow: hidden;
}

.terminal-header {
    background: #333;
    color: #fff;
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 14px;
    border-bottom: 1px solid #555;
}

.terminal-controls {
    display: flex;
    gap: 8px;
}

.terminal-btn {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    cursor: pointer;
}

.btn-close { background: #ff5f56; }
.btn-minimize { background: #ffbd2e; }
.btn-maximize { background: #27ca3f; }

.main-content {
    display: flex;
    flex-grow: 1;
    min-height: 0;
    overflow: hidden;
}

.story-panel {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    color: #88ff88;
    padding: 20px;
    width: 300px;
    border-right: 3px solid #00ff00;
    overflow-y: auto;
    box-shadow: 2px 0 10px rgba(0, 255, 0, 0.1);
}

.story-panel h3 {
    color: #00ffff;
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 16px;
    border-bottom: 2px solid #00ff00;
    padding-bottom: 8px;
}

.story-panel p {
    line-height: 1.6;
    margin-bottom: 15px;
    font-size: 14px;
}

.story-hint {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    padding: 10px;
    border-radius: 4px;
    margin-top: 15px;
    font-size: 13px;
}

.story-hint strong {
    color: #ffff00;
}

.log-panel {
    flex-grow: 1;
    min-height: 0;
    background-color: #000;
    padding: 15px;
    overflow-y: auto;
    border-right: 1px solid #333;
    position: relative;
}

.log-panel::-webkit-scrollbar {
    width: 8px;
}

.log-panel::-webkit-scrollbar-track {
    background: #111;
}

.log-panel::-webkit-scrollbar-thumb {
    background: #333;
    border-radius: 4px;
}

.log-panel::-webkit-scrollbar-thumb:hover {
    background: #555;
}

#logOutput {
    white-space: pre-wrap;
    font-size: 14px;
    line-height: 1.4;
    margin: 0;
    min-height: 100%;
}

.input-area {
    display: flex;
    align-items: center;
    background: #111;
    padding: 12px 15px;
    border-top: 1px solid #333;
}

.prompt {
    color: #00ff00;
    margin-right: 10px;
    font-weight: bold;
    white-space: nowrap;
}

#commandInput {
    background: transparent;
    border: none;
    color: #00ff00;
    font-family: inherit;
    font-size: 14px;
    flex-grow: 1;
    outline: none;
    padding: 0;
}

#commandInput::placeholder {
    color: #666;
}

.command-output {
    color: #fff;
}

.error-output {
    color: #ff6b6b;
}

.success-output {
    color: #51cf66;
}

.hidden-output {
    color: #ffff00;
    background: rgba(255, 255, 0, 0.1);
    padding: 2px 4px;
    border-radius: 2px;
}

.container-fluid {
    padding: 20px;
    padding-top: 120px; /* ナビバー分のスペースを確保 (増量) */
    height: 100vh;
    box-sizing: border-box;
}

.navbar .container-fluid {
    padding-top: 0 !important;
}

.back-btn {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    text-decoration: none;
    transition: background 0.3s;
    font-size: 12px;
}

.back-btn:hover {
    background: rgba(0, 0, 0, 0.95);
    color: white;
    text-decoration: none;
}

.stage-progress {
    background: rgba(0, 255, 0, 0.1);
    border: 1px solid #00ff00;
    padding: 8px;
    border-radius: 4px;
    margin-bottom: 15px;
    font-size: 12px;
    text-align: center;
}

@media (max-width: 768px) {
    .main-content {
        flex-direction: column;
    }

    .story-panel {
        width: 100%;
        height: 200px;
        border-right: none;
        border-bottom: 3px solid #00ff00;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 削除: ホームに戻るボタン -->
    <div class="terminal-container">
        <div class="terminal-header">
            <span>🐧 Kawada Linux Terminal - ミステリー学習モード</span>
            <div class="terminal-controls">
                <div class="terminal-btn btn-close"></div>
                <div class="terminal-btn btn-minimize"></div>
                <div class="terminal-btn btn-maximize"></div>
            </div>
        </div>
        <div class="main-content">
            <div class="story-panel">
                <div class="stage-progress">
                    <strong>ステージ <span id="currentStage">1</span> / 5</strong>
                </div>
                <h3 id="stageTitle">🧩 ステージ1：消えた川田先生の謎</h3>
                <p id="storyText">
                    ある日、川田先生が教室から忽然と姿を消した。<br>
                    机の上には、Linuxターミナルが開かれたままのパソコンが残されていた...<br><br>
                    「先生の痕跡を探すために、ログファイルを確認してみよう」<br>
                    君は川田先生の秘密を解き明かせるか？
                </p>
                <div class="story-hint">
                    <strong>💡 ヒント:</strong><br>
                    <span id="hintText">まずは 'ls -la' コマンドで詳細なファイル一覧を確認してみよう。怪しいファイルがあるはず...</span>
                </div>
            </div>
            <div class="log-panel">
                <pre id="logOutput">🐧 Kawada Linux Mystery Terminal
=================================
何か重要な手がかりが隠されているようです。

kawada@research-lab:~$ </pre>
            </div>
        </div>
        <div class="input-area">
            <span class="prompt">kawada@research-lab:~$</span>
            <input type="text" id="commandInput" autocomplete="off" placeholder="コマンドを入力して謎を解き明かそう..." />
        </div>
    </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const commandInput = document.getElementById('commandInput');
    const logOutput = document.getElementById('logOutput');
    const stageTitle = document.getElementById('stageTitle');
    const storyText = document.getElementById('storyText');
    const hintText = document.getElementById('hintText');
    const currentStageSpan = document.getElementById('currentStage');
    // ゲームステージとコマンド定義
    let currentStage = 1;
    let currentPath = '/home/kawada/research-lab';
    const stages = {
        1: {
            title: "🧩 ステージ1：消えた川田先生の謎",
            story: storyText.innerHTML,
            hint: hintText.textContent,
            files: ['research_notes.txt','secret_log.txt','kawada_diary.log','backup_data','.hidden_clue']
        },
        2: {
            title: "📜 ステージ2：秘密のログファイル",
            story: `ログファイルの最深部から川田先生の痕跡が見つかった。<br>彼は何かの「パケット」によってデジタルの彼方へ引きずり込まれたようだ……<br><br>Linuxの内部に残されたデータを読み解けば、まだ追いつけるかもしれない。` ,
            hint: "秘密のログファイルをもう一度よく読んでみよう（cat secret_log.txt）"
        },
        3: {
            title: "🧠 ステージ3：川田の記憶領域へアクセス",
            story: `異常パケットの送信先「/mnt/kawada/memory/core.dump」を確認せよ。<br>このメモリ領域には、川田先生の精神データの断片が保存されている可能性がある。<br><br>次は、core.dump を調査することでさらなる手がかりを得よう。`,
            hint: "'cd /mnt/kawada/memory' してから 'cat core.dump' を試してみよう"
        },
        4: {
            title: "💾 ステージ4：失われたアクセス権限",
            story: `core.dump の中から奇妙なコマンドログが見つかった。<br>「echo \"さよなら世界\"」──それが鍵になるかもしれない。<br><br>君の声が川田先生に届けば、精神は再構成されるはずだ。` ,
            hint: "echo 'さよなら世界' を実行してみよう"
        },
        5: {
            title: "🔥 最終ステージ：選択の時",
            story: `川田先生の精神は再構成された。だが、ひとつの選択が求められる。<br><br>
            川田を救うか、それとも自らがこのLinux世界に残るか──<br><br>
            sudo権限を使って、世界を書き換えることができる...` ,
            hint: "sudo chmod 070 /system/core && sudo chown kawada:you /system/core を実行してみよう"
        }
    };
    const commands = {
        'help': () => `🐧 利用可能コマンド: help, ls, cd, cat, echo, pwd, whoami, date, clear, hint`,
        'ls': args => {
            let files = [];
            if (currentPath === '/home/kawada/research-lab') {
                files = stages[1].files;
            } else if (currentPath === '/mnt/kawada/memory' && currentStage >= 3) {
                files = ['core.dump'];
            } else if (currentPath === '/lost+found' && currentStage >= 4) {
                files = ['kawada.id'];
            }

            if (args.length > 0 && args[0] === '-la') {
                return files.join('  ');
            }
            return files.filter(f => !f.startsWith('.')).join('  ');
        },
        'cd': args => {
            const targetPath = args[0];
            if (!targetPath) return 'cd: missing operand';

            if (targetPath === '/home/kawada/research-lab' || (currentStage >= 3 && targetPath === '/mnt/kawada/memory') || (currentStage >= 4 && targetPath === '/lost+found')) {
                currentPath = targetPath;
                return `Changed directory to ${targetPath}`;
            }
            return `cd: no such file or directory: ${targetPath}`;
        },
        'cat': args => {
            if (!args.length) return 'cat: ファイル名を指定';
            const file = args[0];

            if (currentPath === '/home/kawada/research-lab') {
                if (file === '.hidden_clue') {
                    setTimeout(() => advanceStage(2), 500);
                    return `📁 .hidden_clue の内容:\n川田先生の最後の言葉が残されている……！\n\n"ログファイルの最終行を見ろ…"\n\n→ ヒント: cat secret_log.txt | tail -n 1`;
                }
                if (file === 'secret_log.txt' && args[1] === '|') {
                    setTimeout(() => advanceStage(3), 500);
                    return '最終記録: /mnt/kawada/memory/core.dump に異常なパケットログ';
                }
            }

            if (currentPath === '/mnt/kawada/memory' && file === 'core.dump' && currentStage === 3) {
                setTimeout(() => advanceStage(4), 500);
                return `📦 core.dump の内容:\n\n[記憶ログ断片]\n...解析対象: [az1._resonance]...\n...警告: memory overflow at sector 0x1f...\n\n== BEGIN TRANSMISSION ==\nk4w4d4::ifconfig_eth0_down::echo_"さよなら世界"\n== END TRANSMISSION ==`;
            }
            
            return `cat: ${file}: No such file or directory`;
        },
        'echo': args => {
            const message = args.join(' ');
            if (currentStage === 4 && (message === '"さよなら世界"' || message === "'さよなら世界'")) {
                setTimeout(() => advanceStage(5), 500);
                return '💡 川田の記憶に共鳴した... 新たなディレクトリへのアクセス権を得た';
            }
            return message;
        },
        'pwd': () => currentPath,
        'whoami': () => 'kawada',
        'date': () => new Date().toLocaleString('ja-JP'),
        'clear': () => { logOutput.textContent = ''; return null; },
        'hint': () => stages[currentStage].hint,
        'sudo': args => {
            if (currentStage === 5) {
                return `🔓 ...システム権限を取得... 世界は君の手に委ねられた。\n\n--- GAME CLEAR ---`;
            }
            return 'sudo: you do not have sudo privileges';
        }
    };
    function addToLog(text, cls='') {
        if (cls) logOutput.innerHTML += `<span class="${cls}">${text}</span>\n`;
        else logOutput.innerHTML += text + '\n';
        logOutput.parentElement.scrollTop = logOutput.parentElement.scrollHeight;
    }
    function advanceStage(nextStage) {
        currentStage = nextStage;
        currentStageSpan.textContent = currentStage;
        stageTitle.textContent = stages[nextStage].title;
        storyText.innerHTML = stages[nextStage].story;
        hintText.textContent = stages[nextStage].hint;
    }
    commandInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const input = e.target.value.trim();
            addToLog(`<span class="prompt">${currentPath.replace('/home/kawada', '~')} $</span> ${input}`);
            const [cmd, ...args] = input.split(' ');

            // `ls -la` のような引数付きコマンドを単一キーとして扱う
            const fullCommand = (cmd === 'ls' && args[0] === '-la') ? 'ls -la' : cmd;

            if (commands[fullCommand]) {
                 const out = commands[fullCommand](args);
                 if (out !== null) addToLog(out);
            } else if (commands[cmd]) {
                const out = commands[cmd](args);
                if (out !== null) addToLog(out, commands[cmd] ? '' : 'error-output');
            } else {
                addToLog(`bash: ${cmd}: command not found`, 'error-output');
            }
            e.target.value = '';
        }
    });
    document.querySelector('.terminal-container').addEventListener('click', () => commandInput.focus());
    commandInput.focus();
});
</script>
{% endblock %}
