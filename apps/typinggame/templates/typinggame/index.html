{% extends 'base.html' %}

{% block title %}かわ打 - タイピングゲーム{% endblock %}

{% block extra_css %}
<style>
    .typing-game {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .typing-text {
        font-size: 1.2rem;
        line-height: 1.8;
        padding: 2rem;
        background-color: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .typing-input {
        width: 100%;
        font-size: 1.1rem;
        padding: 1rem;
        border: 2px solid var(--border-color);
        border-radius: 0.5rem;
        background-color: var(--bg-color);
        color: var(--text-color);
    }
    
    .typing-input:focus {
        border-color: var(--accent-color);
        outline: none;
    }
    
    .stats {
        display: flex;
        justify-content: space-around;
        margin-top: 1rem;
    }
    
    .stat-item {
        text-align: center;
        padding: 1rem;
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        border: 1px solid var(--border-color);
        flex: 1;
        margin: 0 0.5rem;
    }
    
    .correct { color: var(--success-color); }
    .incorrect { color: var(--danger-color); background-color: rgba(220, 53, 69, 0.1); }
    .current { background-color: var(--accent-color); color: white; }
</style>
{% endblock %}

{% block content %}
<div class="typing-game">
    <div class="text-center mb-4">
        <h1>🐟 かわ打 - タイピングゲーム</h1>
        <p>下の文章を正確に素早く入力してください！</p>
    </div>
    
    <div class="card">
        <div class="card-header">
            <div class="stats">
                <div class="stat-item">
                    <strong id="wpm">0</strong>
                    <div>WPM</div>
                </div>
                <div class="stat-item">
                    <strong id="accuracy">100%</strong>
                    <div>正確性</div>
                </div>
                <div class="stat-item">
                    <strong id="time">0:00</strong>
                    <div>時間</div>
                </div>
                <div class="stat-item">
                    <strong id="progress">0%</strong>
                    <div>進捗</div>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <div id="typing-text" class="typing-text">
                川で泳いでいる魚たちが、キーボードの上で踊っている。プログラミングは創造的な活動であり、コードを書くことで新しい世界を作り出すことができます。
            </div>
            
            <textarea 
                id="typing-input" 
                class="typing-input" 
                placeholder="ここに入力してください..."
                rows="4"
            ></textarea>
            
            <div class="text-center mt-3">
                <button id="start-btn" class="btn btn-primary">ゲーム開始</button>
                <button id="reset-btn" class="btn btn-secondary">リセット</button>
                <button id="new-text-btn" class="btn btn-success">新しい文章</button>
            </div>
        </div>
    </div>
    
    <div class="card mt-4">
        <div class="card-header">
            <h3>🏆 ベストスコア</h3>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-4 text-center">
                    <div class="stat-item">
                        <strong id="best-wpm">0</strong>
                        <div>最高WPM</div>
                    </div>
                </div>
                <div class="col-4 text-center">
                    <div class="stat-item">
                        <strong id="best-accuracy">0%</strong>
                        <div>最高正確性</div>
                    </div>
                </div>
                <div class="col-4 text-center">
                    <div class="stat-item">
                        <strong id="games-played">0</strong>
                        <div>プレイ回数</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class TypingGame {
    constructor() {
        this.textElement = document.getElementById('typing-text');
        this.inputElement = document.getElementById('typing-input');
        this.startBtn = document.getElementById('start-btn');
        this.resetBtn = document.getElementById('reset-btn');
        this.newTextBtn = document.getElementById('new-text-btn');
        
        this.currentText = '';
        this.startTime = null;
        this.isGameActive = false;
        
        this.texts = [
            '川で泳いでいる魚たちが、キーボードの上で踊っている。プログラミングは創造的な活動であり、コードを書くことで新しい世界を作り出すことができます。',
            '今日は良い天気です。桜の花が咲いて、春の訪れを感じます。新しい季節に向けて、新たな目標を立てましょう。',
            'JavaScriptは動的なプログラミング言語です。ウェブサイトにインタラクティブな機能を追加することができます。',
            '読書は知識を深める最良の方法の一つです。様々なジャンルの本を読むことで、視野を広げることができます。'
        ];
        
        this.init();
    }
    
    init() {
        this.loadBestScores();
        this.setRandomText();
        
        this.startBtn.addEventListener('click', () => this.startGame());
        this.resetBtn.addEventListener('click', () => this.resetGame());
        this.newTextBtn.addEventListener('click', () => this.setRandomText());
        this.inputElement.addEventListener('input', () => this.handleInput());
    }
    
    setRandomText() {
        const randomIndex = Math.floor(Math.random() * this.texts.length);
        this.currentText = this.texts[randomIndex];
        this.textElement.textContent = this.currentText;
        this.resetGame();
    }
    
    startGame() {
        this.isGameActive = true;
        this.startTime = Date.now();
        this.inputElement.disabled = false;
        this.inputElement.focus();
        this.startBtn.textContent = 'プレイ中...';
        this.startBtn.disabled = true;
        
        this.timer = setInterval(() => this.updateStats(), 100);
    }
    
    resetGame() {
        this.isGameActive = false;
        this.startTime = null;
        this.inputElement.value = '';
        this.inputElement.disabled = true;
        this.startBtn.textContent = 'ゲーム開始';
        this.startBtn.disabled = false;
        
        if (this.timer) {
            clearInterval(this.timer);
        }
        
        this.updateDisplay();
        this.updateStats();
    }
    
    handleInput() {
        if (!this.isGameActive) return;
        
        this.updateDisplay();
        this.updateStats();
        
        if (this.inputElement.value === this.currentText) {
            this.finishGame();
        }
    }
    
    updateDisplay() {
        const input = this.inputElement.value;
        let displayText = '';
        
        for (let i = 0; i < this.currentText.length; i++) {
            if (i < input.length) {
                if (input[i] === this.currentText[i]) {
                    displayText += `<span class="correct">${this.currentText[i]}</span>`;
                } else {
                    displayText += `<span class="incorrect">${this.currentText[i]}</span>`;
                }
            } else if (i === input.length) {
                displayText += `<span class="current">${this.currentText[i]}</span>`;
            } else {
                displayText += this.currentText[i];
            }
        }
        
        this.textElement.innerHTML = displayText;
    }
    
    updateStats() {
        if (!this.startTime) {
            document.getElementById('wpm').textContent = '0';
            document.getElementById('accuracy').textContent = '100%';
            document.getElementById('time').textContent = '0:00';
            document.getElementById('progress').textContent = '0%';
            return;
        }
        
        const elapsed = (Date.now() - this.startTime) / 1000;
        const input = this.inputElement.value;
        
        // WPM calculation
        const words = input.length / 5;
        const wpm = Math.round((words / elapsed) * 60) || 0;
        
        // Accuracy calculation
        let correct = 0;
        for (let i = 0; i < input.length; i++) {
            if (input[i] === this.currentText[i]) correct++;
        }
        const accuracy = input.length > 0 ? Math.round((correct / input.length) * 100) : 100;
        
        // Progress calculation
        const progress = Math.round((input.length / this.currentText.length) * 100);
        
        document.getElementById('wpm').textContent = wpm;
        document.getElementById('accuracy').textContent = accuracy + '%';
        document.getElementById('time').textContent = formatTime(Math.floor(elapsed));
        document.getElementById('progress').textContent = progress + '%';
    }
    
    finishGame() {
        this.isGameActive = false;
        clearInterval(this.timer);
        
        const elapsed = (Date.now() - this.startTime) / 1000;
        const words = this.currentText.length / 5;
        const wpm = Math.round((words / elapsed) * 60);
        const accuracy = 100; // 完了時は100%
        
        this.updateBestScores(wpm, accuracy);
        this.inputElement.disabled = true;
        this.startBtn.textContent = '完了！';
        
        showNotification(`完了！WPM: ${wpm}, 正確性: ${accuracy}%`, 'success');
    }
    
    loadBestScores() {
        const bestWpm = loadFromLocalStorage('typing-best-wpm', 0);
        const bestAccuracy = loadFromLocalStorage('typing-best-accuracy', 0);
        const gamesPlayed = loadFromLocalStorage('typing-games-played', 0);
        
        document.getElementById('best-wpm').textContent = bestWpm;
        document.getElementById('best-accuracy').textContent = bestAccuracy + '%';
        document.getElementById('games-played').textContent = gamesPlayed;
    }
    
    updateBestScores(wpm, accuracy) {
        const currentBestWpm = loadFromLocalStorage('typing-best-wpm', 0);
        const currentBestAccuracy = loadFromLocalStorage('typing-best-accuracy', 0);
        const gamesPlayed = loadFromLocalStorage('typing-games-played', 0);
        
        if (wpm > currentBestWpm) {
            saveToLocalStorage('typing-best-wpm', wpm);
            document.getElementById('best-wpm').textContent = wpm;
        }
        
        if (accuracy > currentBestAccuracy) {
            saveToLocalStorage('typing-best-accuracy', accuracy);
            document.getElementById('best-accuracy').textContent = accuracy + '%';
        }
        
        saveToLocalStorage('typing-games-played', gamesPlayed + 1);
        document.getElementById('games-played').textContent = gamesPlayed + 1;
    }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', () => {
    new TypingGame();
});
</script>
{% endblock %}
