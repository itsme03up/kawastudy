{% extends 'base.html' %}

{% block title %}{{ stage.title }} - Kawada SQLã‚¯ã‚¤ã‚º{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white text-center py-3">
                    <h2 class="mb-0">ğŸ§ª Kawada SQL ã‚¯ã‚¤ã‚ºï¼šStage{{ stage.stage_number|stringformat:"02d" }}ã€Š{{ stage.title }}ã€‹</h2>
                    <div class="mt-2">
                        <a href="{% url 'sqlquiz:stage_list' %}" class="btn btn-light btn-sm">
                            â† ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã«æˆ»ã‚‹
                        </a>
                    </div>
                </div>
            </div>

            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">ğŸ± ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</h5>
                </div>
                <div class="card-body bg-light">
                    <div class="story-text p-3" style="font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; line-height: 1.8;">
                        <div id="story-content-{{ stage.stage_number }}">
                            <!-- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º -->
            <div class="card shadow mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ğŸ“‹ <span id="table-name">sample_table</span> ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆè¡¨ç¤ºå°‚ç”¨ï¼‰</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover" id="sample-data-table">
                            <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã¯JavaScriptã§å‹•çš„ã«è¡¨ç¤º -->
                        </table>
                    </div>
                </div>
            </div>

            <!-- SQLå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="card shadow mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">ğŸ’¬ ã‚ãªãŸã¸ã®èª²é¡Œ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <p class="lead" id="challenge-text">{{ stage.description }}</p>
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-8">
                            <label for="sql-input" class="form-label fw-bold">SQLã‚’å…¥åŠ›ï¼š</label>
                            <textarea id="sql-input" class="form-control font-monospace" 
                                      rows="4" placeholder="SELECT ... FROM ... WHERE ..."></textarea>
                            <div class="mt-3">
                                <button id="submit-sql" class="btn btn-primary btn-lg me-2">
                                    ğŸš€ å®Ÿè¡Œãƒœã‚¿ãƒ³
                                </button>
                                <button id="clear-sql" class="btn btn-secondary">
                                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card bg-info text-white mt-3 mt-lg-0">
                                <div class="card-body text-center">
                                    <h6>ğŸ¤– å·ç”°ã®ãƒ’ãƒ³ãƒˆ</h6>
                                    <div id="hint-area" style="display: none;">
                                        <p class="small mb-0" id="hint-text">{{ stage.hint }}</p>
                                    </div>
                                    <button id="show-hint-btn" class="btn btn-light btn-sm">
                                        ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="result-section" style="display: none;">
                <!-- å·ç”°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div class="card shadow mb-4">
                    <div class="card-header" id="reaction-header">
                        <h5 class="mb-0" id="reaction-title"></h5>
                    </div>
                    <div class="card-body">
                        <div id="kawada-reaction" class="p-3" style="font-family: 'Hiragino Sans', 'Yu Gothic', sans-serif; line-height: 1.8;">
                            <!-- å·ç”°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ -->
                        </div>
                    </div>
                </div>

                <!-- å®Ÿè¡Œçµæœãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="card shadow">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0">ğŸ“Š å®Ÿè¡Œçµæœï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å½¢å¼ï¼‰</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive" id="result-table-container">
                            <!-- å®Ÿè¡Œçµæœãƒ†ãƒ¼ãƒ–ãƒ« -->
                        </div>
                        <div class="text-center mt-3" id="next-stage-area" style="display: none;">
                            <a href="{% url 'sqlquiz:stage_list' %}" class="btn btn-success btn-lg">
                                æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ â†’
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const stageNumber = parseInt('{{ stage.stage_number }}');
    let stageData = null;
    
    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    fetchStageData();
    
    async function fetchStageData() {
        try {
            const response = await fetch(`{% url 'sqlquiz:get_stage_data' stage.stage_number %}`);
            stageData = await response.json();
            initializePage();
        } catch (error) {
            console.error('ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿
            stageData = {
                tableName: 'sample_table',
                story: 'ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...',
                sampleData: [],
                successReaction: 'æˆåŠŸã—ã¾ã—ãŸï¼',
                failureReaction: 'ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚',
                mockResult: []
            };
            initializePage();
        }
    }

    function initializePage() {
        if (!stageData) return;
        
        // ã‚¹ãƒˆãƒ¼ãƒªãƒ¼è¡¨ç¤º
        document.getElementById(`story-content-${stageNumber}`).innerHTML = stageData.story;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«åè¨­å®š
        document.getElementById('table-name').textContent = stageData.tableName;
        
        // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
        createSampleTable(stageData.sampleData);
    }

    function createSampleTable(data) {
        if (!data || data.length === 0) return;
        
        const table = document.getElementById('sample-data-table');
        const headers = Object.keys(data[0]);
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ä½œæˆ
        let headerHtml = '<thead class="table-dark"><tr>';
        headers.forEach(header => {
            headerHtml += `<th>${header}</th>`;
        });
        headerHtml += '</tr></thead>';
        
        // ãƒ‡ãƒ¼ã‚¿è¡Œä½œæˆ
        let bodyHtml = '<tbody>';
        data.forEach(row => {
            bodyHtml += '<tr>';
            headers.forEach(header => {
                bodyHtml += `<td>${row[header]}</td>`;
            });
            bodyHtml += '</tr>';
        });
        bodyHtml += '</tbody>';
        
        table.innerHTML = headerHtml + bodyHtml;
    }

    // SQLå®Ÿè¡Œå‡¦ç†
    const sqlInput = document.getElementById('sql-input');
    const submitBtn = document.getElementById('submit-sql');
    const clearBtn = document.getElementById('clear-sql');
    const showHintBtn = document.getElementById('show-hint-btn');
    const hintArea = document.getElementById('hint-area');

    // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    showHintBtn.addEventListener('click', function() {
        hintArea.style.display = 'block';
        showHintBtn.style.display = 'none';
    });

    // SQLå®Ÿè¡Œ
    submitBtn.addEventListener('click', function() {
        const sql = sqlInput.value.trim();
        if (!sql) {
            alert('SQLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ å®Ÿè¡Œä¸­...';

        fetch('{% url "sqlquiz:check_answer" stage.stage_number %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({sql: sql})
        })
        .then(response => response.json())
        .then(data => {
            showResult(data.correct, data);
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ğŸš€ å®Ÿè¡Œãƒœã‚¿ãƒ³';
        });
    });

    // ã‚¯ãƒªã‚¢
    clearBtn.addEventListener('click', function() {
        sqlInput.value = '';
        document.getElementById('result-section').style.display = 'none';
    });

    function showResult(isCorrect, data) {
        const resultSection = document.getElementById('result-section');
        
        // å·ç”°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
        const reactionHeader = document.getElementById('reaction-header');
        const reactionTitle = document.getElementById('reaction-title');
        const kawadaReaction = document.getElementById('kawada-reaction');
        
        if (isCorrect) {
            reactionHeader.className = 'card-header bg-success text-white';
            reactionTitle.innerHTML = 'âœ… æˆåŠŸ - å·ç”°ã®åå¿œ';
            kawadaReaction.innerHTML = stageData.successReaction;
            
            // æ¨¡æ“¬å®Ÿè¡Œçµæœã‚’è¡¨ç¤º
            showMockResult();
            document.getElementById('next-stage-area').style.display = 'block';
        } else {
            reactionHeader.className = 'card-header bg-danger text-white';
            reactionTitle.innerHTML = 'âŒ å¤±æ•— - å·ç”°ã®åå¿œ';
            kawadaReaction.innerHTML = stageData.failureReaction;
            
            if (data.correct_sql) {
                kawadaReaction.innerHTML += `<br><br><strong>æ­£è§£ä¾‹ï¼š</strong><br><code>${data.correct_sql}</code>`;
            }
        }
        
        resultSection.style.display = 'block';
        resultSection.scrollIntoView({ behavior: 'smooth' });
    }

    function showMockResult() {
        const container = document.getElementById('result-table-container');
        
        const result = stageData.mockResult;
        if (!result || result.length === 0) return;
        
        const headers = Object.keys(result[0]);
        
        let tableHtml = '<table class="table table-striped table-bordered">';
        tableHtml += '<thead class="table-success"><tr>';
        headers.forEach(header => {
            tableHtml += `<th>${header}</th>`;
        });
        tableHtml += '</tr></thead><tbody>';
        
        result.forEach(row => {
            tableHtml += '<tr>';
            headers.forEach(header => {
                tableHtml += `<td>${row[header]}</td>`;
            });
            tableHtml += '</tr>';
        });
        
        tableHtml += '</tbody></table>';
        container.innerHTML = tableHtml;
    }
});
</script>

<style>
.font-monospace {
    font-family: 'Courier New', monospace;
}

#sql-input {
    font-size: 14px;
    line-height: 1.4;
}

.story-text {
    background-color: #f8f9fa;
    border-left: 4px solid #007bff;
    font-size: 1.1rem;
}

.table-hover tbody tr:hover {
    background-color: rgba(0,123,255,.1);
}

.card {
    transition: transform 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-2px);
}
</style>
{% endblock %}
