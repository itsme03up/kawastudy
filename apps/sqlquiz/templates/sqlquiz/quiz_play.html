{% extends 'base.html' %}

{% block title %}{{ stage.title }} - Kawada SQLã‚¯ã‚¤ã‚º{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
            <div class="card shadow-lg mb-4">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="mb-0">Stage{{ stage.stage_number|stringformat:"02d" }}ã€Š{{ stage.title }}ã€‹</h2>
                        </div>
                        <div>
                            <a href="{% url 'sqlquiz:stage_list' %}" class="btn btn-light btn-sm">
                                â† ã‚¹ãƒ†ãƒ¼ã‚¸é¸æŠã«æˆ»ã‚‹
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5>ğŸ¯ ãƒŸãƒƒã‚·ãƒ§ãƒ³</h5>
                            <p class="lead">{{ stage.description }}</p>
                            
                            <h6 class="mt-4">ğŸ“ å•é¡Œ</h6>
                            <div class="p-3 bg-light rounded">
                                {{ stage.question|linebreaks }}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white">
                                <div class="card-body text-center">
                                    <h6>ğŸ¤– å·ç”°ã®ãƒ’ãƒ³ãƒˆ</h6>
                                    <div id="hint-area" style="display: none;">
                                        <p class="small mb-0" id="hint-text">{{ stage.hint }}</p>
                                    </div>
                                    <button id="show-hint-btn" class="btn btn-light btn-sm">
                                        ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SQLå…¥åŠ›ã‚¨ãƒªã‚¢ -->
            <div class="card shadow-lg">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">ğŸ’» SQLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="mb-3">
                                <textarea id="sql-input" class="form-control font-monospace" 
                                          rows="8" placeholder="SELECT * FROM ..."></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="submit-sql" class="btn btn-primary">
                                    ğŸš€ å®Ÿè¡Œã™ã‚‹
                                </button>
                                <button id="clear-sql" class="btn btn-secondary">
                                    ğŸ—‘ï¸ ã‚¯ãƒªã‚¢
                                </button>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div id="result-area" class="mt-3 mt-lg-0">
                                <!-- çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sqlInput = document.getElementById('sql-input');
    const submitBtn = document.getElementById('submit-sql');
    const clearBtn = document.getElementById('clear-sql');
    const resultArea = document.getElementById('result-area');
    const showHintBtn = document.getElementById('show-hint-btn');
    const hintArea = document.getElementById('hint-area');

    // ãƒ’ãƒ³ãƒˆè¡¨ç¤º
    showHintBtn.addEventListener('click', function() {
        hintArea.style.display = 'block';
        showHintBtn.style.display = 'none';
    });

    // SQLå®Ÿè¡Œ
    submitBtn.addEventListener('click', function() {
        const sql = sqlInput.value.trim();
        if (!sql) {
            showResult('error', 'SQLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = 'â³ å®Ÿè¡Œä¸­...';

        fetch(`{% url 'sqlquiz:check_answer' stage.stage_number %}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({sql: sql})
        })
        .then(response => response.json())
        .then(data => {
            if (data.correct) {
                showResult('success', 'ğŸ‰ æ­£è§£ã§ã™ï¼ç´ æ™´ã‚‰ã—ã„ï¼', data);
            } else {
                showResult('error', 'âŒ æƒœã—ã„ï¼ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†', data);
            }
        })
        .catch(error => {
            showResult('error', 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
            console.error('Error:', error);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'ğŸš€ å®Ÿè¡Œã™ã‚‹';
        });
    });

    // ã‚¯ãƒªã‚¢
    clearBtn.addEventListener('click', function() {
        sqlInput.value = '';
        resultArea.innerHTML = '';
    });

    function showResult(type, message, data = null) {
        let html = `
            <div class="alert alert-${type === 'success' ? 'success' : 'danger'}" role="alert">
                <h6>${message}</h6>
        `;
        
        if (data && !data.correct && data.correct_sql) {
            html += `
                <hr>
                <small><strong>æ­£è§£ä¾‹:</strong></small><br>
                <code class="small">${data.correct_sql}</code>
            `;
        }
        
        if (type === 'success') {
            html += `
                <hr>
                <div class="text-center">
                    <a href="{% url 'sqlquiz:stage_list' %}" class="btn btn-success btn-sm">
                        æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã¸ â†’
                    </a>
                </div>
            `;
        }
        
        html += '</div>';
        resultArea.innerHTML = html;
    }
});
</script>

<style>
.font-monospace {
    font-family: 'Courier New', monospace;
}

#sql-input {
    font-size: 14px;
    line-height: 1.4;
}
</style>
{% endblock %}
