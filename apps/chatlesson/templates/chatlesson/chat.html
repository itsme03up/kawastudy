{% extends 'base.html' %}
{% load static %}

{% block title %}å·ç”°å…ˆç”Ÿã¨ã®ãƒãƒ£ãƒƒãƒˆ - Kawada Study{% endblock %}

{% block extra_css %}
<style>
    html, body {
        font-family: "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
        overflow: hidden; /* ãƒšãƒ¼ã‚¸å…¨ä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Œå…¨ã«ç¦æ­¢ */
        height: 100vh;
        margin: 0;
        padding: 0;
    }

    .main-layout-chat {
        display: flex;
        height: 100vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå…¨ä½“ã®é«˜ã•ã‚’ä½¿ç”¨ */
        width: 100vw; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆå…¨ä½“ã®å¹…ã‚’ä½¿ç”¨ */
        position: fixed;
        top: 0;
        left: 0;
    }

    .character-area {
        flex: 1;
        background-color: #f0f4f8;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 1px solid #ddd;
    }

    .chat-area {
        flex: 2;
        display: flex;
        flex-direction: column;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        background: linear-gradient(to bottom, #e9eff5, #d5e0f0);
        margin: 0;
        padding: 0;
        overflow: hidden;
    }

    .card-header {
        background-color: #fff;
        border-bottom: 1px solid #ddd;
        padding: 0.75rem 1.25rem;
    }

    .chat-log {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
        max-height: calc(100vh - 180px); /* ãƒ˜ãƒƒãƒ€ãƒ¼ã¨å…¥åŠ›ã‚¨ãƒªã‚¢ã®é«˜ã•ã‚’å¼•ã */
    }

    .chat-bubble {
        max-width: 70%; /* å¹…ã‚’çŸ­ãã™ã‚‹ */
        padding: 10px 14px;
        margin: 8px 0;
        border-radius: 16px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .user-message {
        background-color: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .bot-message {
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }

    .chat-footer {
        padding: 1rem;
        border-top: 1px solid #ddd;
        background-color: #f9f9f9;
        flex-shrink: 0; /* ãƒ•ãƒƒã‚¿ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’å›ºå®š */
        min-height: 80px; /* æœ€å°é«˜ã•ã‚’è¨­å®š */
    }

    .chat-input {
        border-radius: 20px;
        border: 1px solid #ccc;
    }
    .chat-input:focus {
        border-color: #409eff;
        box-shadow: 0 0 0 0.2rem rgba(64, 158, 255, 0.25);
    }

    .send-button {
        background-color: #409eff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color 0.3s;
    }

    .send-button:hover {
        background-color: #66b1ff;
    }

    .send-button:disabled {
        background-color: #a0cfff;
        cursor: not-allowed;
    }

    .message-wrapper {
        display: flex;
        margin-bottom: 0.5rem;
    }

    .message-wrapper.user {
        justify-content: flex-end;
    }

    .message-wrapper.bot {
        justify-content: flex-start;
    }

    .tts-button {
        background: none;
        border: none;
        color: #409eff;
        font-size: 0.8rem;
        cursor: pointer;
        padding: 2px 6px;
        margin-left: 8px;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .tts-button:hover {
        background-color: rgba(64, 158, 255, 0.1);
    }

    .tts-button:disabled {
        color: #ccc;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="main-layout-chat">
    <!-- å·¦å´: å·ç”°ã‚­ãƒ£ãƒ©ã‚¤ãƒ¡ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
    <div class="character-area">
        <img src="{% static 'img/kawada.png' %}" alt="å·ç”°å…ˆç”Ÿ" class="img-fluid mb-4" style="max-width: 350px; border-radius: 50%;">
        <h4 class="card-title">å·ç”°</h4>
        <p class="card-text text-muted">ãƒ™ãƒ†ãƒ©ãƒ³ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢</p>
        <hr class="my-4" style="width: 80%;">
        <div id="kawada-status" class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span id="kawada-status-text">å¾…æ©Ÿä¸­...</span>
        </div>
    </div>

    <!-- å³å´: ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ -->
    <div class="chat-area">
        <div class="chat-container">
            <div class="card-header">
                <h5 class="mb-0">ãƒãƒ£ãƒƒãƒˆãƒ«ãƒ¼ãƒ </h5>
            </div>
            <div class="chat-log" id="chat-log">
                <!-- éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
            <div class="chat-footer">
                <div class="input-group">
                    <input type="text" id="chat-message-input" class="form-control chat-input" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›...">
                    <button class="btn send-button" id="chat-message-submit">é€ä¿¡</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block react_scripts %}
{# ã“ã®ãƒšãƒ¼ã‚¸ã§ã¯Reactã¯ä½¿ç”¨ã—ãªã„ãŸã‚ã€ãƒ–ãƒ­ãƒƒã‚¯ã‚’ç©ºã«ã™ã‚‹ #}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatLog = document.getElementById('chat-log');
    const messageInput = document.getElementById('chat-message-input');
    const submitButton = document.getElementById('chat-message-submit');
    const kawadaStatusText = document.getElementById('kawada-status-text');
    const kawadaStatusSpinner = document.querySelector('#kawada-status .spinner-border');

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«TTSè¨­å®šã‚’ä½¿ç”¨
    function getTTSSettings() {
        if (typeof getGlobalTTSSettings === 'function') {
            return getGlobalTTSSettings();
        }
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®š
        return {
            autoTTS: true,
            pitch: 0.6,
            rate: 0.8
        };
    }

    // TTSé–¢é€£ã®å¤‰æ•°
    let speechSynthesis = window.speechSynthesis;
    let currentUtterance = null;
    let isPlaying = false;

    // æ—¥æœ¬èªç”·æ€§éŸ³å£°ã®è¨­å®šï¼ˆChromeå¯¾å¿œå¼·åŒ–ç‰ˆï¼‰
    function getJapaneseVoice() {
        const voices = speechSynthesis.getVoices();
        
        console.log('Browser:', navigator.userAgent);
        console.log('Total voices available:', voices.length);
        
        // Chrome/Chromiumç³»ã§ã®ç”·æ€§éŸ³å£°å€™è£œ
        const maleVoicePatterns = [
            'Google æ—¥æœ¬èª',
            'Microsoft Ichiro',
            'Microsoft Kenji', 
            'Otoya',
            'Ichiro',
            'Kenji',
            'Male',
            'ç”·æ€§',
            'Google Japanese'
        ];
        
        // 1. æ˜ç¢ºã«ç”·æ€§ã¨ã‚ã‹ã‚‹éŸ³å£°ã‚’æ¤œç´¢
        for (const pattern of maleVoicePatterns) {
            const voice = voices.find(v => 
                v.name.includes(pattern) && 
                (v.lang.includes('ja') || v.lang.includes('JP'))
            );
            if (voice) {
                console.log('Found male voice:', voice.name, voice.lang);
                return voice;
            }
        }
        
        // 2. æ—¥æœ¬èªéŸ³å£°ã®ä¸­ã‹ã‚‰é¸æŠï¼ˆChromeã®å ´åˆï¼‰
        const japaneseVoices = voices.filter(voice => 
            voice.lang.includes('ja') || 
            voice.lang.includes('JP') ||
            voice.name.includes('Japanese') ||
            voice.name.includes('æ—¥æœ¬')
        );
        
        console.log('Available Japanese voices:', japaneseVoices.map(v => `${v.name} (${v.lang})`));
        
        // 3. Googleç³»ã®éŸ³å£°ã‚’å„ªå…ˆï¼ˆé€šå¸¸ã¯ã‚ˆã‚Šè‡ªç„¶ï¼‰
        const googleVoice = japaneseVoices.find(v => v.name.includes('Google'));
        if (googleVoice) {
            console.log('Selected Google Japanese voice:', googleVoice.name);
            return googleVoice;
        }
        
        // 4. æœ€åˆã®æ—¥æœ¬èªéŸ³å£°
        if (japaneseVoices.length > 0) {
            console.log('Selected first Japanese voice:', japaneseVoices[0].name);
            return japaneseVoices[0];
        }
        
        // 5. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        console.log('Using default voice:', voices[0]?.name || 'None');
        return voices[0];
    }

    // TTSã§éŸ³å£°èª­ã¿ä¸Šã’
    function speakText(text, button) {
        if (isPlaying) {
            speechSynthesis.cancel();
            isPlaying = false;
            button.textContent = 'ğŸ”Š';
            return;
        }

        currentUtterance = new SpeechSynthesisUtterance(text);
        currentUtterance.voice = getJapaneseVoice();
        const settings = getTTSSettings();
        currentUtterance.rate = settings.rate;
        currentUtterance.pitch = settings.pitch;
        currentUtterance.volume = 1.0;

        currentUtterance.onstart = function() {
            isPlaying = true;
            button.textContent = 'â¸ï¸';
        };

        currentUtterance.onend = function() {
            isPlaying = false;
            button.textContent = 'ğŸ”Š';
        };

        currentUtterance.onerror = function(event) {
            console.error('TTS Error:', event);
            isPlaying = false;
            button.textContent = 'ğŸ”Š';
        };

        speechSynthesis.speak(currentUtterance);
    }

    async function loadChatHistory() {
        try {
            const response = await fetch("{% url 'chatlesson:chat_history' %}", {
                method: 'GET',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                const data = await response.json();
                
                // ãƒãƒ£ãƒƒãƒˆãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢
                chatLog.innerHTML = '';
                
                // éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒãªã„å ´åˆã¯ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                if (data.messages.length === 0) {
                    addMessage('ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', 'bot');
                } else {
                    // éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    data.messages.forEach(msg => {
                        addMessage(msg.message, msg.sender === 'kawada' ? 'bot' : msg.sender);
                    });
                }
            }
        } catch (error) {
            console.error('Error loading chat history:', error);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            addMessage('ä½•ã‹è³ªå•ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ', 'bot');
        }
    }

    function addMessage(message, sender, enableTTS = false) {
        const messageWrapper = document.createElement('div');
        messageWrapper.classList.add('message-wrapper', sender);

        const messageBubble = document.createElement('div');
        messageBubble.classList.add('chat-bubble');
        messageBubble.classList.add(sender === 'user' ? 'user-message' : 'bot-message');
        
        const p = document.createElement('p');
        p.classList.add('mb-0');
        p.textContent = message;
        messageBubble.appendChild(p);

        // å·ç”°ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«TTSãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
        if (sender === 'bot') {
            const ttsButton = document.createElement('button');
            ttsButton.classList.add('tts-button');
            ttsButton.textContent = 'ğŸ”Š';
            ttsButton.title = 'éŸ³å£°ã§èã';
            ttsButton.onclick = function() {
                speakText(message, ttsButton);
            };
            messageBubble.appendChild(ttsButton);

            // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å ´åˆã¯è‡ªå‹•ã§èª­ã¿ä¸Šã’
            const settings = getTTSSettings();
            if (enableTTS && settings.autoTTS && 'speechSynthesis' in window) {
                setTimeout(() => {
                    speakText(message, ttsButton);
                }, 500); // å°‘ã—é…å»¶ã•ã›ã¦è‡ªç„¶ã«
            }
        }

        messageWrapper.appendChild(messageBubble);
        chatLog.appendChild(messageWrapper);
        chatLog.scrollTop = chatLog.scrollHeight;
    }

    function setLoading(isLoading) {
        if (isLoading) {
            submitButton.disabled = true;
            submitButton.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> é€ä¿¡ä¸­...`;
            messageInput.disabled = true;
            kawadaStatusText.textContent = 'å·ç”°ã€è€ƒãˆä¸­â€¦â€¦';
            kawadaStatusSpinner.style.display = 'inline-block';
        } else {
            submitButton.disabled = false;
            submitButton.innerHTML = 'é€ä¿¡';
            messageInput.disabled = false;
            messageInput.focus();
            kawadaStatusText.textContent = 'å¾…æ©Ÿä¸­...';
            kawadaStatusSpinner.style.display = 'none';
        }
    }

    async function sendMessage() {
        const message = messageInput.value.trim();
        if (message === '') return;

        addMessage(message, 'user');
        messageInput.value = '';
        setLoading(true);

        try {
            const response = await fetch("{% url 'chatlesson:chat_api' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ message: message })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ reply: 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚' }));
                throw new Error(errorData.reply || 'Network response was not ok.');
            }

            const data = await response.json();
            addMessage(data.reply, 'bot', true); // æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯è‡ªå‹•èª­ã¿ä¸Šã’æœ‰åŠ¹

        } catch (error) {
            console.error('Error:', error);
            addMessage(error.message || 'ã™ã¾ãªã„ãŒã€å°‘ã—èª¿å­ãŒæ‚ªã„ã‚ˆã†ã ã€‚å¾Œã§ã¾ãŸè©¦ã—ã¦ãã‚Œã€‚', 'bot');
        } finally {
            setLoading(false);
        }
    }

    submitButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // åˆæœŸåŒ–
    setLoading(false);
    
    // éŸ³å£°ãƒªã‚¹ãƒˆãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ
    if ('speechSynthesis' in window) {
        speechSynthesis.onvoiceschanged = function() {
            const voices = speechSynthesis.getVoices();
            console.log('Available TTS voices:');
            voices.forEach((voice, index) => {
                console.log(`${index}: ${voice.name} (${voice.lang}) - ${voice.gender || 'Unknown gender'}`);
            });
            
            const selectedVoice = getJapaneseVoice();
            console.log('Selected voice for Kawada:', selectedVoice?.name || 'None');
        };
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    loadChatHistory();
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«éå»ã®ä¼šè©±å±¥æ­´ã‚’èª­ã¿è¾¼ã‚€
    loadChatHistory();
});
</script>

<!-- React ãƒãƒ£ãƒƒãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ -->
<div id="chat-root"></div>
<script src="{% static 'js/react/chatlesson.bundle.js' %}"></script>
{% endblock %}
