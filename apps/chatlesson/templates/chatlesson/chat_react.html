{% extends 'base.html' %}
{% load static %}

{% block title %}川田先生とのチャット - Kawada Study{% endblock %}

{% block extra_css %}
<style>
    html, body {
        font-family: "Noto Sans JP", "Helvetica Neue", Arial, sans-serif;
        overflow: hidden; /* ページ全体のスクロールを完全に禁止 */
        height: 100vh;
        margin: 0;
        padding: 0;
    }

    .main-layout-chat { 
        display: flex;
        height: 100%; /* 親要素の高さに合わせる */
        width: 100%;
        /* position: fixed と関連プロパティを削除 */
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .character-area {
        flex: 1;
        background-color: #f0f4f8;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-right: 1px solid #ddd;
        height: 100%; /* 親要素の高さに合わせる */
    }

    .chat-area {
        flex: 2;
        display: flex;
        flex-direction: column;
        height: 100%; /* 親要素の高さに合わせる */
        overflow: auto; /* コンテンツが見切れないようにスクロールを許可 */
    }

    #chat-root {
        height: 100%;
        display: flex;
        flex-direction: column;
        background: linear-gradient(to bottom, #e9eff5, #d5e0f0);
        margin: 0;
        padding: 0;
    }

    /* React用のスタイル */
    .chat-bubble {
        max-width: 85%; /* 幅を少し広げて見切れを防ぐ */
        padding: 10px 14px;
        margin: 8px 0;
        border-radius: 16px;
        position: relative;
        font-size: 0.95rem;
        line-height: 1.5;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }

    .user-message {
        background-color: #dcf8c6;
        align-self: flex-end;
        border-bottom-right-radius: 2px;
    }

    .bot-message {
        background-color: #ffffff;
        border: 1px solid #e0e0e0;
        align-self: flex-start;
        border-bottom-left-radius: 2px;
    }

    .chat-input {
        border-radius: 20px;
        border: 1px solid #ccc;
    }
    .chat-input:focus {
        border-color: #409eff;
        box-shadow: 0 0 0 0.2rem rgba(64, 158, 255, 0.25);
    }

    .send-button {
        background-color: #409eff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: background-color 0.3s;
    }

    .send-button:hover {
        background-color: #66b1ff;
    }

    .send-button:disabled {
        background-color: #a0cfff;
        cursor: not-allowed;
    }

    .typing-indicator span {
        height: 5px;
        width: 5px;
        float: left;
        margin: 0 1px;
        background-color: #9E9EA1;
        display: block;
        border-radius: 50%;
        opacity: 0.4;
        animation: typing 1.4s infinite ease-in-out both;
    }

    .typing-indicator span:nth-child(1) {
        animation-delay: -0.32s;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: -0.16s;
    }

    @keyframes typing {
        0%,
        80%,
        100% {
            transform: scale(0);
        }
        40% {
            transform: scale(1);
        }
    }

    /* キャラクター選択ドロップダウンのスタイル */
    .character-selector .btn {
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .character-selector .dropdown-menu {
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    /* メッセージエリアのスタイル調整 */
    .message-wrapper.user {
        margin-right: 1rem; /* 右側に余白を追加 */
    }

    .message-wrapper.bot {
        margin-left: 1rem; /* 左側に余白を追加 */
    }

    /* Reactが生成する不要なラッパーを非表示にする */
    #chat-root > .chat-container > .border-top.bg-light.p-3 {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="main-layout-chat">
    <!-- 左側: 川田キャライメージ表示エリア -->
    <div class="character-area">
        <img id="character-image" src="{% static 'img/kawada.png' %}" alt="川田先生" class="img-fluid mb-4" style="max-width: 350px; border-radius: 50%;">
        <h4 class="card-title" id="character-name">川田</h4>
        <p class="card-text text-muted">ベテランエンジニア</p>
        <hr class="my-4" style="width: 80%;">
        <div id="kawada-status" class="text-center">
            <div class="spinner-border spinner-border-sm text-primary" role="status" style="display: none;">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span id="kawada-status-text">待機中...</span>
        </div>
    </div>

    <!-- 右側: チャットエリア -->
    <div class="chat-area">
        <div id="chat-root">
            <!-- Reactコンポーネントがここにマウントされます -->
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">読み込み中...</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    console.log('Loading chatlesson React component...');
    // デバッグ用: DOM要素の確認
    document.addEventListener('DOMContentLoaded', function() {
        const chatRoot = document.getElementById('chat-root');
        console.log('Chat root element:', chatRoot);
        
        // React バージョン確認
        console.log('React version check:', {
            React: typeof React !== 'undefined' ? 'loaded' : 'not loaded',
            ReactDOM: typeof ReactDOM !== 'undefined' ? 'loaded' : 'not loaded',
            createRoot: typeof ReactDOM !== 'undefined' && ReactDOM.createRoot ? 'available' : 'not available'
        });
    });
</script>
<script src="{% static 'js/react/chatlesson.bundle.js' %}?v=20250801_react18"></script>
{% endblock %}
