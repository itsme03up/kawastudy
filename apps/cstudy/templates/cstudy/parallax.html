{% extends 'base.html' %}
{% load static %}

{% block title %}Cè¨€èªå­¦ç¿’ - ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ä½“é¨“{% endblock %}

{% block body_class %}cstudy-parallax-page{% endblock %}

{% block head %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.parallax-container {
    position: relative;
    height: 400vh; /* é•·ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯èƒ½é ˜åŸŸ */
    width: 100%;
}

.background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 1;
    overflow: hidden;
}

.nature-left, .nature-right, .path {
    position: absolute;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    filter: grayscale(30%) brightness(0.9);
    transform: translateZ(0);
    will-change: transform;
}

.nature-left {
    background: #5f7c33 url('{% static "img/parallax/tiles/grasstile.png" %}') repeat;
    background-size: 150px 150px;
    z-index: 1;
    animation: sway 8s ease-in-out infinite alternate;
}

.nature-right {
    background: #4a5d23 url('{% static "img/parallax/tiles/mudtile.png" %}') repeat;
    background-size: 120px 120px;
    z-index: 2;
    opacity: 0.7;
    animation: sway 10s ease-in-out infinite alternate-reverse;
}

.path {
    background-color: rgba(212, 199, 161, 0.8);
    background-image: url('{% static "img/parallax/backgrounds/path.png" %}');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    z-index: 3;
    opacity: 0.9;
}

@keyframes sway {
    0% { 
        filter: grayscale(30%) brightness(0.9);
        transform: translateX(0px) scale(1);
    }
    100% { 
        filter: grayscale(20%) brightness(1);
        transform: translateX(2px) scale(1.01);
    }
}

.character-sticky {
    position: fixed;
    top: 10%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 10;
    transition: all 0.3s ease;
}

.kawada-avatar {
    width: 64px;
    height: 64px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    background: white;
    transition: all 0.3s ease;
    object-fit: cover;
}

.content-popup {
    position: fixed;
    z-index: 15;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    max-width: 400px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
    border: 2px solid #e0e0e0;
}

.content-popup.visible {
    opacity: 1;
    transform: translateY(0);
}

.content-popup.left {
    left: 5vw;
    top: 50%;
    transform: translateY(-50%) translateX(-20px);
}

.content-popup.right {
    right: 5vw;
    top: 50%;
    transform: translateY(-50%) translateX(20px);
}

.content-popup.visible.left,
.content-popup.visible.right {
    transform: translateY(-50%) translateX(0);
}

.popup-text {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 10px;
}

.popup-code {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    white-space: pre-wrap;
    margin: 10px 0;
    border-left: 4px solid #007acc;
}

.warning-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 50;
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    max-width: 500px;
    text-align: center;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
    transition: all 0.4s ease;
}

.warning-popup.visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.warning-popup h2 {
    font-size: 24px;
    margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.warning-popup p {
    font-size: 18px;
    margin-bottom: 20px;
}

.quiz-options {
    list-style: none;
    padding: 0;
}

.quiz-option {
    background: rgba(255,255,255,0.2);
    margin: 10px 0;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    border: 2px solid transparent;
}

.quiz-option:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.5);
}

.kawada-speech {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 20;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    font-size: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
    transition: all 0.4s ease;
    max-width: 80%;
    text-align: center;
}

.kawada-speech.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.scroll-indicator {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    writing-mode: vertical-lr;
    text-orientation: mixed;
}

.special-effect {
    position: fixed;
    top: 20%;
    right: 10%;
    z-index: 15;
    opacity: 0;
    transform: scale(0.5) rotate(0deg);
    transition: all 0.6s ease;
    pointer-events: none;
}

.special-effect.visible {
    opacity: 0.7;
    transform: scale(1) rotate(360deg);
}

.special-effect img {
    width: 100px;
    height: 100px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

.progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
    z-index: 30;
    transform-origin: left;
    transform: scaleX(0);
    transition: transform 0.1s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="parallax-container">
    <div class="background-container">
        <div class="nature-left"></div>
        <div class="nature-right"></div>
        <div class="path"></div>
    </div>

    <!-- ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚’åˆ¥ã®å ´æ‰€ã«é…ç½® -->
    <div class="character-sticky">
        <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
             alt="å·ç”°å…ˆç”Ÿ" 
             class="kawada-avatar" 
             id="kawada-avatar">
    </div>

    <div class="progress-bar" id="progress-bar"></div>
    
    <div class="scroll-indicator">
        ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦å­¦ç¿’ã‚’é€²ã‚ã‚ˆã†
    </div>

    <!-- ç‰¹æ®ŠåŠ¹æœ -->
    <div class="special-effect" id="special-effect">
        <img src="{% static 'img/parallax/effects/kangor.png' %}" alt="ç‰¹æ®ŠåŠ¹æœ">
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="content-container"></div>

    <!-- Warningå•é¡Œãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
    <div id="warning-popup" class="warning-popup">
        <h2>âš  Warning!</h2>
        <p id="quiz-question"></p>
        <ul id="quiz-options" class="quiz-options"></ul>
    </div>

    <!-- å·ç”°ã®ã‚»ãƒªãƒ•è¡¨ç¤º -->
    <div id="kawada-speech" class="kawada-speech"></div>
</div>

<script>
// å­¦ç¿’ãƒ‡ãƒ¼ã‚¿ã¨ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹å¤‰æ•°
let parallaxLessonData = [];
let parallaxQuizData = [];
let currentQuizIndex = 0;
let completedQuizzes = new Set();

// APIå‘¼ã³å‡ºã—é–¢æ•°
async function fetchLessonData() {
    if (parallaxLessonData.length > 0) {
        console.log('Lesson data already loaded, skipping...');
        return;
    }
    
    try {
        const response = await fetch('/cstudy/api/lessons/');
        if (response.ok) {
            parallaxLessonData = await response.json();
            console.log('Lesson data loaded:', parallaxLessonData.length, 'sections');
        }
    } catch (error) {
        console.error('Failed to fetch lesson data:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
        parallaxLessonData = [
            {
                id: 1, position: 300, side: 'left', type: 'text',
                content: 'Cè¨€èªã¸ã‚ˆã†ã“ãï¼å·ç”°ã¨ä¸€ç·’ã«å­¦ã‚“ã§ã„ãã¾ã—ã‚‡ã†ğŸŒŸ',
                kawada_emotion: 'cheerful'
            },
            {
                id: 2, position: 700, side: 'right', type: 'code',
                content: '#include <stdio.h>\n\nint main() {\n    printf("Hello, World!");\n    return 0;\n}',
                kawada_emotion: 'default'
            },
            {
                id: 3, position: 1200, side: 'left', type: 'text',
                content: 'printfé–¢æ•°ã‚’ä½¿ã£ã¦æ–‡å­—ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚å·ç”°ã€ã“ã‚Œã¨ã¦ã‚‚å¤§äº‹ãªã‚“ã§ã™ï¼',
                kawada_emotion: 'thinking'
            }
        ];
    }
}

async function fetchQuizData() {
    if (parallaxQuizData.length > 0) {
        console.log('Quiz data already loaded, skipping...');
        return;
    }
    
    try {
        const response = await fetch('/cstudy/api/quizzes/');
        if (response.ok) {
            parallaxQuizData = await response.json();
            console.log('Quiz data loaded:', parallaxQuizData.length, 'quizzes');
        }
    } catch (error) {
        console.error('Failed to fetch quiz data:', error);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿
        parallaxQuizData = [
            {
                id: 1,
                question: 'ã‚»ãƒŸã‚³ãƒ­ãƒ³ãŒå¿…è¦ãªã®ã¯ã©ã‚Œï¼Ÿ',
                options: ['int a = 10', 'int b = 20;', 'printf("Hello")'],
                correct_answer: 1,
                explanation: 'Cè¨€èªã§ã¯æ–‡ã®çµ‚ã‚ã‚Šã«ã‚»ãƒŸã‚³ãƒ­ãƒ³ãŒå¿…è¦ã§ã™',
                kawada_correct_message: 'å·ç”°ã€æ­£è§£ã§ã™ï¼',
                kawada_wrong_message: 'å·ç”°ã€ã‚‚ã†ä¸€åº¦è€ƒãˆã¦ã¿ã¾ã—ã‚‡ã†',
                trigger_position: 900
            }
        ];
    }
}

// å·ç”°ã®ã‚¢ãƒã‚¿ãƒ¼å¤‰æ›´
function changeKawadaEmotion(emotion) {
    const avatar = document.getElementById('kawada-avatar');
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å·ç”°samã®ç”»åƒã€ä»–ã®æ„Ÿæƒ…ã¯æ—¢å­˜ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨
    if (emotion === 'default') {
        avatar.src = '/static/img/parallax/characters/kawada-sam.png';
    } else {
        avatar.src = `/static/img/kawada-${emotion}.png`;
    }
}

// å·ç”°ã®ã‚»ãƒªãƒ•è¡¨ç¤º
function showKawadaSpeech(message, duration = 3000) {
    const speech = document.getElementById('kawada-speech');
    speech.textContent = message;
    speech.classList.add('visible');
    
    setTimeout(() => {
        speech.classList.remove('visible');
    }, duration);
}

// ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º
function showContentPopup(section) {
    const container = document.getElementById('content-container');
    
    const popup = document.createElement('div');
    popup.className = `content-popup ${section.side}`;
    popup.id = `popup-${section.id}`;
    
    let content = '';
    if (section.type === 'code') {
        content = `<div class="popup-code">${section.content}</div>`;
    } else {
        content = `<div class="popup-text">${section.content}</div>`;
    }
    
    popup.innerHTML = content;
    container.appendChild(popup);
    
    // å·ç”°ã®æ„Ÿæƒ…å¤‰æ›´
    changeKawadaEmotion(section.kawada_emotion);
    
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¡¨ç¤º
    setTimeout(() => {
        popup.classList.add('visible');
    }, 100);
    
    // è‡ªå‹•éè¡¨ç¤º
    setTimeout(() => {
        popup.classList.remove('visible');
        setTimeout(() => {
            if (popup.parentNode) {
                popup.parentNode.removeChild(popup);
            }
        }, 400);
    }, 4000);
}

// Warningå•é¡Œè¡¨ç¤º
function showWarningQuiz(quiz) {
    const warningPopup = document.getElementById('warning-popup');
    const questionEl = document.getElementById('quiz-question');
    const optionsEl = document.getElementById('quiz-options');
    
    questionEl.textContent = quiz.question;
    optionsEl.innerHTML = '';
    
    quiz.options.forEach((option, index) => {
        const li = document.createElement('li');
        li.className = 'quiz-option';
        li.textContent = `${index + 1}. ${option}`;
        li.onclick = () => handleQuizAnswer(quiz.id, index, quiz);
        optionsEl.appendChild(li);
    });
    
    warningPopup.classList.add('visible');
}

// ã‚¯ã‚¤ã‚ºå›ç­”å‡¦ç†
async function handleQuizAnswer(quizId, selectedAnswer, quiz) {
    const warningPopup = document.getElementById('warning-popup');
    warningPopup.classList.remove('visible');
    
    const isCorrect = selectedAnswer === quiz.correct_answer;
    const message = isCorrect ? quiz.kawada_correct_message : quiz.kawada_wrong_message;
    
    if (isCorrect) {
        changeKawadaEmotion('cheerful');
        completedQuizzes.add(quizId);
    } else {
        changeKawadaEmotion('gentle');
    }
    
    showKawadaSpeech(message, 4000);
    
    // è§£èª¬è¡¨ç¤º
    setTimeout(() => {
        showKawadaSpeech(quiz.explanation, 4000);
    }, 4500);
}

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†
function handleScroll() {
    const scrollY = window.scrollY;
    const maxScroll = document.body.scrollHeight - window.innerHeight;
    const progress = Math.min(scrollY / maxScroll, 1);
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (scrollY % 200 === 0) {
        console.log('Scroll position:', scrollY, 'Progress:', progress);
    }
    
    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.transform = `scaleX(${progress})`;
    
    // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœ - èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ç•°ãªã‚‹é€Ÿåº¦ã§å‹•ã‹ã™
    const leftNature = document.querySelector('.nature-left');
    const rightNature = document.querySelector('.nature-right');
    const pathLayer = document.querySelector('.path');
    
    leftNature.style.transform = `translateY(${scrollY * 0.2}px)`;
    rightNature.style.transform = `translateY(${scrollY * 0.4}px)`;
    pathLayer.style.transform = `translateY(${scrollY * 0.6}px)`;
    
    // ç‰¹æ®ŠåŠ¹æœã®è¡¨ç¤ºåˆ¶å¾¡
    const specialEffect = document.getElementById('special-effect');
    if (progress > 0.7) { // 70%ä»¥ä¸Šã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãŸã‚‰è¡¨ç¤º
        specialEffect.classList.add('visible');
    } else {
        specialEffect.classList.remove('visible');
    }
    
    // ãƒ¬ãƒƒã‚¹ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤º
    parallaxLessonData.forEach(section => {
        if (scrollY >= section.position && scrollY < section.position + 100) {
            const existingPopup = document.getElementById(`popup-${section.id}`);
            if (!existingPopup) {
                console.log('Showing popup for section:', section.id, 'at position:', scrollY);
                showContentPopup(section);
            }
        }
    });
    
    // Warningå•é¡Œè¡¨ç¤º
    parallaxQuizData.forEach(quiz => {
        if (scrollY >= quiz.trigger_position && 
            scrollY < quiz.trigger_position + 100 && 
            !completedQuizzes.has(quiz.id)) {
            console.log('Showing quiz:', quiz.id, 'at position:', scrollY);
            showWarningQuiz(quiz);
        }
    });
}

// åˆæœŸåŒ–
async function initializeParallaxLearning() {
    console.log('Initializing parallax learning...');
    await fetchLessonData();
    await fetchQuizData();
    
    console.log('Lesson data loaded:', parallaxLessonData.length, 'sections');
    console.log('Quiz data loaded:', parallaxQuizData.length, 'quizzes');
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆ
    window.addEventListener('scroll', handleScroll);
    
    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    setTimeout(() => {
        showKawadaSpeech('Cè¨€èªã®å†’é™ºãŒå§‹ã¾ã‚Šã¾ã™ï¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦é€²ã‚“ã§ãã ã•ã„ğŸš€', 4000);
    }, 1000);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', initializeParallaxLearning);
</script>
{% endblock %}
