{% extends 'base.html' %}
{% load static %}

{% block title %}CË®ÄË™ûÂ≠¶Áøí - „Éë„É©„É©„ÉÉ„ÇØ„Çπ‰ΩìÈ®ì{% endblock %}

{% block head %}
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.parallax-container {
    position: relative;
    height: 400vh; /* Èï∑„ÅÑ„Çπ„ÇØ„É≠„Éº„É´ÂèØËÉΩÈ†òÂüü */
    width: 100%;
}

.background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    display: flex;
    z-index: 1;
}

.nature-left, .nature-right {
    width: 30vw;
    height: 100vh;
    background-image: 
        linear-gradient(45deg, #4a5d23 25%, transparent 25%),
        linear-gradient(-45deg, #4a5d23 25%, transparent 25%),
        linear-gradient(45deg, transparent 75%, #4a5d23 75%),
        linear-gradient(-45deg, transparent 75%, #4a5d23 75%);
    background-size: 20px 20px;
    background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
    background-color: #5f7c33;
    filter: grayscale(60%) brightness(0.8);
    transform: translateZ(0);
}

.nature-left {
    background-image: 
        radial-gradient(circle at 30% 40%, #3d4a1f 20%, transparent 21%),
        radial-gradient(circle at 70% 80%, #3d4a1f 15%, transparent 16%),
        linear-gradient(180deg, #4a5d23 0%, #5f7c33 100%);
}

.nature-right {
    background-image: 
        radial-gradient(circle at 60% 30%, #3d4a1f 18%, transparent 19%),
        radial-gradient(circle at 20% 70%, #3d4a1f 22%, transparent 23%),
        linear-gradient(180deg, #4a5d23 0%, #5f7c33 100%);
}

.path {
    width: 40vw;
    height: 100vh;
    background: linear-gradient(180deg, #d4c7a1 0%, #c2b595 50%, #b5a888 100%);
    background-image: 
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,0.1) 2px, rgba(0,0,0,0.1) 4px),
        repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(0,0,0,0.05) 3px, rgba(0,0,0,0.05) 6px);
    position: relative;
    z-index: 2;
}

.character-sticky {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10;
    transition: all 0.3s ease;
}

.kawada-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    background: white;
    transition: all 0.3s ease;
}

.content-popup {
    position: fixed;
    z-index: 5;
    background: rgba(255, 255, 255, 0.95);
    border-radius: 15px;
    padding: 20px;
    max-width: 400px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.4s ease;
    border: 2px solid #e0e0e0;
}

.content-popup.visible {
    opacity: 1;
    transform: translateY(0);
}

.content-popup.left {
    left: 5vw;
    top: 50%;
    transform: translateY(-50%) translateX(-20px);
}

.content-popup.right {
    right: 5vw;
    top: 50%;
    transform: translateY(-50%) translateX(20px);
}

.content-popup.visible.left,
.content-popup.visible.right {
    transform: translateY(-50%) translateX(0);
}

.popup-text {
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    margin-bottom: 10px;
}

.popup-code {
    background: #1e1e1e;
    color: #d4d4d4;
    padding: 15px;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    white-space: pre-wrap;
    margin: 10px 0;
    border-left: 4px solid #007acc;
}

.warning-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 100;
    background: linear-gradient(135deg, #ff6b6b, #ee5a24);
    color: white;
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.3);
    max-width: 500px;
    text-align: center;
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.8);
    transition: all 0.4s ease;
}

.warning-popup.visible {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
}

.warning-popup h2 {
    font-size: 24px;
    margin-bottom: 15px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.warning-popup p {
    font-size: 18px;
    margin-bottom: 20px;
}

.quiz-options {
    list-style: none;
    padding: 0;
}

.quiz-option {
    background: rgba(255,255,255,0.2);
    margin: 10px 0;
    padding: 12px 20px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 16px;
    border: 2px solid transparent;
}

.quiz-option:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    border-color: rgba(255,255,255,0.5);
}

.kawada-speech {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 15;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 15px 25px;
    border-radius: 25px;
    font-size: 16px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
    transition: all 0.4s ease;
    max-width: 80%;
    text-align: center;
}

.kawada-speech.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.scroll-indicator {
    position: fixed;
    right: 20px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 20;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    writing-mode: vertical-lr;
    text-orientation: mixed;
}

.progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
    z-index: 30;
    transform-origin: left;
    transform: scaleX(0);
    transition: transform 0.1s ease;
}
</style>
{% endblock %}

{% block content %}
<div class="parallax-container">
    <div class="background-container">
        <div class="nature-left"></div>
        <div class="path">
            <div class="character-sticky">
                <img src="{% static 'img/kawada-default.png' %}" 
                     alt="Â∑ùÁî∞ÂÖàÁîü" 
                     class="kawada-avatar" 
                     id="kawada-avatar">
            </div>
        </div>
        <div class="nature-right"></div>
    </div>

    <div class="progress-bar" id="progress-bar"></div>
    
    <div class="scroll-indicator">
        „Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶Â≠¶Áøí„ÇíÈÄ≤„ÇÅ„Çà„ÅÜ
    </div>

    <!-- „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÅÆ„Ç≥„É≥„ÉÜ„Éä -->
    <div id="content-container"></div>

    <!-- WarningÂïèÈ°å„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó -->
    <div id="warning-popup" class="warning-popup">
        <h2>‚ö† Warning!</h2>
        <p id="quiz-question"></p>
        <ul id="quiz-options" class="quiz-options"></ul>
    </div>

    <!-- Â∑ùÁî∞„ÅÆ„Çª„É™„ÉïË°®Á§∫ -->
    <div id="kawada-speech" class="kawada-speech"></div>
</div>

<script>
// Â≠¶Áøí„Éá„Éº„Çø„Å®„ÇØ„Ç§„Ç∫„Éá„Éº„Çø„ÇíÊ†ºÁ¥ç„Åô„ÇãÂ§âÊï∞
let lessonData = [];
let quizData = [];
let currentQuizIndex = 0;
let completedQuizzes = new Set();

// APIÂëº„Å≥Âá∫„ÅóÈñ¢Êï∞
async function fetchLessonData() {
    try {
        const response = await fetch('/cstudy/api/lessons/');
        if (response.ok) {
            lessonData = await response.json();
            console.log('Lesson data loaded:', lessonData.length, 'sections');
        }
    } catch (error) {
        console.error('Failed to fetch lesson data:', error);
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éá„Éº„Çø
        lessonData = [
            {
                id: 1, position: 300, side: 'left', type: 'text',
                content: 'CË®ÄË™û„Å∏„Çà„ÅÜ„Åì„ÅùÔºÅÂ∑ùÁî∞„Å®‰∏ÄÁ∑í„Å´Â≠¶„Çì„Åß„ÅÑ„Åç„Åæ„Åó„Çá„ÅÜüåü',
                kawada_emotion: 'cheerful'
            },
            {
                id: 2, position: 700, side: 'right', type: 'code',
                content: '#include <stdio.h>\n\nint main() {\n    printf("Hello, World!");\n    return 0;\n}',
                kawada_emotion: 'default'
            },
            {
                id: 3, position: 1200, side: 'left', type: 'text',
                content: 'printfÈñ¢Êï∞„Çí‰Ωø„Å£„Å¶ÊñáÂ≠ó„ÇíË°®Á§∫„Åó„Åæ„Åô„ÄÇÂ∑ùÁî∞„ÄÅ„Åì„Çå„Å®„Å¶„ÇÇÂ§ß‰∫ã„Å™„Çì„Åß„ÅôÔºÅ',
                kawada_emotion: 'thinking'
            }
        ];
    }
}

async function fetchQuizData() {
    try {
        const response = await fetch('/cstudy/api/quizzes/');
        if (response.ok) {
            quizData = await response.json();
            console.log('Quiz data loaded:', quizData.length, 'quizzes');
        }
    } catch (error) {
        console.error('Failed to fetch quiz data:', error);
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Éá„Éº„Çø
        quizData = [
            {
                id: 1,
                question: '„Çª„Éü„Ç≥„É≠„É≥„ÅåÂøÖË¶Å„Å™„ÅÆ„ÅØ„Å©„ÇåÔºü',
                options: ['int a = 10', 'int b = 20;', 'printf("Hello")'],
                correct_answer: 1,
                explanation: 'CË®ÄË™û„Åß„ÅØÊñá„ÅÆÁµÇ„Çè„Çä„Å´„Çª„Éü„Ç≥„É≠„É≥„ÅåÂøÖË¶Å„Åß„Åô',
                kawada_correct_message: 'Â∑ùÁî∞„ÄÅÊ≠£Ëß£„Åß„ÅôÔºÅ',
                kawada_wrong_message: 'Â∑ùÁî∞„ÄÅ„ÇÇ„ÅÜ‰∏ÄÂ∫¶ËÄÉ„Åà„Å¶„Åø„Åæ„Åó„Çá„ÅÜ',
                trigger_position: 900
            }
        ];
    }
}

// Â∑ùÁî∞„ÅÆ„Ç¢„Éê„Çø„ÉºÂ§âÊõ¥
function changeKawadaEmotion(emotion) {
    const avatar = document.getElementById('kawada-avatar');
    avatar.src = `/static/img/kawada-${emotion}.png`;
}

// Â∑ùÁî∞„ÅÆ„Çª„É™„ÉïË°®Á§∫
function showKawadaSpeech(message, duration = 3000) {
    const speech = document.getElementById('kawada-speech');
    speech.textContent = message;
    speech.classList.add('visible');
    
    setTimeout(() => {
        speech.classList.remove('visible');
    }, duration);
}

// „Ç≥„É≥„ÉÜ„É≥„ÉÑ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„ÉóË°®Á§∫
function showContentPopup(section) {
    const container = document.getElementById('content-container');
    
    const popup = document.createElement('div');
    popup.className = `content-popup ${section.side}`;
    popup.id = `popup-${section.id}`;
    
    let content = '';
    if (section.type === 'code') {
        content = `<div class="popup-code">${section.content}</div>`;
    } else {
        content = `<div class="popup-text">${section.content}</div>`;
    }
    
    popup.innerHTML = content;
    container.appendChild(popup);
    
    // Â∑ùÁî∞„ÅÆÊÑüÊÉÖÂ§âÊõ¥
    changeKawadaEmotion(section.kawada_emotion);
    
    // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫
    setTimeout(() => {
        popup.classList.add('visible');
    }, 100);
    
    // Ëá™ÂãïÈùûË°®Á§∫
    setTimeout(() => {
        popup.classList.remove('visible');
        setTimeout(() => {
            if (popup.parentNode) {
                popup.parentNode.removeChild(popup);
            }
        }, 400);
    }, 4000);
}

// WarningÂïèÈ°åË°®Á§∫
function showWarningQuiz(quiz) {
    const warningPopup = document.getElementById('warning-popup');
    const questionEl = document.getElementById('quiz-question');
    const optionsEl = document.getElementById('quiz-options');
    
    questionEl.textContent = quiz.question;
    optionsEl.innerHTML = '';
    
    quiz.options.forEach((option, index) => {
        const li = document.createElement('li');
        li.className = 'quiz-option';
        li.textContent = `${index + 1}. ${option}`;
        li.onclick = () => handleQuizAnswer(quiz.id, index, quiz);
        optionsEl.appendChild(li);
    });
    
    warningPopup.classList.add('visible');
}

// „ÇØ„Ç§„Ç∫ÂõûÁ≠îÂá¶ÁêÜ
async function handleQuizAnswer(quizId, selectedAnswer, quiz) {
    const warningPopup = document.getElementById('warning-popup');
    warningPopup.classList.remove('visible');
    
    const isCorrect = selectedAnswer === quiz.correct_answer;
    const message = isCorrect ? quiz.kawada_correct_message : quiz.kawada_wrong_message;
    
    if (isCorrect) {
        changeKawadaEmotion('cheerful');
        completedQuizzes.add(quizId);
    } else {
        changeKawadaEmotion('gentle');
    }
    
    showKawadaSpeech(message, 4000);
    
    // Ëß£Ë™¨Ë°®Á§∫
    setTimeout(() => {
        showKawadaSpeech(quiz.explanation, 4000);
    }, 4500);
}

// „Çπ„ÇØ„É≠„Éº„É´Âá¶ÁêÜ
function handleScroll() {
    const scrollY = window.scrollY;
    const maxScroll = document.body.scrollHeight - window.innerHeight;
    const progress = Math.min(scrollY / maxScroll, 1);
    
    // „Éó„É≠„Ç∞„É¨„Çπ„Éê„ÉºÊõ¥Êñ∞
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.transform = `scaleX(${progress})`;
    
    // „Éë„É©„É©„ÉÉ„ÇØ„ÇπÂäπÊûú
    const leftNature = document.querySelector('.nature-left');
    const rightNature = document.querySelector('.nature-right');
    leftNature.style.transform = `translateY(${scrollY * 0.5}px)`;
    rightNature.style.transform = `translateY(${scrollY * 0.3}px)`;
    
    // „É¨„ÉÉ„Çπ„É≥„Çª„ÇØ„Ç∑„Éß„É≥Ë°®Á§∫
    lessonData.forEach(section => {
        if (scrollY >= section.position && scrollY < section.position + 100) {
            const existingPopup = document.getElementById(`popup-${section.id}`);
            if (!existingPopup) {
                showContentPopup(section);
            }
        }
    });
    
    // WarningÂïèÈ°åË°®Á§∫
    quizData.forEach(quiz => {
        if (scrollY >= quiz.trigger_position && 
            scrollY < quiz.trigger_position + 100 && 
            !completedQuizzes.has(quiz.id)) {
            showWarningQuiz(quiz);
        }
    });
}

// ÂàùÊúüÂåñ
async function initializeParallaxLearning() {
    await fetchLessonData();
    await fetchQuizData();
    
    // „Çπ„ÇØ„É≠„Éº„É´„Ç§„Éô„É≥„Éà
    window.addEventListener('scroll', handleScroll);
    
    // ÂàùÊúü„É°„ÉÉ„Çª„Éº„Ç∏
    setTimeout(() => {
        showKawadaSpeech('CË®ÄË™û„ÅÆÂÜíÈô∫„ÅåÂßã„Åæ„Çä„Åæ„ÅôÔºÅ„Çπ„ÇØ„É≠„Éº„É´„Åó„Å¶ÈÄ≤„Çì„Åß„Åè„Å†„Åï„ÅÑüöÄ', 4000);
    }, 1000);
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„Å´ÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', initializeParallaxLearning);
</script>
{% endblock %}
