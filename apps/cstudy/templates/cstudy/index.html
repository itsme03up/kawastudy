{% extends 'base.html' %}
{% load static %}

{% block title %}Cè¨€èªå…¥é–€ - å·ç”°ã¨æ­©ã{% endblock %}

{% block body_class %}cstudy-page{% endblock %}

{% block extra_css %}
<style>
/* Cè¨€èªå­¦ç¿’ãƒšãƒ¼ã‚¸å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.cstudy-page {
    background: #000000 !important;
    padding-top: 40px !important; /* çŸ­ç¸®ã•ã‚ŒãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®é«˜ã•ã‚’ç¢ºä¿ */
    padding-bottom: 0 !important;
}

/* Cè¨€èªå­¦ç¿’ãƒšãƒ¼ã‚¸å°‚ç”¨ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®é«˜ã•èª¿æ•´ */
.cstudy-page .navbar {
    height: 40px !important;
    min-height: 40px !important;
}

.cstudy-page .navbar .container-fluid {
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
}

.cstudy-page .navbar-brand,
.cstudy-page .nav-link {
    font-size: 0.9rem !important;
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’å®Œå…¨ã«å‰Šé™¤ */
.cstudy-page .navbar,
.cstudy-page .navbar *,
.cstudy-page .dropdown-menu,
.cstudy-page .nav-link,
.cstudy-page .btn {
    border-radius: 0 !important;
}

/* Cè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ ã®å®Œå…¨ç‹¬ç«‹ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
.cstudy-fullscreen-overlay {
    position: fixed;
    top: 40px; /* çŸ­ç¸®ã•ã‚ŒãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®ä¸‹ã‹ã‚‰é–‹å§‹ */
    left: 0;
    width: 100vw;
    height: calc(100vh - 40px); /* çŸ­ç¸®ã•ã‚ŒãŸãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®é«˜ã•ã‚’å¼•ã */
    z-index: 1000;
    background: #000000;
}

/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    height: 100vh;
    background: #000000;
}

/* é™çš„ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.static-mode {
    display: block;
    position: relative;
    width: 100%;
    min-height: 100vh;
}

/* Lottieã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - èƒŒæ™¯å·¦ã€œä¸­å¤® */
.lottie-animation {
    position: fixed;
    top: 60px; /* å°‘ã—ä¸‹ã«ä¸‹ã’ã‚‹ */
    left: 0;
    width: 50vw;
    height: 90vh;
    z-index: 2;
}

/* å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ - å³å´ã‚³ãƒ³ãƒ†ãƒŠå³ä¸‹ã«é…ç½® */
.kawada-character {
    position: fixed;
    bottom: 90px;
    right: 60px;
    z-index: 100;
    cursor: pointer;
    transition: all 0.3s ease;
}

.kawada-character:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4));
}

.kawada-character img {
    width: 120px;
    height: 120px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    transition: all 0.3s ease;
}

/* ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
.star {
    position: absolute;
    display: block;
    width: 15px; /* ã‚­ãƒ©ã‚­ãƒ©ã®æ¨ªå¹… */
    height: 15px; /* ã‚­ãƒ©ã‚­ãƒ©ã®ç¸¦å¹… */
    background-image: url("{% static 'img/star.svg' %}"); /* ã‚­ãƒ©ã‚­ãƒ©ã®ç”»åƒ */
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center center;
    animation: glitter 1s ease-out;
    pointer-events: none;
    z-index: 150; /* å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚ˆã‚Šä¸Šã«è¡¨ç¤º */
}

/* ã‚­ãƒ©ã‚­ãƒ©ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes glitter {
    0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
    }
    
    50% {
        transform: scale(1) rotate(180deg);
        opacity: 1;
    }
    
    100% {
        transform: scale(0) rotate(360deg);
        opacity: 0;
    }
}

/* å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes kawada-click {
    0% {
        transform: scale(1);
    }
    
    50% {
        transform: scale(0.95);
    }
    
    100% {
        transform: scale(1.05);
    }
}

.kawada-character.clicked {
    animation: kawada-click 0.3s ease-out;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.lesson-sections {
    position: fixed;
    right: 30px; /* å·¦ã«20pxä¼¸ã°ã™ï¼ˆå³ãƒãƒ¼ã‚¸ãƒ³ã‚’æ¸›ã‚‰ã™ï¼‰ */
    top: 60%;
    transform: translateY(-50%);
    z-index: 10;
    width: 800px; /* å¹…ã‚’50pxæ‹¡å¤§ */
    height: 500px; /* é«˜ã•ã‚’50pxæ‹¡å¤§ */
    display: flex;
    align-items: center;
    justify-content: center;
}

.lesson-section {
    display: none;
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    transform: translateY(50px);
    transition: all 0.6s ease;
}

.lesson-section.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transform: translateY(0);
    animation: slideInUp 0.6s ease forwards;
}

.lesson-content {
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 20px;
    text-align: left;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.lesson-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.lesson-content h2 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    color: #333;
    line-height: 1.4;
    text-align: left;
}

.lesson-content div {
    font-size: 1rem;
    line-height: 1.6;
    color: #555;
    flex: 1;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    text-align: left;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.navigation {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 20px;
    align-items: center;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 15px 25px;
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.2);
}

.nav-button {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.nav-button:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.progress-info {
    color: white;
    font-size: 1rem;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    min-width: 80px;
    text-align: center;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* Cè¨€èªå­¦ç¿’ãƒšãƒ¼ã‚¸å°‚ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆå·¦å¯„ã›ã‚¹ã‚¿ã‚¤ãƒ« */
.cstudy-page .box27,
.cstudy-page .lesson-content {
    text-align: left !important;
}

.cstudy-page .box27 p,
.cstudy-page .lesson-content div,
.cstudy-page .box27 div {
    text-align: left !important;
    align-items: flex-start !important;
    justify-content: flex-start !important;
}

/* ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.cstudy-page pre,
.cstudy-page code,
.cstudy-page .box27 pre {
    text-align: left !important;
    white-space: pre-wrap !important;
    font-family: 'Courier New', monospace, 'Source Code Pro', 'Consolas' !important;
    background-color: #f8f8f8 !important;
    padding: 1rem !important;
    border-radius: 4px !important;
    overflow-x: auto !important;
    width: 100% !important;
    border-left: 3px solid #62c1ce !important;
    font-size: 0.9rem !important;
    line-height: 1.4 !important;
    color: #333 !important;
    margin: 0.5rem 0 !important;
    box-sizing: border-box !important;
}

/* ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
.code-container {
    background: transparent !important;
    border: none !important;
    padding: 20px !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
}

.code-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1.5rem;
    padding: 1.8rem 2.5rem;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    border-left: 4px solid #62c1ce;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.code-icon {
    margin-right: 0.5rem;
}

.code-block {
    background: #f8f8f8 !important;
    border: 1px solid #ddd !important;
    border-left: 4px solid #62c1ce !important;
    padding: 2.5rem 3rem !important;
    margin: 1.5rem 0 !important;
    border-radius: 6px !important;
    font-family: 'Courier New', monospace !important;
    font-size: 0.9rem !important;
    line-height: 1.5 !important;
    color: #333 !important;
    white-space: pre-wrap !important;
    overflow-x: auto !important;
    width: 100% !important;
    box-sizing: border-box !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.code-explanation {
    background: rgba(255,255,255,0.95);
    padding: 2.2rem 2.8rem;
    border-radius: 8px;
    border-left: 4px solid #764ba2;
    margin-top: 1.5rem;
    font-size: 1rem;
    line-height: 1.7;
    color: #555;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .lesson-sections {
        right: 50%;
        transform: translate(50%, -50%);
        width: calc(100vw - 20px); /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚ˆã‚Šå¹…ã‚’åºƒã */
        max-width: 800px; /* æœ€å¤§å¹…ã‚’å°‘ã—æ‹¡å¤§ */
        height: 600px; /* é«˜ã•ã‚‚å°‘ã—æ‹¡å¤§ */
    }
    
    .lesson-content {
        padding: 30px 20px;
    }
    
    .lesson-content h2 {
        font-size: 1.5rem;
    }
    
    .lesson-content div {
        font-size: 0.9rem;
    }
    
    .kawada-character {
        bottom: 60px;
        right: 20px;
    }
    
    .kawada-character img {
        width: 80px;
        height: 80px;
    }
    
    .lottie-animation {
        width: 70vw;
        height: 100vh;
    }
    
    .navigation {
        bottom: 10px;
        padding: 12px 20px;
        gap: 15px;
    }
    
    .nav-button {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
    
    .progress-info {
        min-width: 60px;
        font-size: 0.9rem;
    }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
.loading {
    text-align: center;
    color: white;
    font-size: 1.2rem;
}

.loading::after {
    content: '';
    display: inline-block;
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>
{% endblock %}

{% block content %}
<div class="cstudy-fullscreen-overlay">
    <div class="cstudy-main-layout">
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <header class="cstudy-header">
            <h1>Cè¨€èª</h1>
            <p>å·ç”°ã¨ä¸€ç·’ã«å­¦ã¶ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
        <main class="cstudy-main-content">
            
        </main>
    </div>

    <!-- Lottieã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - èƒŒæ™¯å·¦ã€œä¸­å¤® -->
    <div class="lottie-animation">
        <dotlottie-wc 
            src="https://lottie.host/79ee2210-feb0-49c3-97a0-3e684c775999/cj6QHe24lp.lottie" 
            style="width: 100%; height: 100%;" 
            speed="1" 
            autoplay 
            loop>
        </dotlottie-wc>
    </div>

    <div class="kawada-character" id="kawada-char">
        <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
             width="200" 
             height="200" 
             alt="å·ç”°" 
             id="kawada-img">
    </div>

<!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå³å´å›ºå®šï¼‰ -->
<div class="lesson-sections" id="lesson-container">
    <!-- é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->

    <section class="lesson-section right">
        <div class="box27">
            <span class="box-title">ğŸ“š åŸºæœ¬æ¦‚å¿µ</span>
            <p>Cè¨€èªã¯1972å¹´ã«é–‹ç™ºã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚</p>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>ğŸ’» Hello World</h2>
            <div>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ã‚‡ã†ï¼</div>
        </div>
    </section>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="navigation">
    <button class="nav-button" id="prev-btn" disabled>
        â¬…ï¸ å‰ã¸
    </button>
    
    <div class="progress-info" id="progress-info">
        1 / 3
    </div>
    
    <!-- Nextãƒœã‚¿ãƒ³ã¯å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã§ä»£æ›¿ -->
    <div class="next-hint" style="color: white; font-size: 0.9rem; opacity: 0.7;">
        å·ç”°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¬¡ã¸ â¡ï¸
    </div>
</nav>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
<script>
// ã‚¯ãƒªãƒƒã‚¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œCè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
class ClickNavigationCStudy {
    constructor() {
        this.sections = [];
        this.currentIndex = 0;
        this.isLoading = false;
        
        this.init();
    }
    
    async init() {
        console.log("ClickNavigationCStudyåˆæœŸåŒ–é–‹å§‹");
        
        // DOMè¦ç´ ã‚’å–å¾—
        this.lessonContainer = document.getElementById('lesson-container');
        this.prevBtn = document.getElementById('prev-btn');
        this.kawadaChar = document.getElementById('kawada-char');
        this.progressInfo = document.getElementById('progress-info');
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        this.prevBtn.addEventListener('click', () => this.previousSection());
        this.kawadaChar.addEventListener('click', () => {
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            this.kawadaChar.classList.add('clicked');
            setTimeout(() => {
                this.kawadaChar.classList.remove('clicked');
            }, 300);
            
            // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            this.createGlitterEffect();
            
            // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¸
            setTimeout(() => {
                this.nextSection();
            }, 150);
        });
        
        // åˆæœŸã®é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        this.sections = Array.from(this.lessonContainer.querySelectorAll('.lesson-section'));
        this.updateNavigation();
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
        setTimeout(() => {
            this.loadDynamicSections();
        }, 1000);
    }
    
    async loadDynamicSections() {
        if (this.isLoading) return;
        this.isLoading = true;
        
        try {
            console.log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹...");
            
            const response = await fetch('/cstudy/api/lessons/', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            console.log("API Response status:", response.status);
            
            if (response.ok) {
                const apiSections = await response.json();
                console.log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰${apiSections.length}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—`);
                
                try {
                    this.replaceSectionsWithDynamic(apiSections);
                    console.log("å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç½®ãæ›ãˆãŒå®Œäº†ã—ã¾ã—ãŸ");
                } catch (replaceError) {
                    console.error("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç½®ãæ›ãˆã§ã‚¨ãƒ©ãƒ¼:", replaceError);
                    console.log("é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ã¾ã™");
                }
            } else {
                console.error("APIå¿œç­”ã‚¨ãƒ©ãƒ¼:", response.status, response.statusText);
                console.log("é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒ");
            }
        } catch (error) {
            console.error("APIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            console.log("ã‚¨ãƒ©ãƒ¼ã®ãŸã‚é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ã¾ã™");
        }
        
        this.isLoading = false;
    }
    
    replaceSectionsWithDynamic(apiSections) {
        console.log("å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç½®ãæ›ãˆé–‹å§‹");
        
        // æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        this.lessonContainer.innerHTML = '';
        this.sections = [];
        
        // ã‚³ãƒ¼ãƒ‰ã¨ãã®å¾Œã®è§£èª¬ã‚’ãƒšã‚¢ã«ã—ã¦å‡¦ç†
        this.processedSections = [];
        
        for (let i = 0; i < apiSections.length; i++) {
            const section = apiSections[i];
            
            // ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆã€æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè§£èª¬ãªã‚‰çµ„ã¿åˆã‚ã›ã‚‹
            if (section.type === 'code' && i + 1 < apiSections.length && apiSections[i + 1].type === 'explanation') {
                const nextSection = apiSections[i + 1];
                const combinedSection = this.createCombinedCodeSection(section, nextSection, i);
                this.lessonContainer.appendChild(combinedSection);
                this.sections.push(combinedSection);
                i++; // æ¬¡ã®è§£èª¬ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒƒãƒ—
            } else {
                // é€šå¸¸ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†
                const sectionElement = this.createSectionElement(section, i);
                this.lessonContainer.appendChild(sectionElement);
                this.sections.push(sectionElement);
            }
        }
        
        // æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        this.currentIndex = 0;
        this.showSection(0);
        
        console.log(`${this.sections.length}å€‹ã®å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç½®ãæ›ãˆã¾ã—ãŸ`);
    }
    
    createCombinedCodeSection(codeSection, explanationSection, index) {
        console.log(`çµ„ã¿åˆã‚ã›ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1}ä½œæˆé–‹å§‹:`, codeSection, explanationSection);
        
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right code-section`; // ã‚³ãƒ¼ãƒ‰å°‚ç”¨ã‚¯ãƒ©ã‚¹è¿½åŠ 
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'code-container'; // é€æ˜èƒŒæ™¯ç”¨ã®ã‚¯ãƒ©ã‚¹
        
        // ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«éƒ¨åˆ†
        const codeLines = (codeSection.content || '').split('\n');
        const codeTitle = codeLines[0] || 'Cè¨€èªå­¦ç¿’';
        const codeBody = codeLines.slice(1).join('\n') || codeSection.content || '';
        
        // ã‚³ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«
        const titleElement = document.createElement('div');
        titleElement.className = 'code-title';
        titleElement.innerHTML = `<span class="code-icon">ğŸ’»</span> ${codeTitle}`;
        
        // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯
        const codeElement = document.createElement('pre');
        codeElement.className = 'code-block';
        codeElement.textContent = codeBody;
        
        // è§£èª¬éƒ¨åˆ†
        const explanationElement = document.createElement('div');
        explanationElement.className = 'code-explanation';
        explanationElement.innerHTML = explanationSection.content.replace(/\n/g, '<br>');
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(codeElement);
        contentDiv.appendChild(explanationElement);
        sectionDiv.appendChild(contentDiv);
        
        console.log(`çµ„ã¿åˆã‚ã›ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1}ä½œæˆå®Œäº†`);
        return sectionDiv;
    }
    
    createSectionElement(section, index) {
        console.log(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1}ä½œæˆé–‹å§‹:`, section); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right`; // å…¨ã¦å³å´ã«çµ±ä¸€
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'box27';
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³
        const icons = {
            'text': 'ğŸ“š',
            'code': 'ğŸ’»', 
            'explanation': 'ğŸ’¡',
            'warning': 'âš ï¸'
        };
        const icon = icons[section.type] || 'ğŸ“–';
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æœ€åˆã®è¡Œã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æŠ½å‡º
        const lines = (section.content || '').split('\n');
        const title = lines[0] || 'Cè¨€èªå­¦ç¿’';
        const body = lines.slice(1).join('\n') || section.content || '';
        
        console.log(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1} - ã‚¿ã‚¤ãƒ—: ${section.type}, ã‚¿ã‚¤ãƒˆãƒ«: ${title}`); // ãƒ‡ãƒãƒƒã‚°ç”¨
        
        // HTMLè¦ç´ ã‚’ä½œæˆ
        const titleElement = document.createElement('span');
        titleElement.className = 'box-title';
        titleElement.textContent = `${icon} ${title}`;
        
        // ã‚³ãƒ¼ãƒ‰å‹ã®å ´åˆã¯preã‚¿ã‚°ã‚’ä½¿ç”¨ã€ãã®ä»–ã¯pã‚¿ã‚°
        const bodyElement = section.type === 'code' ? 
            document.createElement('pre') : 
            document.createElement('p');
        
        if (section.type === 'code') {
            console.log('ã‚³ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³å‡¦ç†:', section.type, body); // ãƒ‡ãƒãƒƒã‚°ç”¨
            bodyElement.textContent = body; // ã‚³ãƒ¼ãƒ‰ã¯ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã—ã¦è¡¨ç¤º
            bodyElement.style.textAlign = 'left';
            bodyElement.style.whiteSpace = 'pre-wrap';
            bodyElement.style.fontFamily = 'Courier New, monospace';
            bodyElement.style.backgroundColor = '#f8f8f8';
            bodyElement.style.padding = '1rem';
            bodyElement.style.borderRadius = '4px';
            bodyElement.style.borderLeft = '3px solid #62c1ce';
            bodyElement.style.fontSize = '0.9rem';
            bodyElement.style.lineHeight = '1.4';
            bodyElement.style.overflow = 'auto';
            bodyElement.style.display = 'block';
            bodyElement.style.width = '100%';
            console.log('ä½œæˆã•ã‚ŒãŸpreã‚¿ã‚°:', bodyElement); // ãƒ‡ãƒãƒƒã‚°ç”¨
        } else {
            bodyElement.innerHTML = body.replace(/\n/g, '<br>'); // èª¬æ˜æ–‡ã¯æ”¹è¡Œã‚’brã‚¿ã‚°ã«
        }
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(bodyElement);
        sectionDiv.appendChild(contentDiv);
        
        console.log(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1}ä½œæˆå®Œäº†`); // ãƒ‡ãƒãƒƒã‚°ç”¨
        return sectionDiv;
    }
    
    showSection(index) {
        if (index < 0 || index >= this.sections.length) return;
        
        // å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        this.sections.forEach((section, i) => {
            section.classList.remove('active');
        });
        
        // æŒ‡å®šã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        setTimeout(() => {
            this.sections[index].classList.add('active');
        }, 100);
        
        this.currentIndex = index;
        this.updateNavigation();
        
        // å·ç”°ã®è¡¨æƒ…ã‚’å¤‰æ›´ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«kawada_emotionãŒã‚ã‚Œã°ï¼‰
        if (this.sections[index].dataset && this.sections[index].dataset.emotion) {
            this.updateKawadaEmotion(this.sections[index].dataset.emotion);
        }
        
        console.log(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ${index + 1} ã‚’è¡¨ç¤º`);
    }
    
    updateNavigation() {
        // å‰ã¸ãƒœã‚¿ãƒ³
        this.prevBtn.disabled = this.currentIndex === 0;
        
        // å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çŠ¶æ…‹ç®¡ç†ï¼ˆæœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ã¯é€æ˜åº¦ã‚’ä¸‹ã’ã‚‹ï¼‰
        if (this.currentIndex === this.sections.length - 1) {
            this.kawadaChar.style.opacity = '0.5';
            this.kawadaChar.style.cursor = 'not-allowed';
        } else {
            this.kawadaChar.style.opacity = '1';
            this.kawadaChar.style.cursor = 'pointer';
        }
        
        // é€²æ—è¡¨ç¤º
        this.progressInfo.textContent = `${this.currentIndex + 1} / ${this.sections.length}`;
    }
    
    updateKawadaEmotion(emotion) {
        const kawadaImg = document.getElementById('kawada-img');
        if (kawadaImg && emotion) {
            // å·ç”°ã®è¡¨æƒ…ç”»åƒã‚’å¤‰æ›´
            const emotionMap = {
                'cheerful': 'kawada-cheerful.png',
                'thinking': 'kawada-thinking.png',
                'smile': 'kawada-smile.png',
                'gentle': 'kawada-gentle.png',
                'default': 'kawada-sam.png'
            };
            
            const imageName = emotionMap[emotion] || emotionMap['default'];
            kawadaImg.src = `/static/img/${imageName}`;
        }
    }
    
    previousSection() {
        if (this.currentIndex > 0) {
            this.showSection(this.currentIndex - 1);
        }
    }
    
    nextSection() {
        if (this.currentIndex < this.sections.length - 1) {
            this.showSection(this.currentIndex + 1);
        }
    }
    
    // ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°
    createGlitterEffect() {
        const kawadaRect = this.kawadaChar.getBoundingClientRect();
        const starCount = 8; // ä¸€åº¦ã«ç”Ÿæˆã™ã‚‹æ˜Ÿã®æ•°
        
        for (let i = 0; i < starCount; i++) {
            setTimeout(() => {
                const starEl = document.createElement('span');
                starEl.className = 'star';
                
                // å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç¯„å›²å†…ã§ãƒ©ãƒ³ãƒ€ãƒ ãªä½ç½®ã«é…ç½®
                const randomX = Math.random() * kawadaRect.width;
                const randomY = Math.random() * kawadaRect.height;
                
                starEl.style.left = randomX + 'px';
                starEl.style.top = randomY + 'px';
                
                this.kawadaChar.appendChild(starEl);
                
                // 1ç§’å¾Œã«ã‚­ãƒ©ã‚­ãƒ©ã‚’å‰Šé™¤
                setTimeout(() => {
                    if (starEl.parentNode) {
                        starEl.remove();
                    }
                }, 1000);
            }, i * 100); // 100msãšã¤æ™‚å·®ã‚’ã¤ã‘ã¦ç”Ÿæˆ
        }
    }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded - ã‚¯ãƒªãƒƒã‚¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹");
    window.cStudyApp = new ClickNavigationCStudy();
});
</script>
{% endblock %}
