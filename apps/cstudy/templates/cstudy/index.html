{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cè¨€èªå…¥é–€ - å·ç”°ã¨æ­©ã</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    <style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    height: 100vh;
    background: #f8f9fa;
}

/* é™çš„ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.static-mode {
    display: block;
    position: relative;
    width: 100%;
    min-height: 100vh;
}

/* Lottieã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - èƒŒæ™¯å·¦ã€œä¸­å¤® */
.lottie-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 50vw;
    height: 90vh;
    z-index: 2;
}

/* å·ç”°ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ */
.kawada-character {
    position: fixed;
    bottom: 30%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
}

.kawada-character img {
    width: 150px;
    height: 150px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
.lesson-sections {
    position: fixed;
    right: 50px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 450px;
    height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lesson-section {
    display: none;
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    transform: translateY(50px);
    transition: all 0.6s ease;
}

.lesson-section.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transform: translateY(0);
    animation: slideInUp 0.6s ease forwards;
}

.lesson-content {
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.lesson-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.lesson-content h2 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    color: #333;
    line-height: 1.4;
}

.lesson-content div {
    font-size: 1rem;
    line-height: 1.6;
    color: #555;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

/* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
.navigation {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 20px;
    align-items: center;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 15px 25px;
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.2);
}

.nav-button {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.nav-button:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.progress-info {
    color: white;
    font-size: 1rem;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    min-width: 80px;
    text-align: center;
}

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .lesson-sections {
        right: 50%;
        transform: translate(50%, -50%);
        width: calc(100vw - 40px);
        max-width: 400px;
        height: 450px;
    }
    
    .lesson-content {
        padding: 30px 20px;
    }
    
    .lesson-content h2 {
        font-size: 1.5rem;
    }
    
    .lesson-content div {
        font-size: 0.9rem;
    }
    
    .kawada-character {
        width: 80px;
        height: 80px;
        bottom: 20%;
        left: 30%;
    }
    
    .kawada-character img {
        width: 80px;
        height: 80px;
    }
    
    .lottie-animation {
        width: 70vw;
        height: 100vh;
    }
    
    .navigation {
        bottom: 10px;
        padding: 12px 20px;
        gap: 15px;
    }
    
    .nav-button {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
    
    .progress-info {
        min-width: 60px;
        font-size: 0.9rem;
    }
}

/* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º */
.loading {
    text-align: center;
    color: white;
    font-size: 1.2rem;
}

.loading::after {
    content: '';
    display: inline-block;
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>
</head>
<body>

<div class="cstudy-main-layout">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="cstudy-header">
        <h1>ğŸŒŸ Cè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ </h1>
        <p>å·ç”°ã¨ä¸€ç·’ã«å­¦ã¶ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºç¤</p>
    </header>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <main class="cstudy-main-content">
        <div class="cstudy-content-center">
            <h2>ğŸš€ å­¦ç¿’ã‚’å§‹ã‚ã‚ˆã†</h2>
            <p>å³å´ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§å·ç”°ã¨ä¸€ç·’ã«Cè¨€èªã®åŸºç¤ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚<br>
            å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸‹ã‹ã‚‰ä¸ŠãŒã£ã¦ãã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
            <button class="cstudy-start-button" onclick="window.cStudyApp?.showSection(0)">
                å­¦ç¿’é–‹å§‹
            </button>
        </div>
    </main>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer class="cstudy-footer">
        <p>&copy; 2025 Cè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ  - Powered by å·ç”°</p>
    </footer>
</div>

<!-- Lottieã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ - èƒŒæ™¯å·¦ã€œä¸­å¤® -->
<div class="lottie-animation">
    <dotlottie-wc 
        src="https://lottie.host/6b9d8450-0591-4ba1-8c98-5e992969107b/oRwPEwm3hJ.lottie" 
        style="width: 100%; height: 100%;" 
        speed="1" 
        autoplay 
        loop>
    </dotlottie-wc>
</div>

<div class="kawada-character" id="kawada-char">
    <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
         width="150" 
         height="150" 
         alt="å·ç”°" 
         id="kawada-img">
</div>

<!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆå³å´å›ºå®šï¼‰ -->
<div class="lesson-sections" id="lesson-container">
    <!-- é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ  -->
    <section class="lesson-section right active">
        <div class="lesson-content">
            <h2>ğŸŒŸ Cè¨€èªã®ä¸–ç•Œã¸ã‚ˆã†ã“ã</h2>
            <div>å·ç”°ã¨ä¸€ç·’ã«å­¦ç¿’ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼</div>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>ğŸ“š åŸºæœ¬æ¦‚å¿µ</h2>
            <div>Cè¨€èªã¯1972å¹´ã«é–‹ç™ºã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚</div>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>ğŸ’» Hello World</h2>
            <div>ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ã‚‡ã†ï¼</div>
        </div>
    </section>
</div>

<!-- ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav class="navigation">
    <button class="nav-button" id="prev-btn" disabled>
        â¬…ï¸ å‰ã¸
    </button>
    
    <div class="progress-info" id="progress-info">
        1 / 3
    </div>
    
    <button class="nav-button" id="next-btn">
        æ¬¡ã¸ â¡ï¸
    </button>
</nav>

<script>
// ã‚¯ãƒªãƒƒã‚¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å¯¾å¿œCè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
class ClickNavigationCStudy {
    constructor() {
        this.sections = [];
        this.currentIndex = 0;
        this.isLoading = false;
        
        this.init();
    }
    
    async init() {
        console.log("ClickNavigationCStudyåˆæœŸåŒ–é–‹å§‹");
        
        // DOMè¦ç´ ã‚’å–å¾—
        this.lessonContainer = document.getElementById('lesson-container');
        this.prevBtn = document.getElementById('prev-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.progressInfo = document.getElementById('progress-info');
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        this.prevBtn.addEventListener('click', () => this.previousSection());
        this.nextBtn.addEventListener('click', () => this.nextSection());
        
        // åˆæœŸã®é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—
        this.sections = Array.from(this.lessonContainer.querySelectorAll('.lesson-section'));
        this.updateNavigation();
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
        setTimeout(() => {
            this.loadDynamicSections();
        }, 1000);
    }
    
    async loadDynamicSections() {
        if (this.isLoading) return;
        this.isLoading = true;
        
        try {
            console.log("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿é–‹å§‹...");
            
            const response = await fetch('/cstudy/api/lessons/', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            console.log("API Response status:", response.status);
            
            if (response.ok) {
                const apiSections = await response.json();
                console.log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰${apiSections.length}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—`);
                
                try {
                    this.replaceSectionsWithDynamic(apiSections);
                    console.log("å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ç½®ãæ›ãˆãŒå®Œäº†ã—ã¾ã—ãŸ");
                } catch (replaceError) {
                    console.error("ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç½®ãæ›ãˆã§ã‚¨ãƒ©ãƒ¼:", replaceError);
                    console.log("é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ã¾ã™");
                }
            } else {
                console.error("APIå¿œç­”ã‚¨ãƒ©ãƒ¼:", response.status, response.statusText);
                console.log("é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒ");
            }
        } catch (error) {
            console.error("APIèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            console.log("ã‚¨ãƒ©ãƒ¼ã®ãŸã‚é™çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¶­æŒã—ã¾ã™");
        }
        
        this.isLoading = false;
    }
    
    replaceSectionsWithDynamic(apiSections) {
        console.log("å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç½®ãæ›ãˆé–‹å§‹");
        
        // æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
        this.lessonContainer.innerHTML = '';
        this.sections = [];
        
        // å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        apiSections.forEach((section, index) => {
            try {
                const sectionElement = this.createSectionElement(section, index);
                this.lessonContainer.appendChild(sectionElement);
                this.sections.push(sectionElement);
            } catch (createError) {
                console.error(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³${index + 1}ã®ä½œæˆã§ã‚¨ãƒ©ãƒ¼:`, createError);
            }
        });
        
        // æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        this.currentIndex = 0;
        this.showSection(0);
        
        console.log(`${apiSections.length}å€‹ã®å‹•çš„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ç½®ãæ›ãˆã¾ã—ãŸ`);
    }
    
    createSectionElement(section, index) {
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right`; // å…¨ã¦å³å´ã«çµ±ä¸€
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'lesson-content';
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³
        const icons = {
            'text': 'ğŸ“š',
            'code': 'ğŸ’»', 
            'explanation': 'ğŸ’¡',
            'warning': 'âš ï¸'
        };
        const icon = icons[section.type] || 'ğŸ“–';
        
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æœ€åˆã®è¡Œã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æŠ½å‡º
        const lines = (section.content || '').split('\n');
        const title = lines[0] || 'Cè¨€èªå­¦ç¿’';
        const body = lines.slice(1).join('<br>') || section.content || '';
        
        // HTMLè¦ç´ ã‚’ä½œæˆ
        const titleElement = document.createElement('h2');
        titleElement.textContent = `${icon} ${title}`;
        
        const bodyElement = document.createElement('div');
        bodyElement.innerHTML = body;
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(bodyElement);
        sectionDiv.appendChild(contentDiv);
        
        return sectionDiv;
    }
    
    showSection(index) {
        if (index < 0 || index >= this.sections.length) return;
        
        // å…¨ã¦ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        this.sections.forEach((section, i) => {
            section.classList.remove('active');
        });
        
        // æŒ‡å®šã•ã‚ŒãŸã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        setTimeout(() => {
            this.sections[index].classList.add('active');
        }, 100);
        
        this.currentIndex = index;
        this.updateNavigation();
        
        // å·ç”°ã®è¡¨æƒ…ã‚’å¤‰æ›´ï¼ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«kawada_emotionãŒã‚ã‚Œã°ï¼‰
        if (this.sections[index].dataset && this.sections[index].dataset.emotion) {
            this.updateKawadaEmotion(this.sections[index].dataset.emotion);
        }
        
        console.log(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ${index + 1} ã‚’è¡¨ç¤º`);
    }
    
    updateNavigation() {
        // å‰ã¸ãƒœã‚¿ãƒ³
        this.prevBtn.disabled = this.currentIndex === 0;
        
        // æ¬¡ã¸ãƒœã‚¿ãƒ³
        this.nextBtn.disabled = this.currentIndex === this.sections.length - 1;
        
        // é€²æ—è¡¨ç¤º
        this.progressInfo.textContent = `${this.currentIndex + 1} / ${this.sections.length}`;
    }
    
    updateKawadaEmotion(emotion) {
        const kawadaImg = document.getElementById('kawada-img');
        if (kawadaImg && emotion) {
            // å·ç”°ã®è¡¨æƒ…ç”»åƒã‚’å¤‰æ›´
            const emotionMap = {
                'cheerful': 'kawada-cheerful.png',
                'thinking': 'kawada-thinking.png',
                'smile': 'kawada-smile.png',
                'gentle': 'kawada-gentle.png',
                'default': 'kawada-sam.png'
            };
            
            const imageName = emotionMap[emotion] || emotionMap['default'];
            kawadaImg.src = `/static/img/${imageName}`;
        }
    }
    
    previousSection() {
        if (this.currentIndex > 0) {
            this.showSection(this.currentIndex - 1);
        }
    }
    
    nextSection() {
        if (this.currentIndex < this.sections.length - 1) {
            this.showSection(this.currentIndex + 1);
        }
    }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded - ã‚¯ãƒªãƒƒã‚¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ é–‹å§‹");
    window.cStudyApp = new ClickNavigationCStudy();
});
</script>

</body>
</html>
