{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cè¨€èªå…¥é–€ - ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹å­¦ç¿’</title>
    <style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;  /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æ˜ç¤ºçš„ã«æœ‰åŠ¹åŒ– */
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    height: auto;  /* heightã‚’100%ã‹ã‚‰autoã«å¤‰æ›´ */
}

/* ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.parallax-mode {
    display: block;
    position: relative;
    height: 1200vh;  /* éå¸¸ã«é•·ã„ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è·é›¢ */
    width: 100%;
    scroll-behavior: smooth;
    min-height: 10000px;  /* ã‚ˆã‚Šå¤§ããªæœ€å°é«˜ã• */
}

.background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: 0;
    overflow: visible;
}

.path {
    position: fixed;
    top: -100vh;  /* ä¸Šã«ä½™è£•ã‚’æŒãŸã›ã¦ */
    left: 0;
    width: 100vw;
    height: 1000vh;  /* éå¸¸ã«å¤§ããªé«˜ã•ã§ç„¡é™æ„Ÿã‚’æ¼”å‡º */
    background-image: url('{% static "img/parallax/backgrounds/path.png" %}');
    background-color: #4a5d23;
    background-size: 100% 50vh;  /* ã‚ˆã‚Šå°ã•ãªã‚µã‚¤ã‚ºã§é »ç¹ã«ç¹°ã‚Šè¿”ã— */
    background-position: center 0;
    background-repeat: repeat-y;  /* ç¸¦æ–¹å‘ã«ç„¡é™ç¹°ã‚Šè¿”ã— */
    z-index: 1;
    will-change: transform;
}

.clouds {
    position: fixed;
    top: -100vh;  /* ä¸Šã«ä½™è£•ã‚’æŒãŸã›ã¦ */
    left: 0;
    width: 100vw;
    height: 800vh;  /* å¤§ããªé«˜ã•ã§ç„¡é™æ„Ÿã‚’æ¼”å‡º */
    background-image: url('{% static "img/parallax/backgrounds/clouds.png" %}');
    background-size: 100% 40vh;  /* é›²ã‚‚å°ã•ãªã‚µã‚¤ã‚ºã§é »ç¹ã«ç¹°ã‚Šè¿”ã— */
    background-position: center 0;
    background-repeat: repeat-y;  /* ç¸¦æ–¹å‘ã«ç„¡é™ç¹°ã‚Šè¿”ã— */
    z-index: 2;
    opacity: 0.7;
    will-change: transform;
}

.kawada-character {
    position: fixed;
    bottom: 20%;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 300px;
    z-index: 3;
    transition: all 0.5s ease;
    overflow: hidden;
    border-radius: 10px;
}

.kawada-character img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    display: block;
}

/* ãƒ¬ãƒƒã‚¹ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ä¸€ç•ªä¸Š */
.lesson-sections {
    position: relative;
    z-index: 4;
}

/* å·¦å³äº¤äº’é…ç½®ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.lesson-section {
    min-height: 100vh;
    display: flex;
    align-items: center;
    padding: 0 5%;
}

.lesson-section.left {
    justify-content: flex-start;
}

.lesson-section.right {
    justify-content: flex-end;
}

.lesson-content {
    background: rgba(255,255,255,0.9);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    max-width: 500px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .kawada-character {
        width: 100px;
        height: 100px;
        bottom: 25%;
    }
    
    .lesson-section.left,
    .lesson-section.right {
        justify-content: center;
        padding: 0 10px;
    }
    
    .lesson-content {
        max-width: 90%;
        padding: 30px 20px;
    }
}
</style>
</head>
<body>

<!-- ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ -->
<div id="parallax-mode" class="parallax-mode">
    <div class="background-container">
        <div class="path" id="path-bg"></div>
        <div class="clouds" id="clouds-bg"></div>
        
        <div class="kawada-character" id="kawada-char">
            <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
                 width="150" 
                 height="150" 
                 alt="å·ç”°" 
                 id="kawada-img">
        </div>
    </div>

    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="lesson-sections" style="position: relative; z-index: 10;" id="lesson-container">
        <!-- å‹•çš„ã«èª­ã¿è¾¼ã¾ã‚Œã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        
        <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¢ºä¿ç”¨ã®ãƒ€ãƒŸãƒ¼ã‚¨ãƒªã‚¢ -->
        <div style="height: 500vh; background: transparent;" id="scroll-spacer"></div>
    </div>
</div>

<script>
// çµ±åˆã•ã‚ŒãŸCè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
class UnifiedCStudy {
    constructor() {
        this.currentMode = 'parallax';
        this.currentLesson = null;
        this.lessonData = [];
        this.quizData = [];
        this.progress = 0;
        
        this.init();
    }
    
    async init() {
        await this.loadLessonSections(); // ãƒ¬ãƒƒã‚¹ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
        this.initParallax(); // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ã‚’è‡ªå‹•ã§åˆæœŸåŒ–
    }
    
    async loadLessonSections() {
        try {
            console.log("ãƒ¬ãƒƒã‚¹ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ä¸­...");
            const response = await fetch('/cstudy/api/lessons/');
            const sections = await response.json();
            
            console.log(`${sections.length}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
            this.renderSections(sections);
        } catch (error) {
            console.error("ãƒ¬ãƒƒã‚¹ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            this.renderDefaultSections();
        }
    }
    
    renderSections(sections) {
        const container = document.getElementById('lesson-container');
        const scrollSpacer = document.getElementById('scroll-spacer');
        
        // æ—¢å­˜ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆspacerã¯æ®‹ã™ï¼‰
        const existingSections = container.querySelectorAll('.lesson-section');
        existingSections.forEach(section => section.remove());
        
        sections.forEach((section, index) => {
            const sectionElement = this.createSectionElement(section, index);
            container.insertBefore(sectionElement, scrollSpacer);
        });
        
        console.log(`${sections.length}å€‹ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
    }
    
    createSectionElement(section, index) {
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section ${section.side}`;
        sectionDiv.setAttribute('data-section-id', section.id);
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'lesson-content';
        
        // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’é¸æŠ
        const icons = {
            'text': 'ğŸ“š',
            'code': 'ğŸ’»', 
            'explanation': 'ğŸ’¡',
            'warning': 'âš ï¸'
        };
        const icon = icons[section.type] || 'ğŸ“–';
        
        contentDiv.innerHTML = `
            <h2>${icon} ${this.extractTitle(section.content)}</h2>
            <div>${this.formatContent(section.content)}</div>
        `;
        
        sectionDiv.appendChild(contentDiv);
        return sectionDiv;
    }
    
    extractTitle(content) {
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æœ€åˆã®è¡Œã‚’ã‚¿ã‚¤ãƒˆãƒ«ã¨ã—ã¦æŠ½å‡º
        const lines = content.split('\n');
        return lines[0] || 'Cè¨€èªå­¦ç¿’';
    }
    
    formatContent(content) {
        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®2è¡Œç›®ä»¥é™ã‚’æœ¬æ–‡ã¨ã—ã¦æ•´å½¢
        const lines = content.split('\n');
        const bodyLines = lines.slice(1);
        return bodyLines.join('<br>') || content;
    }
    
    renderDefaultSections() {
        // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
        const defaultSections = [
            { id: 1, side: 'right', type: 'text', content: 'Cè¨€èªã®ä¸–ç•Œã¸ã‚ˆã†ã“ã\nã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ãªãŒã‚‰å·ç”°ã¨ä¸€ç·’ã«å­¦ç¿’ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼' },
            { id: 2, side: 'left', type: 'explanation', content: 'åŸºæœ¬æ¦‚å¿µ\nCè¨€èªã¯1972å¹´ã«é–‹ç™ºã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚' },
            { id: 3, side: 'right', type: 'code', content: 'Hello World\nãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ç¬¬ä¸€æ­©ã‚’è¸ã¿å‡ºã—ã¾ã—ã‚‡ã†ï¼' }
        ];
        this.renderSections(defaultSections);
    }
    
    initParallax() {
        // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        let ticking = false;
        
        const handleScroll = () => {
            if (!ticking) {
                requestAnimationFrame(() => {
                    const scrollY = window.scrollY;
                    console.log("ScrollY:", scrollY); // ãƒ‡ãƒãƒƒã‚°ç”¨
                    
                    const pathBg = document.getElementById('path-bg');
                    const cloudsBg = document.getElementById('clouds-bg');
                    const kawadaChar = document.getElementById('kawada-char');
                    
                    // è¦ç´ ã®å­˜åœ¨ç¢ºèª
                    console.log("è¦ç´ ç¢ºèª:", {
                        pathBg: pathBg ? "å­˜åœ¨" : "æœªç™ºè¦‹",
                        cloudsBg: cloudsBg ? "å­˜åœ¨" : "æœªç™ºè¦‹", 
                        kawadaChar: kawadaChar ? "å­˜åœ¨" : "æœªç™ºè¦‹"
                    });
                    
                    // èƒŒæ™¯ã®ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœ - ç„¡é™ã«ä¸Šå‘ãã«æµã‚Œã‚‹ã‚ˆã†ã«
                    if (pathBg) {
                        const pathSpeed = scrollY * -2.0;  // é“ã‚’ä¸Šå‘ãã«æµã‚Œã‚‹ã‚ˆã†ã«
                        // èƒŒæ™¯ã‚’ãƒ«ãƒ¼ãƒ—ã•ã›ã‚‹ãŸã‚ã€50vhã§ãƒªã‚»ãƒƒãƒˆ
                        const loopedPathSpeed = pathSpeed % (window.innerHeight * 0.5);
                        pathBg.style.transform = `translateY(${loopedPathSpeed}px)`;
                        console.log(`é“ã®å‹•ã - PathSpeed: ${pathSpeed}px, Looped: ${loopedPathSpeed}px`);
                    } else {
                        console.warn("pathBgè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    }
                    if (cloudsBg) {
                        const cloudSpeed = scrollY * -0.5;  // é›²ã‚‚ä¸Šå‘ãã«æµã‚Œã‚‹ã‚ˆã†ã«
                        // é›²ã‚‚40vhã§ãƒ«ãƒ¼ãƒ—
                        const loopedCloudSpeed = cloudSpeed % (window.innerHeight * 0.4);
                        cloudsBg.style.transform = `translateY(${loopedCloudSpeed}px)`;
                    } else {
                        console.warn("cloudsBgè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    }
                    
                    // å·ç”°ãŒé“ã‚’æ­©ã„ã¦ã„ã‚‹ã‚ˆã†ãªåŠ¹æœ
                    if (kawadaChar) {
                        const sway   = Math.sin(scrollY * 0.1) * 12;   // å·¦å³ã«æºã‚Œã‚‹ï¼ˆå¼·åŒ–ï¼‰
                        const bob    = Math.abs(Math.sin(scrollY * 0.2)) * 8; // ä¸Šä¸‹ã«ãƒã‚¦ãƒ³ã‚¹ï¼ˆå¼·åŒ–ï¼‰
                        const rotate = Math.sin(scrollY * 0.05) * 5;   // ã»ã‚“ã®ã‚Šå›è»¢ï¼ˆå¼·åŒ–ï¼‰
                        
                        // ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°ï¼ˆå‹•ãã®å€¤ã‚’ç¢ºèªï¼‰
                        console.log(`å·ç”°ã®å‹•ã - Sway: ${sway.toFixed(1)}, Bob: ${bob.toFixed(1)}, Rotate: ${rotate.toFixed(1)}`);
                        
                        kawadaChar.style.transform =
                            `translateX(calc(-50% + ${sway}px)) ` +    // X=ä¸­å¤®Â±sway
                            `translateY(${bob}px) ` +                  // Y=0â†’bob
                            `rotate(${rotate}deg)`;                    // è§’åº¦=Â±rotate
                    } else {
                        console.warn("kawadaCharè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
                    }
                    
                    ticking = false;
                });
                ticking = true;
            }
        };
        
        window.addEventListener('scroll', handleScroll, { passive: true });
        document.addEventListener('scroll', handleScroll, { passive: true }); // è¿½åŠ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        
        console.log("ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šã—ã¾ã—ãŸ");
        
        // åˆæœŸè¡¨ç¤ºæ™‚ã«å°‘ã—ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦å‹•ä½œã‚’åˆ†ã‹ã‚Šã‚„ã™ã
        setTimeout(() => {
            console.log("åˆæœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™");
            
            // ãƒšãƒ¼ã‚¸ã®é«˜ã•ã¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æƒ…å ±ã‚’ç¢ºèª
            console.log("ãƒšãƒ¼ã‚¸æƒ…å ±:", {
                documentHeight: document.documentElement.scrollHeight,
                windowHeight: window.innerHeight,
                scrollTop: window.scrollY,
                bodyHeight: document.body.scrollHeight
            });
            
            window.scrollTo({ top: 50 }); // ã‚ˆã‚Šå¤§ããªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å€¤ã«
            
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾Œã®å€¤ã‚’ç¢ºèª
            setTimeout(() => {
                console.log("ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾Œã®ScrollY:", window.scrollY);
                handleScroll();
            }, 100);
        }, 100);
        
        // ã•ã‚‰ã«1ç§’å¾Œã«è¿½åŠ ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
            console.log("è¿½åŠ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™");
            window.scrollTo({ top: 100 });
            setTimeout(() => {
                console.log("è¿½åŠ ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¾Œã®ScrollY:", window.scrollY);
                handleScroll();
            }, 100);
        }, 1000);
    }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded - ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†");
    
    // è¦ç´ ã®å­˜åœ¨ã‚’ç¢ºèª
    const pathBg = document.getElementById('path-bg');
    const cloudsBg = document.getElementById('clouds-bg');
    const kawadaChar = document.getElementById('kawada-char');
    
    console.log("åˆæœŸåŒ–æ™‚ã®è¦ç´ ç¢ºèª:", {
        pathBg: pathBg ? "å­˜åœ¨" : "æœªç™ºè¦‹",
        cloudsBg: cloudsBg ? "å­˜åœ¨" : "æœªç™ºè¦‹", 
        kawadaChar: kawadaChar ? "å­˜åœ¨" : "æœªç™ºè¦‹"
    });
    
    if (pathBg && cloudsBg && kawadaChar) {
        console.log("ã™ã¹ã¦ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚UnifiedCStudyã‚’é–‹å§‹ã—ã¾ã™ã€‚");
        new UnifiedCStudy();
    } else {
        console.error("ä¸€éƒ¨ã®è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        // ãã‚Œã§ã‚‚åˆæœŸåŒ–ã‚’è©¦è¡Œ
        setTimeout(() => {
            console.log("1ç§’å¾Œã«å†è©¦è¡Œ...");
            new UnifiedCStudy();
        }, 1000);
    }
});
</script>
</body>
</html>
