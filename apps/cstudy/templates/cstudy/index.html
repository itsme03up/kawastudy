{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C言語入門 - 川田と歩く</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
    <style>
/* 基本スタイル */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    height: 100vh;
    background: #f8f9fa;
}

/* 静的モードスタイル */
.static-mode {
    display: block;
    position: relative;
    width: 100%;
    min-height: 100vh;
}

/* Lottieアニメーション - 背景左〜中央 */
.lottie-animation {
    position: fixed;
    top: 0;
    left: 0;
    width: 50vw;
    height: 90vh;
    z-index: 2;
}

/* 川田キャラクター */
.kawada-character {
    position: fixed;
    bottom: 30%;
    left: 50%;
    transform: translateX(-50%);
    z-index: 50;
}

.kawada-character img {
    width: 150px;
    height: 150px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}

/* セクション */
.lesson-sections {
    position: fixed;
    right: 50px;
    top: 50%;
    transform: translateY(-50%);
    z-index: 10;
    width: 450px;
    height: 500px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.lesson-section {
    display: none;
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    transform: translateY(50px);
    transition: all 0.6s ease;
}

.lesson-section.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transform: translateY(0);
    animation: slideInUp 0.6s ease forwards;
}

.lesson-content {
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 20px;
    text-align: center;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.lesson-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.lesson-content h2 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    color: #333;
    line-height: 1.4;
}

.lesson-content div {
    font-size: 1rem;
    line-height: 1.6;
    color: #555;
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

/* ナビゲーション */
.navigation {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 20px;
    align-items: center;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 15px 25px;
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.2);
}

.nav-button {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.nav-button:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.progress-info {
    color: white;
    font-size: 1rem;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    min-width: 80px;
    text-align: center;
}

/* アニメーション */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* レスポンシブデザイン */
@media (max-width: 768px) {
    .lesson-sections {
        right: 50%;
        transform: translate(50%, -50%);
        width: calc(100vw - 40px);
        max-width: 400px;
        height: 450px;
    }
    
    .lesson-content {
        padding: 30px 20px;
    }
    
    .lesson-content h2 {
        font-size: 1.5rem;
    }
    
    .lesson-content div {
        font-size: 0.9rem;
    }
    
    .kawada-character {
        width: 80px;
        height: 80px;
        bottom: 20%;
        left: 30%;
    }
    
    .kawada-character img {
        width: 80px;
        height: 80px;
    }
    
    .lottie-animation {
        width: 70vw;
        height: 100vh;
    }
    
    .navigation {
        bottom: 10px;
        padding: 12px 20px;
        gap: 15px;
    }
    
    .nav-button {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
    
    .progress-info {
        min-width: 60px;
        font-size: 0.9rem;
    }
}

/* ローディング表示 */
.loading {
    text-align: center;
    color: white;
    font-size: 1.2rem;
}

.loading::after {
    content: '';
    display: inline-block;
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>
</head>
<body>

<div class="cstudy-main-layout">
    <!-- ヘッダー -->
    <header class="cstudy-header">
        <h1>🌟 C言語学習システム</h1>
        <p>川田と一緒に学ぶプログラミングの基礎</p>
    </header>

    <!-- メインコンテンツ -->
    <main class="cstudy-main-content">
        <div class="cstudy-content-center">
            <h2>🚀 学習を始めよう</h2>
            <p>右側のセクションで川田と一緒にC言語の基礎を学びましょう。<br>
            各セクションは下から上がってくるアニメーションで表示されます。</p>
            <button class="cstudy-start-button" onclick="window.cStudyApp?.showSection(0)">
                学習開始
            </button>
        </div>
    </main>

    <!-- フッター -->
    <footer class="cstudy-footer">
        <p>&copy; 2025 C言語学習システム - Powered by 川田</p>
    </footer>
</div>

<!-- Lottieアニメーション - 背景左〜中央 -->
<div class="lottie-animation">
    <dotlottie-wc 
        src="https://lottie.host/6b9d8450-0591-4ba1-8c98-5e992969107b/oRwPEwm3hJ.lottie" 
        style="width: 100%; height: 100%;" 
        speed="1" 
        autoplay 
        loop>
    </dotlottie-wc>
</div>

<div class="kawada-character" id="kawada-char">
    <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
         width="150" 
         height="150" 
         alt="川田" 
         id="kawada-img">
</div>

<!-- セクション表示エリア（右側固定） -->
<div class="lesson-sections" id="lesson-container">
    <!-- 静的セクションを追加 -->
    <section class="lesson-section right active">
        <div class="lesson-content">
            <h2>🌟 C言語の世界へようこそ</h2>
            <div>川田と一緒に学習の旅を始めましょう！</div>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>📚 基本概念</h2>
            <div>C言語は1972年に開発されたプログラミング言語です。</div>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>💻 Hello World</h2>
            <div>プログラミングの第一歩を踏み出しましょう！</div>
        </div>
    </section>
</div>

<!-- ナビゲーション -->
<nav class="navigation">
    <button class="nav-button" id="prev-btn" disabled>
        ⬅️ 前へ
    </button>
    
    <div class="progress-info" id="progress-info">
        1 / 3
    </div>
    
    <button class="nav-button" id="next-btn">
        次へ ➡️
    </button>
</nav>

<script>
// クリックナビゲーション対応C言語学習システム
class ClickNavigationCStudy {
    constructor() {
        this.sections = [];
        this.currentIndex = 0;
        this.isLoading = false;
        
        this.init();
    }
    
    async init() {
        console.log("ClickNavigationCStudy初期化開始");
        
        // DOM要素を取得
        this.lessonContainer = document.getElementById('lesson-container');
        this.prevBtn = document.getElementById('prev-btn');
        this.nextBtn = document.getElementById('next-btn');
        this.progressInfo = document.getElementById('progress-info');
        
        // イベントリスナーを設定
        this.prevBtn.addEventListener('click', () => this.previousSection());
        this.nextBtn.addEventListener('click', () => this.nextSection());
        
        // 初期の静的セクションを取得
        this.sections = Array.from(this.lessonContainer.querySelectorAll('.lesson-section'));
        this.updateNavigation();
        
        // データベースからセクションを読み込み
        setTimeout(() => {
            this.loadDynamicSections();
        }, 1000);
    }
    
    async loadDynamicSections() {
        if (this.isLoading) return;
        this.isLoading = true;
        
        try {
            console.log("データベースからセクション読み込み開始...");
            
            const response = await fetch('/cstudy/api/lessons/', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            console.log("API Response status:", response.status);
            
            if (response.ok) {
                const apiSections = await response.json();
                console.log(`データベースから${apiSections.length}個のセクションを取得`);
                
                try {
                    this.replaceSectionsWithDynamic(apiSections);
                    console.log("動的セクションの置き換えが完了しました");
                } catch (replaceError) {
                    console.error("セクション置き換えでエラー:", replaceError);
                    console.log("静的セクションを維持します");
                }
            } else {
                console.error("API応答エラー:", response.status, response.statusText);
                console.log("静的セクションを維持");
            }
        } catch (error) {
            console.error("API読み込みエラー:", error);
            console.log("エラーのため静的セクションを維持します");
        }
        
        this.isLoading = false;
    }
    
    replaceSectionsWithDynamic(apiSections) {
        console.log("動的セクション置き換え開始");
        
        // 既存のセクションをクリア
        this.lessonContainer.innerHTML = '';
        this.sections = [];
        
        // 動的セクションを追加
        apiSections.forEach((section, index) => {
            try {
                const sectionElement = this.createSectionElement(section, index);
                this.lessonContainer.appendChild(sectionElement);
                this.sections.push(sectionElement);
            } catch (createError) {
                console.error(`セクション${index + 1}の作成でエラー:`, createError);
            }
        });
        
        // 最初のセクションを表示
        this.currentIndex = 0;
        this.showSection(0);
        
        console.log(`${apiSections.length}個の動的セクションに置き換えました`);
    }
    
    createSectionElement(section, index) {
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right`; // 全て右側に統一
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'lesson-content';
        
        // セクションタイプに応じたアイコン
        const icons = {
            'text': '📚',
            'code': '💻', 
            'explanation': '💡',
            'warning': '⚠️'
        };
        const icon = icons[section.type] || '📖';
        
        // コンテンツから最初の行をタイトルとして抽出
        const lines = (section.content || '').split('\n');
        const title = lines[0] || 'C言語学習';
        const body = lines.slice(1).join('<br>') || section.content || '';
        
        // HTML要素を作成
        const titleElement = document.createElement('h2');
        titleElement.textContent = `${icon} ${title}`;
        
        const bodyElement = document.createElement('div');
        bodyElement.innerHTML = body;
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(bodyElement);
        sectionDiv.appendChild(contentDiv);
        
        return sectionDiv;
    }
    
    showSection(index) {
        if (index < 0 || index >= this.sections.length) return;
        
        // 全てのセクションを非表示にする
        this.sections.forEach((section, i) => {
            section.classList.remove('active');
        });
        
        // 指定されたセクションを表示
        setTimeout(() => {
            this.sections[index].classList.add('active');
        }, 100);
        
        this.currentIndex = index;
        this.updateNavigation();
        
        // 川田の表情を変更（セクションにkawada_emotionがあれば）
        if (this.sections[index].dataset && this.sections[index].dataset.emotion) {
            this.updateKawadaEmotion(this.sections[index].dataset.emotion);
        }
        
        console.log(`セクション ${index + 1} を表示`);
    }
    
    updateNavigation() {
        // 前へボタン
        this.prevBtn.disabled = this.currentIndex === 0;
        
        // 次へボタン
        this.nextBtn.disabled = this.currentIndex === this.sections.length - 1;
        
        // 進捗表示
        this.progressInfo.textContent = `${this.currentIndex + 1} / ${this.sections.length}`;
    }
    
    updateKawadaEmotion(emotion) {
        const kawadaImg = document.getElementById('kawada-img');
        if (kawadaImg && emotion) {
            // 川田の表情画像を変更
            const emotionMap = {
                'cheerful': 'kawada-cheerful.png',
                'thinking': 'kawada-thinking.png',
                'smile': 'kawada-smile.png',
                'gentle': 'kawada-gentle.png',
                'default': 'kawada-sam.png'
            };
            
            const imageName = emotionMap[emotion] || emotionMap['default'];
            kawadaImg.src = `/static/img/${imageName}`;
        }
    }
    
    previousSection() {
        if (this.currentIndex > 0) {
            this.showSection(this.currentIndex - 1);
        }
    }
    
    nextSection() {
        if (this.currentIndex < this.sections.length - 1) {
            this.showSection(this.currentIndex + 1);
        }
    }
}

// 初期化
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded - クリックナビゲーション学習システム開始");
    window.cStudyApp = new ClickNavigationCStudy();
});
</script>

</body>
</html>
