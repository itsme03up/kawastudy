{% extends 'base.html' %}
{% load static %}

{% block title %}C言語入門 - 川田と歩く{% endblock %}

{% block body_class %}cstudy-page{% endblock %}

{% block extra_css %}
<style>
/* C言語学習ページ専用スタイル */
.cstudy-page {
    background: #000000 !important;
    padding-top: 40px !important; /* 短縮されたナビゲーションバーの高さを確保 */
    padding-bottom: 0 !important;
}

/* C言語学習ページ専用ナビゲーションバーの高さ調整 */
.cstudy-page .navbar {
    height: 40px !important;
    min-height: 40px !important;
}

.cstudy-page .navbar .container-fluid {
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
}

.cstudy-page .navbar-brand,
.cstudy-page .nav-link {
    font-size: 0.9rem !important;
    padding-top: 0.25rem !important;
    padding-bottom: 0.25rem !important;
}

/* ナビゲーションバーのラウンドを完全に削除 */
.cstudy-page .navbar,
.cstudy-page .navbar *,
.cstudy-page .dropdown-menu,
.cstudy-page .nav-link,
.cstudy-page .btn {
    border-radius: 0 !important;
}

/* C言語学習システムの完全独立オーバーレイ */
.cstudy-fullscreen-overlay {
    position: fixed;
    top: 40px; /* 短縮されたナビゲーションバーの下から開始 */
    left: 0;
    width: 100vw;
    height: calc(100vh - 40px); /* 短縮されたナビゲーションバーの高さを引く */
    z-index: 1000;
    background: #000000;
}

/* 基本スタイル */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body, html {
    margin: 0;
    padding: 0;
    overflow-x: hidden;
    overflow-y: auto;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    width: 100%;
    height: 100vh;
    background: #000000;
}

/* 静的モードスタイル */
.static-mode {
    display: block;
    position: relative;
    width: 100%;
    min-height: 100vh;
}

/* Lottieアニメーション - 背景左〜中央 */
.lottie-animation {
    position: fixed;
    top: 60px; /* 少し下に下げる */
    left: 0;
    width: 50vw;
    height: 90vh;
    z-index: 2;
}

/* 川田キャラクター - 右側コンテナ右下に配置 */
.kawada-character {
    position: fixed;
    bottom: 90px;
    right: 60px;
    z-index: 100;
    cursor: pointer;
    transition: all 0.3s ease;
}

.kawada-character:hover {
    transform: scale(1.1);
    filter: drop-shadow(0 8px 16px rgba(0,0,0,0.4));
}

.kawada-character img {
    width: 120px;
    height: 120px;
    filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    transition: all 0.3s ease;
}

/* キラキラエフェクト */
.star {
    position: absolute;
    display: block;
    width: 15px; /* キラキラの横幅 */
    height: 15px; /* キラキラの縦幅 */
    background-image: url("{% static 'img/star.svg' %}"); /* キラキラの画像 */
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center center;
    animation: glitter 1s ease-out;
    pointer-events: none;
    z-index: 150; /* 川田キャラクターより上に表示 */
}

/* キラキラアニメーション */
@keyframes glitter {
    0% {
        transform: scale(0) rotate(0deg);
        opacity: 0;
    }
    
    50% {
        transform: scale(1) rotate(180deg);
        opacity: 1;
    }
    
    100% {
        transform: scale(0) rotate(360deg);
        opacity: 0;
    }
}

/* 川田キャラクタークリック時のアニメーション */
@keyframes kawada-click {
    0% {
        transform: scale(1);
    }
    
    50% {
        transform: scale(0.95);
    }
    
    100% {
        transform: scale(1.05);
    }
}

.kawada-character.clicked {
    animation: kawada-click 0.3s ease-out;
}

/* セクション */
.lesson-sections {
    position: fixed;
    right: 30px; /* 左に20px伸ばす（右マージンを減らす） */
    top: 60%;
    transform: translateY(-50%);
    z-index: 10;
    width: 800px; /* 幅を50px拡大 */
    height: 500px; /* 高さを50px拡大 */
    display: flex;
    align-items: center;
    justify-content: center;
}

.lesson-section {
    display: none;
    width: 100%;
    height: 100%;
    position: absolute;
    opacity: 0;
    transform: translateY(50px);
    transition: all 0.6s ease;
}

.lesson-section.active {
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 1;
    transform: translateY(0);
    animation: slideInUp 0.6s ease forwards;
}

.lesson-content {
    background: rgba(255,255,255,0.95);
    padding: 40px;
    border-radius: 20px;
    text-align: left;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    backdrop-filter: blur(15px);
    border: 1px solid rgba(255,255,255,0.3);
    position: relative;
    overflow: hidden;
}

.lesson-content::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, #667eea, #764ba2);
}

.lesson-content h2 {
    font-size: 1.8rem;
    margin-bottom: 20px;
    color: #333;
    line-height: 1.4;
    text-align: left;
}

.lesson-content div {
    font-size: 1rem;
    line-height: 1.6;
    color: #555;
    flex: 1;
    display: flex;
    align-items: flex-start;
    justify-content: flex-start;
    text-align: left;
}

/* ナビゲーション */
.navigation {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    gap: 20px;
    align-items: center;
    background: rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
    padding: 15px 25px;
    border-radius: 50px;
    border: 1px solid rgba(255,255,255,0.2);
}

.nav-button {
    background: rgba(255,255,255,0.2);
    border: 1px solid rgba(255,255,255,0.3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 500;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.nav-button:hover {
    background: rgba(255,255,255,0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.nav-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.progress-info {
    color: white;
    font-size: 1rem;
    font-weight: 500;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    min-width: 80px;
    text-align: center;
}

/* アニメーション */
@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(50px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

@keyframes fadeIn {
    from {
        opacity: 0;
    }
    to {
        opacity: 1;
    }
}

/* C言語学習ページ専用のテキスト左寄せスタイル */
.cstudy-page .box27,
.cstudy-page .lesson-content {
    text-align: left !important;
}

.cstudy-page .box27 p,
.cstudy-page .lesson-content div,
.cstudy-page .box27 div {
    text-align: left !important;
    align-items: flex-start !important;
    justify-content: flex-start !important;
}

/* コードブロック用スタイル */
.cstudy-page pre,
.cstudy-page code,
.cstudy-page .box27 pre {
    text-align: left !important;
    white-space: pre-wrap !important;
    font-family: 'Courier New', monospace, 'Source Code Pro', 'Consolas' !important;
    background-color: #f8f8f8 !important;
    padding: 1rem !important;
    border-radius: 4px !important;
    overflow-x: auto !important;
    width: 100% !important;
    border-left: 3px solid #62c1ce !important;
    font-size: 0.9rem !important;
    line-height: 1.4 !important;
    color: #333 !important;
    margin: 0.5rem 0 !important;
    box-sizing: border-box !important;
}

/* コードセクション専用スタイル */
.code-container {
    background: transparent !important;
    border: none !important;
    padding: 20px !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    backdrop-filter: none !important;
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    align-items: flex-start;
}

.code-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    margin-bottom: 1.5rem;
    padding: 1.8rem 2.5rem;
    background: rgba(255,255,255,0.9);
    border-radius: 8px;
    border-left: 4px solid #62c1ce;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.code-icon {
    margin-right: 0.5rem;
}

.code-block {
    background: #f8f8f8 !important;
    border: 1px solid #ddd !important;
    border-left: 4px solid #62c1ce !important;
    padding: 2.5rem 3rem !important;
    margin: 1.5rem 0 !important;
    border-radius: 6px !important;
    font-family: 'Courier New', monospace !important;
    font-size: 0.9rem !important;
    line-height: 1.5 !important;
    color: #333 !important;
    white-space: pre-wrap !important;
    overflow-x: auto !important;
    width: 100% !important;
    box-sizing: border-box !important;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
}

.code-explanation {
    background: rgba(255,255,255,0.95);
    padding: 2.2rem 2.8rem;
    border-radius: 8px;
    border-left: 4px solid #764ba2;
    margin-top: 1.5rem;
    font-size: 1rem;
    line-height: 1.7;
    color: #555;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    backdrop-filter: blur(10px);
}

/* レスポンシブデザイン */
@media (max-width: 768px) {
    .lesson-sections {
        right: 50%;
        transform: translate(50%, -50%);
        width: calc(100vw - 20px); /* モバイルでより幅を広く */
        max-width: 800px; /* 最大幅を少し拡大 */
        height: 600px; /* 高さも少し拡大 */
    }
    
    .lesson-content {
        padding: 30px 20px;
    }
    
    .lesson-content h2 {
        font-size: 1.5rem;
    }
    
    .lesson-content div {
        font-size: 0.9rem;
    }
    
    .kawada-character {
        bottom: 60px;
        right: 20px;
    }
    
    .kawada-character img {
        width: 80px;
        height: 80px;
    }
    
    .lottie-animation {
        width: 70vw;
        height: 100vh;
    }
    
    .navigation {
        bottom: 10px;
        padding: 12px 20px;
        gap: 15px;
    }
    
    .nav-button {
        padding: 8px 16px;
        font-size: 0.9rem;
    }
    
    .progress-info {
        min-width: 60px;
        font-size: 0.9rem;
    }
}

/* ローディング表示 */
.loading {
    text-align: center;
    color: white;
    font-size: 1.2rem;
}

.loading::after {
    content: '';
    display: inline-block;
    animation: dots 1.5s infinite;
}

@keyframes dots {
    0%, 20% { content: ''; }
    40% { content: '.'; }
    60% { content: '..'; }
    80%, 100% { content: '...'; }
}
</style>
{% endblock %}

{% block content %}
<div class="cstudy-fullscreen-overlay">
    <div class="cstudy-main-layout">
        <!-- ヘッダー -->
        <header class="cstudy-header">
            <h1>C言語</h1>
            <p>川田と一緒に学ぶプログラミングの基礎</p>
        </header>

        <!-- メインコンテンツ -->
        <main class="cstudy-main-content">
            
        </main>
    </div>

    <!-- Lottieアニメーション - 背景左〜中央 -->
    <div class="lottie-animation">
        <dotlottie-wc 
            src="https://lottie.host/79ee2210-feb0-49c3-97a0-3e684c775999/cj6QHe24lp.lottie" 
            style="width: 100%; height: 100%;" 
            speed="1" 
            autoplay 
            loop>
        </dotlottie-wc>
    </div>

    <div class="kawada-character" id="kawada-char">
        <img src="{% static 'img/parallax/characters/kawada-sam.png' %}" 
             width="200" 
             height="200" 
             alt="川田" 
             id="kawada-img">
    </div>

<!-- セクション表示エリア（右側固定） -->
<div class="lesson-sections" id="lesson-container">
    <!-- 静的セクションを追加 -->

    <section class="lesson-section right">
        <div class="box27">
            <span class="box-title">📚 基本概念</span>
            <p>C言語は1972年に開発されたプログラミング言語です。</p>
        </div>
    </section>
    
    <section class="lesson-section right">
        <div class="lesson-content">
            <h2>💻 Hello World</h2>
            <div>プログラミングの第一歩を踏み出しましょう！</div>
        </div>
    </section>
</div>

<!-- ナビゲーション -->
<nav class="navigation">
    <button class="nav-button" id="prev-btn" disabled>
        ⬅️ 前へ
    </button>
    
    <div class="progress-info" id="progress-info">
        1 / 3
    </div>
    
    <!-- Nextボタンは川田キャラクターで代替 -->
    <div class="next-hint" style="color: white; font-size: 0.9rem; opacity: 0.7;">
        川田をクリックして次へ ➡️
    </div>
</nav>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/@lottiefiles/dotlottie-wc@0.6.2/dist/dotlottie-wc.js" type="module"></script>
<script>
// クリックナビゲーション対応C言語学習システム
class ClickNavigationCStudy {
    constructor() {
        this.sections = [];
        this.currentIndex = 0;
        this.isLoading = false;
        
        this.init();
    }
    
    async init() {
        console.log("ClickNavigationCStudy初期化開始");
        
        // DOM要素を取得
        this.lessonContainer = document.getElementById('lesson-container');
        this.prevBtn = document.getElementById('prev-btn');
        this.kawadaChar = document.getElementById('kawada-char');
        this.progressInfo = document.getElementById('progress-info');
        
        // イベントリスナーを設定
        this.prevBtn.addEventListener('click', () => this.previousSection());
        this.kawadaChar.addEventListener('click', () => {
            // クリック時のアニメーション
            this.kawadaChar.classList.add('clicked');
            setTimeout(() => {
                this.kawadaChar.classList.remove('clicked');
            }, 300);
            
            // キラキラエフェクト
            this.createGlitterEffect();
            
            // 次のセクションへ
            setTimeout(() => {
                this.nextSection();
            }, 150);
        });
        
        // 初期の静的セクションを取得
        this.sections = Array.from(this.lessonContainer.querySelectorAll('.lesson-section'));
        this.updateNavigation();
        
        // データベースからセクションを読み込み
        setTimeout(() => {
            this.loadDynamicSections();
        }, 1000);
    }
    
    async loadDynamicSections() {
        if (this.isLoading) return;
        this.isLoading = true;
        
        try {
            console.log("データベースからセクション読み込み開始...");
            
            const response = await fetch('/cstudy/api/lessons/', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });
            
            console.log("API Response status:", response.status);
            
            if (response.ok) {
                const apiSections = await response.json();
                console.log(`データベースから${apiSections.length}個のセクションを取得`);
                
                try {
                    this.replaceSectionsWithDynamic(apiSections);
                    console.log("動的セクションの置き換えが完了しました");
                } catch (replaceError) {
                    console.error("セクション置き換えでエラー:", replaceError);
                    console.log("静的セクションを維持します");
                }
            } else {
                console.error("API応答エラー:", response.status, response.statusText);
                console.log("静的セクションを維持");
            }
        } catch (error) {
            console.error("API読み込みエラー:", error);
            console.log("エラーのため静的セクションを維持します");
        }
        
        this.isLoading = false;
    }
    
    replaceSectionsWithDynamic(apiSections) {
        console.log("動的セクション置き換え開始");
        
        // 既存のセクションをクリア
        this.lessonContainer.innerHTML = '';
        this.sections = [];
        
        // コードとその後の解説をペアにして処理
        this.processedSections = [];
        
        for (let i = 0; i < apiSections.length; i++) {
            const section = apiSections[i];
            
            // コードセクションの場合、次のセクションが解説なら組み合わせる
            if (section.type === 'code' && i + 1 < apiSections.length && apiSections[i + 1].type === 'explanation') {
                const nextSection = apiSections[i + 1];
                const combinedSection = this.createCombinedCodeSection(section, nextSection, i);
                this.lessonContainer.appendChild(combinedSection);
                this.sections.push(combinedSection);
                i++; // 次の解説セクションをスキップ
            } else {
                // 通常のセクション処理
                const sectionElement = this.createSectionElement(section, i);
                this.lessonContainer.appendChild(sectionElement);
                this.sections.push(sectionElement);
            }
        }
        
        // 最初のセクションを表示
        this.currentIndex = 0;
        this.showSection(0);
        
        console.log(`${this.sections.length}個の動的セクションに置き換えました`);
    }
    
    createCombinedCodeSection(codeSection, explanationSection, index) {
        console.log(`組み合わせセクション${index + 1}作成開始:`, codeSection, explanationSection);
        
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right code-section`; // コード専用クラス追加
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'code-container'; // 透明背景用のクラス
        
        // コードタイトル部分
        const codeLines = (codeSection.content || '').split('\n');
        const codeTitle = codeLines[0] || 'C言語学習';
        const codeBody = codeLines.slice(1).join('\n') || codeSection.content || '';
        
        // コードタイトル
        const titleElement = document.createElement('div');
        titleElement.className = 'code-title';
        titleElement.innerHTML = `<span class="code-icon">💻</span> ${codeTitle}`;
        
        // コードブロック
        const codeElement = document.createElement('pre');
        codeElement.className = 'code-block';
        codeElement.textContent = codeBody;
        
        // 解説部分
        const explanationElement = document.createElement('div');
        explanationElement.className = 'code-explanation';
        explanationElement.innerHTML = explanationSection.content.replace(/\n/g, '<br>');
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(codeElement);
        contentDiv.appendChild(explanationElement);
        sectionDiv.appendChild(contentDiv);
        
        console.log(`組み合わせセクション${index + 1}作成完了`);
        return sectionDiv;
    }
    
    createSectionElement(section, index) {
        console.log(`セクション${index + 1}作成開始:`, section); // デバッグ用
        
        const sectionDiv = document.createElement('section');
        sectionDiv.className = `lesson-section right`; // 全て右側に統一
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'box27';
        
        // セクションタイプに応じたアイコン
        const icons = {
            'text': '📚',
            'code': '💻', 
            'explanation': '💡',
            'warning': '⚠️'
        };
        const icon = icons[section.type] || '📖';
        
        // コンテンツから最初の行をタイトルとして抽出
        const lines = (section.content || '').split('\n');
        const title = lines[0] || 'C言語学習';
        const body = lines.slice(1).join('\n') || section.content || '';
        
        console.log(`セクション${index + 1} - タイプ: ${section.type}, タイトル: ${title}`); // デバッグ用
        
        // HTML要素を作成
        const titleElement = document.createElement('span');
        titleElement.className = 'box-title';
        titleElement.textContent = `${icon} ${title}`;
        
        // コード型の場合はpreタグを使用、その他はpタグ
        const bodyElement = section.type === 'code' ? 
            document.createElement('pre') : 
            document.createElement('p');
        
        if (section.type === 'code') {
            console.log('コードセクション処理:', section.type, body); // デバッグ用
            bodyElement.textContent = body; // コードはエスケープして表示
            bodyElement.style.textAlign = 'left';
            bodyElement.style.whiteSpace = 'pre-wrap';
            bodyElement.style.fontFamily = 'Courier New, monospace';
            bodyElement.style.backgroundColor = '#f8f8f8';
            bodyElement.style.padding = '1rem';
            bodyElement.style.borderRadius = '4px';
            bodyElement.style.borderLeft = '3px solid #62c1ce';
            bodyElement.style.fontSize = '0.9rem';
            bodyElement.style.lineHeight = '1.4';
            bodyElement.style.overflow = 'auto';
            bodyElement.style.display = 'block';
            bodyElement.style.width = '100%';
            console.log('作成されたpreタグ:', bodyElement); // デバッグ用
        } else {
            bodyElement.innerHTML = body.replace(/\n/g, '<br>'); // 説明文は改行をbrタグに
        }
        
        contentDiv.appendChild(titleElement);
        contentDiv.appendChild(bodyElement);
        sectionDiv.appendChild(contentDiv);
        
        console.log(`セクション${index + 1}作成完了`); // デバッグ用
        return sectionDiv;
    }
    
    showSection(index) {
        if (index < 0 || index >= this.sections.length) return;
        
        // 全てのセクションを非表示にする
        this.sections.forEach((section, i) => {
            section.classList.remove('active');
        });
        
        // 指定されたセクションを表示
        setTimeout(() => {
            this.sections[index].classList.add('active');
        }, 100);
        
        this.currentIndex = index;
        this.updateNavigation();
        
        // 川田の表情を変更（セクションにkawada_emotionがあれば）
        if (this.sections[index].dataset && this.sections[index].dataset.emotion) {
            this.updateKawadaEmotion(this.sections[index].dataset.emotion);
        }
        
        console.log(`セクション ${index + 1} を表示`);
    }
    
    updateNavigation() {
        // 前へボタン
        this.prevBtn.disabled = this.currentIndex === 0;
        
        // 川田キャラクターの状態管理（最後のセクションでは透明度を下げる）
        if (this.currentIndex === this.sections.length - 1) {
            this.kawadaChar.style.opacity = '0.5';
            this.kawadaChar.style.cursor = 'not-allowed';
        } else {
            this.kawadaChar.style.opacity = '1';
            this.kawadaChar.style.cursor = 'pointer';
        }
        
        // 進捗表示
        this.progressInfo.textContent = `${this.currentIndex + 1} / ${this.sections.length}`;
    }
    
    updateKawadaEmotion(emotion) {
        const kawadaImg = document.getElementById('kawada-img');
        if (kawadaImg && emotion) {
            // 川田の表情画像を変更
            const emotionMap = {
                'cheerful': 'kawada-cheerful.png',
                'thinking': 'kawada-thinking.png',
                'smile': 'kawada-smile.png',
                'gentle': 'kawada-gentle.png',
                'default': 'kawada-sam.png'
            };
            
            const imageName = emotionMap[emotion] || emotionMap['default'];
            kawadaImg.src = `/static/img/${imageName}`;
        }
    }
    
    previousSection() {
        if (this.currentIndex > 0) {
            this.showSection(this.currentIndex - 1);
        }
    }
    
    nextSection() {
        if (this.currentIndex < this.sections.length - 1) {
            this.showSection(this.currentIndex + 1);
        }
    }
    
    // キラキラエフェクトを生成する関数
    createGlitterEffect() {
        const kawadaRect = this.kawadaChar.getBoundingClientRect();
        const starCount = 8; // 一度に生成する星の数
        
        for (let i = 0; i < starCount; i++) {
            setTimeout(() => {
                const starEl = document.createElement('span');
                starEl.className = 'star';
                
                // 川田キャラクターの範囲内でランダムな位置に配置
                const randomX = Math.random() * kawadaRect.width;
                const randomY = Math.random() * kawadaRect.height;
                
                starEl.style.left = randomX + 'px';
                starEl.style.top = randomY + 'px';
                
                this.kawadaChar.appendChild(starEl);
                
                // 1秒後にキラキラを削除
                setTimeout(() => {
                    if (starEl.parentNode) {
                        starEl.remove();
                    }
                }, 1000);
            }, i * 100); // 100msずつ時差をつけて生成
        }
    }
}

// 初期化
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOMContentLoaded - クリックナビゲーション学習システム開始");
    window.cStudyApp = new ClickNavigationCStudy();
});
</script>
{% endblock %}
