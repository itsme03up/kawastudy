{% extends 'base.html' %}
{% load static %}

{% block title %}Cè¨€èªå…¥é–€{% endblock %}

{% block body_class %}cstudy-unified-page{% endblock %}

{% block head %}
<style>
/* åŸºæœ¬ã‚¹ã‚¿ã‚¤ãƒ« */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    overflow-x: hidden;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ« */
.parallax-mode {
    display: block;
    position: relative;
    height: 400vh;
    width: 100%;
}

.background-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    z-index: -1;
    overflow: hidden;
}

.path, .clouds {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    will-change: transform;
    z-index: -2;
}

.path {
    background-color: #4a5d23;
    background-image: url('{% static "img/parallax/backgrounds/path.png" %}');
}

.clouds {
    background-image: url('{% static "img/parallax/backgrounds/clouds.png" %}');
    z-index: -1;
    opacity: 0.7;
}
.kawada-character {
    position: fixed;
    bottom: 20%;
    left: 10%;
    width: 150px;
    height: 150px;
    z-index: 5;
    transition: all 0.5s ease;
    overflow: hidden;
    border-radius: 10px;
}

.kawada-character img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    object-position: center;
    display: block;
}


/* å­¦ç¿’ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
.lesson-sections {
    position: relative;
    z-index: 10;
    padding: 100vh 0 50px;
}

.lesson-section {
    position: relative;
    min-height: 100vh;
    display: flex;
    align-items: center;
    padding: 50px;
}

.lesson-content-box {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 20px;
    padding: 40px;
    max-width: 800px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    backdrop-filter: blur(10px);
}

.lesson-content-box.left {
    margin-left: 10%;
}

.lesson-content-box.right {
    margin-left: auto;
    margin-right: 10%;
}

.lesson-content-box.center {
    margin: 0 auto;
}

/* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
.progress-section h3 {
    color: #007bff;
    margin-bottom: 15px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-container {
    background: #e9ecef;
    border-radius: 10px;
    height: 20px;
    margin-bottom: 10px;
    overflow: hidden;
}

.progress-bar {
    background: linear-gradient(45deg, #007bff, #0056b3);
    height: 100%;
    width: 0%;
    border-radius: 10px;
    transition: width 0.5s ease;
}

.lesson-list {
    list-style: none;
    margin: 0;
    padding: 0;
}

.lesson-btn {
    width: 100%;
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #dee2e6;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 16px;
}

.lesson-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,123,255,0.3);
    border-color: #007bff;
}

.lesson-btn.active {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.lesson-btn.completed {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.lesson-icon {
    font-size: 24px;
    min-width: 30px;
}

.lesson-title {
    flex: 1;
    text-align: left;
}

.completion-status {
    font-size: 20px;
    min-width: 30px;
    text-align: center;
}

.kawada-comment {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px;
    border-radius: 15px;
    margin-top: 20px;
}

.code-editor {
    background: #1e1e1e;
    color: #ffffff;
    border-radius: 10px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    min-height: 300px;
    margin: 20px 0;
}

.code-output {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 10px;
    padding: 20px;
    font-family: 'Courier New', monospace;
    font-size: 14px;
    min-height: 100px;
    margin: 20px 0;
}

.run-btn {
    background: #28a745;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 12px 24px;
    font-size: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.run-btn:hover {
    background: #218838;
    transform: translateY(-2px);
}

/* ã‚¯ã‚¤ã‚ºã‚¹ã‚¿ã‚¤ãƒ« */
.quiz-container {
    background: rgba(255, 243, 205, 0.95);
    border-radius: 15px;
    padding: 30px;
    margin: 20px 0;
}

.quiz-options {
    list-style: none;
    margin: 20px 0;
    padding: 0;
}

.quiz-option {
    background: white;
    border: 2px solid #dee2e6;
    border-radius: 10px;
    padding: 15px;
    margin: 10px 0;
    cursor: pointer;
    transition: all 0.3s ease;
}

.quiz-option:hover {
    border-color: #007bff;
    transform: translateX(5px);
}

.quiz-option.selected {
    background: #007bff;
    color: white;
    border-color: #007bff;
}

.quiz-option.correct {
    background: #28a745;
    color: white;
    border-color: #28a745;
}

.quiz-option.incorrect {
    background: #dc3545;
    color: white;
    border-color: #dc3545;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ */
@media (max-width: 768px) {
    .lesson-section {
        padding: 20px;
    }
    
    .lesson-content-box.left,
    .lesson-content-box.right {
        margin-left: 5%;
        margin-right: 5%;
    }
    
    .kawada-character {
        width: 100px;
        height: 100px;
        bottom: 10%;
        left: 5%;
    }
}
</style>
{% endblock %}

{% block content %}

<!-- ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ãƒ¢ãƒ¼ãƒ‰ -->
<div id="parallax-mode" class="parallax-mode">
    <div class="background-container">
        <div class="path" id="path-bg"></div>
        <div class="clouds" id="clouds-bg"></div>
        
        <div class="kawada-character" id="kawada-char">
            <img src="{% static 'img/kawada-default.png' %}" 
                 width="150" 
                 height="150" 
                 alt="å·ç”°" 
                 id="kawada-img">
        </div>
    </div>

    <div class="lesson-sections" id="lesson-sections">
        <!-- å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒç”Ÿæˆã•ã‚Œã‚‹ -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// çµ±åˆã•ã‚ŒãŸCè¨€èªå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
class UnifiedCStudy {
    constructor() {
        this.currentMode = 'parallax';
        this.currentLesson = null;
        this.lessonData = [];
        this.quizData = [];
        this.progress = 0;
        
        this.init();
    }
    
    async init() {
        await this.loadLessonData();
        await this.loadQuizData();
        this.initKawadaScheduler();
        this.initParallax(); // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ã‚’è‡ªå‹•ã§åˆæœŸåŒ–
    }
    
    initParallax() {
        // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        let ticking = false;
        
        const handleScroll = () => {
            if (!ticking) {
                requestAnimationFrame(() => {
                    const scrollY = window.scrollY;
                    const pathBg = document.getElementById('path-bg');
                    const cloudsBg = document.getElementById('clouds-bg');
                    const kawadaChar = document.getElementById('kawada-char');
                    
                    // ã‚ˆã‚Šè‡ªç„¶ãªãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹åŠ¹æœ
                    if (pathBg) pathBg.style.transform = `translateY(${scrollY * 0.5}px)`;
                    if (cloudsBg) cloudsBg.style.transform = `translateY(${scrollY * 0.3}px)`;
                    if (kawadaChar) {
                        kawadaChar.style.transform = `translateY(${scrollY * 0.1}px) translateX(${Math.sin(scrollY * 0.01) * 10}px)`;
                    }
                    
                    ticking = false;
                });
                ticking = true;
            }
        };
        
        window.addEventListener('scroll', handleScroll, { passive: true });
        this.generateParallaxContent();
    }
    
    async generateParallaxContent() {
        const container = document.getElementById('lesson-sections');
        container.innerHTML = '';
        
        const lessons = [
            { 
                title: 'Cè¨€èªå…¥é–€', 
                content: 'Cè¨€èªã¯1972å¹´ã«ãƒ‡ãƒ‹ã‚¹ãƒ»ãƒªãƒƒãƒãƒ¼ã«ã‚ˆã£ã¦é–‹ç™ºã•ã‚ŒãŸãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã«é©ã—ã¦ãŠã‚Šã€ç¾åœ¨ã§ã‚‚å¤šãã®å ´é¢ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚', 
                side: 'center',
                code: '#include <stdio.h>\n\nint main() {\n    printf("Cè¨€èªã®ä¸–ç•Œã¸ã‚ˆã†ã“ã!\\n");\n    return 0;\n}'
            },
            { 
                title: 'Hello World', 
                content: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ç¬¬ä¸€æ­©ï¼ã¾ãšã¯å®šç•ªã®ã€ŒHello Worldã€ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‹ã‚‰å§‹ã‚ã¾ã—ã‚‡ã†ã€‚', 
                side: 'left',
                code: '#include <stdio.h>\n\nint main() {\n    printf("Hello, World!\\n");\n    return 0;\n}'
            },
            { 
                title: 'å¤‰æ•°ã¨å‹', 
                content: 'Cè¨€èªã§ã¯æ§˜ã€…ãªãƒ‡ãƒ¼ã‚¿å‹ã‚’ä½¿ã£ã¦å¤‰æ•°ã‚’å®£è¨€ã§ãã¾ã™ã€‚intã€floatã€charãªã©ã®åŸºæœ¬å‹ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚', 
                side: 'right',
                code: '#include <stdio.h>\n\nint main() {\n    int age = 20;\n    float height = 175.5;\n    char grade = \'A\';\n    \n    printf("å¹´é½¢: %dæ­³\\n", age);\n    printf("èº«é•·: %.1fcm\\n", height);\n    printf("æˆç¸¾: %c\\n", grade);\n    return 0;\n}'
            },
            { 
                title: 'è¨ˆç®—ã¨æ¼”ç®—', 
                content: 'å››å‰‡æ¼”ç®—ã‚„ãã®ä»–ã®æ¼”ç®—å­ã‚’ä½¿ã£ã¦è¨ˆç®—ã‚’è¡Œã„ã¾ã—ã‚‡ã†ã€‚ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®åŸºæœ¬ã§ã™ï¼', 
                side: 'center',
                code: '#include <stdio.h>\n\nint main() {\n    int a = 10, b = 3;\n    \n    printf("a + b = %d\\n", a + b);\n    printf("a - b = %d\\n", a - b);\n    printf("a * b = %d\\n", a * b);\n    printf("a / b = %d\\n", a / b);\n    printf("a %% b = %d\\n", a % b);\n    return 0;\n}'
            },
            { 
                title: 'å…¥åŠ›ã¨å‡ºåŠ›', 
                content: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘å–ã£ã¦å‡¦ç†ã™ã‚‹æ–¹æ³•ã‚’å­¦ã³ã¾ã—ã‚‡ã†ã€‚scanfã¨printfã¯é‡è¦ãªé–¢æ•°ã§ã™ã€‚', 
                side: 'left',
                code: '#include <stdio.h>\n\nint main() {\n    char name[50];\n    int age;\n    \n    printf("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ");\n    scanf("%s", name);\n    printf("å¹´é½¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ");\n    scanf("%d", &age);\n    \n    printf("ã“ã‚“ã«ã¡ã¯ã€%sã•ã‚“ï¼\\n", name);\n    printf("ã‚ãªãŸã¯%dæ­³ã§ã™ã­ã€‚\\n", age);\n    return 0;\n}'
            }
        ];
        
        lessons.forEach((lesson, index) => {
            const section = document.createElement('div');
            section.className = 'lesson-section';
            section.innerHTML = `
                <div class="lesson-content-box ${lesson.side}">
                    <h2>ğŸ“– ${lesson.title}</h2>
                    <p>${lesson.content}</p>
                    <div class="code-editor">
                        <pre><code>${lesson.code}</code></pre>
                    </div>
                    <button class="run-btn" onclick="runParallaxCode(this)">â–¶ï¸ å®Ÿè¡Œã—ã¦ã¿ã‚‹</button>
                    <div class="code-output" style="display: none;">
                        <strong>å®Ÿè¡Œçµæœ:</strong>
                        <pre id="output-${index}">// å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</pre>
                    </div>
                </div>
            `;
            container.appendChild(section);
        });
    }
    
    setupLessonButtons() {
        const buttons = document.querySelectorAll('.lesson-btn');
        buttons.forEach(btn => {
            btn.addEventListener('click', () => {
                const lesson = btn.dataset.lesson;
                this.selectLesson(lesson);
                
                // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
                buttons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            });
        });
    }
    
    selectLesson(lessonId) {
        this.currentLesson = lessonId;
        this.updateLessonContent(lessonId);
        this.updateKawadaComment(lessonId);
        
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ã«é€šçŸ¥
        if (window.kawadaScheduler) {
            kawadaScheduler.currentLesson = `Cè¨€èª - ${lessonId}`;
        }
    }
    
    updateLessonContent(lessonId) {
        const content = document.getElementById('lesson-content');
        const lessons = {
            intro: {
                title: 'Cè¨€èªå…¥é–€',
                description: 'Cè¨€èªã®åŸºæœ¬æ¦‚å¿µã‚’å­¦ã³ã¾ã—ã‚‡ã†',
                code: '#include <stdio.h>\n\nint main() {\n    printf("Cè¨€èªå­¦ç¿’é–‹å§‹ï¼\\n");\n    return 0;\n}'
            },
            hello: {
                title: 'Hello World',
                description: 'æœ€åˆã®Cè¨€èªãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æ›¸ã„ã¦ã¿ã¾ã—ã‚‡ã†',
                code: '#include <stdio.h>\n\nint main() {\n    printf("Hello, World!\\n");\n    return 0;\n}'
            },
            variables: {
                title: 'å¤‰æ•°ã¨è¨ˆç®—',
                description: 'å¤‰æ•°ã‚’ä½¿ã£ã¦è¨ˆç®—ã‚’ã—ã¦ã¿ã¾ã—ã‚‡ã†',
                code: '#include <stdio.h>\n\nint main() {\n    int a = 10;\n    int b = 20;\n    int sum = a + b;\n    printf("åˆè¨ˆ: %d\\n", sum);\n    return 0;\n}'
            },
            input: {
                title: 'å…¥åŠ›ã¨å‡ºåŠ›',
                description: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®å…¥åŠ›ã‚’å—ã‘å–ã£ã¦ã¿ã¾ã—ã‚‡ã†',
                code: '#include <stdio.h>\n\nint main() {\n    int number;\n    printf("æ•°å­—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ");\n    scanf("%d", &number);\n    printf("å…¥åŠ›ã•ã‚ŒãŸæ•°å­—: %d\\n", number);\n    return 0;\n}'
            },
            strings: {
                title: 'æ–‡å­—åˆ—ã¨é…åˆ—',
                description: 'æ–‡å­—åˆ—ã¨é…åˆ—ã®åŸºæœ¬æ“ä½œã‚’å­¦ã³ã¾ã—ã‚‡ã†',
                code: '#include <stdio.h>\n#include <string.h>\n\nint main() {\n    char name[50];\n    printf("ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„: ");\n    scanf("%s", name);\n    printf("ã“ã‚“ã«ã¡ã¯ã€%sã•ã‚“ï¼\\n", name);\n    return 0;\n}'
            }
        };
        
        const lesson = lessons[lessonId] || lessons.intro;
        
        content.innerHTML = `
            <h2>${lesson.title}</h2>
            <p>${lesson.description}</p>
            <div class="code-editor" id="code-editor" contenteditable="true">${lesson.code.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
            <button class="run-btn" onclick="runCode()">â–¶ï¸ å®Ÿè¡Œ</button>
            <div class="code-output" id="code-output">å®Ÿè¡ŒçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        `;
    }
    
    updateKawadaComment(lessonId) {
        const comment = document.getElementById('kawada-comment');
        const comments = {
            intro: 'Cè¨€èªå­¦ç¿’ã®å§‹ã¾ã‚Šã§ã™ã­ï¼ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ğŸ’ª',
            hello: 'Hello Worldã¯å…¨ã¦ã®å§‹ã¾ã‚Šï¼ã¾ãšã¯ã“ã“ã‹ã‚‰æ…£ã‚Œã¦ã„ãã¾ã—ã‚‡ã†ğŸ˜Š',
            variables: 'å¤‰æ•°ã¯ ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®åŸºæœ¬ä¸­ã®åŸºæœ¬ã§ã™ã€‚ã—ã£ã‹ã‚Šç†è§£ã—ã¾ã—ã‚‡ã†ğŸ“',
            input: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾è©±ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã‚ˆï¼æ¥½ã—ããªã£ã¦ãã¾ã—ãŸâœ¨',
            strings: 'æ–‡å­—åˆ—æ“ä½œã¯ã¨ã¦ã‚‚é‡è¦ã§ã™ã€‚æ…é‡ã«å­¦ç¿’ã—ã¦ã„ãã¾ã—ã‚‡ã†ğŸ”¤'
        };
        
        comment.innerHTML = `<p>${comments[lessonId] || 'ãŒã‚“ã°ã£ã¦å­¦ç¿’ã—ã¾ã—ã‚‡ã†ï¼'}</p>`;
    }
    
    async loadLessonData() {
        try {
            const response = await fetch('/cstudy/api/lessons/');
            if (response.ok) {
                this.lessonData = await response.json();
            }
        } catch (error) {
            console.log('ãƒ¬ãƒƒã‚¹ãƒ³ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    }
    
    async loadQuizData() {
        try {
            const response = await fetch('/cstudy/api/quizzes/');
            if (response.ok) {
                this.quizData = await response.json();
            }
        } catch (error) {
            console.log('ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
        }
    }
    
    initKawadaScheduler() {
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿å®Ÿè¡Œ
        if (window.kawadaScheduler) {
            kawadaScheduler.startSession('cstudy', 'Cè¨€èªå…¥é–€');
        }
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³çµ‚äº†æ™‚ã®å‡¦ç†
        window.addEventListener('beforeunload', () => {
            if (window.kawadaScheduler && kawadaScheduler.isRecording) {
                const isCompleted = this.progress >= 100;
                kawadaScheduler.endSession(isCompleted);
            }
        });
    }
    
    updateProgress(percentage) {
        this.progress = percentage;
        const progressBar = document.getElementById('learning-progress-bar');
        const progressText = document.getElementById('progress-text');
        
        if (progressBar) progressBar.style.width = `${percentage}%`;
        if (progressText) progressText.textContent = `é€²æ—: ${percentage}%`;
    }
    
    markLessonCompleted(lessonId) {
        const button = document.querySelector(`[data-lesson="${lessonId}"]`);
        if (button) {
            button.classList.add('completed');
            button.querySelector('.completion-status').textContent = 'âœ“';
        }
        
        // é€²æ—æ›´æ–°
        const completedLessons = document.querySelectorAll('.lesson-btn.completed').length;
        const totalLessons = document.querySelectorAll('.lesson-btn').length;
        const progress = Math.round((completedLessons / totalLessons) * 100);
        this.updateProgress(progress);
        
        // å·ç”°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        if (window.kawadaScheduler) {
            kawadaScheduler.showKawadaMessage(
                "ãŠç–²ã‚Œã•ã¾ã§ã—ãŸï¼", 
                "ãƒ¬ãƒƒã‚¹ãƒ³ã‚’å®Œäº†ã—ã¾ã—ãŸã­ï¼å·ç”°ã‚‚ã¨ã¦ã‚‚å¬‰ã—ã„ã§ã™ğŸ’•", 
                'cheerful'
            );
        }
    }
}

// ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ©Ÿèƒ½
async function runCode() {
    const codeEditor = document.getElementById('code-editor');
    const output = document.getElementById('code-output');
    
    if (!codeEditor || !output) return;
    
    const code = codeEditor.textContent || codeEditor.innerText;
    output.textContent = 'å®Ÿè¡Œä¸­...';
    
    try {
        const response = await fetch('/cstudy/api/run-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ source: code })
        });
        
        const result = await response.json();
        
        if (result.stdout) {
            output.innerHTML = `<strong>å®Ÿè¡Œçµæœ:</strong><br><pre>${result.stdout}</pre>`;
        } else if (result.stderr) {
            output.innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong><br><pre style="color: red;">${result.stderr}</pre>`;
        } else {
            output.textContent = 'å‡ºåŠ›ãªã—';
        }
    } catch (error) {
        output.innerHTML = `<strong>ã‚¨ãƒ©ãƒ¼:</strong><br><pre style="color: red;">${error.message}</pre>`;
    }
}

// ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹ç”¨ã®ã‚³ãƒ¼ãƒ‰å®Ÿè¡Œæ©Ÿèƒ½
async function runParallaxCode(button) {
    const codeBlock = button.parentElement.querySelector('pre code');
    const outputDiv = button.parentElement.querySelector('.code-output');
    const outputPre = outputDiv.querySelector('pre');
    
    if (!codeBlock || !outputDiv || !outputPre) return;
    
    const code = codeBlock.textContent;
    outputDiv.style.display = 'block';
    outputPre.textContent = 'å®Ÿè¡Œä¸­...';
    
    try {
        const response = await fetch('/cstudy/api/run-code/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ source: code })
        });
        
        const result = await response.json();
        
        if (result.stdout) {
            outputPre.textContent = result.stdout;
        } else if (result.stderr) {
            outputPre.textContent = `ã‚¨ãƒ©ãƒ¼:\n${result.stderr}`;
            outputPre.style.color = 'red';
        } else {
            outputPre.textContent = 'å‡ºåŠ›ãªã—';
        }
        
        // å·ç”°ã®ãƒªã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        if (window.kawadaScheduler) {
            kawadaScheduler.showKawadaMessage(
                "å®Ÿè¡Œå®Œäº†ï¼", 
                "ã‚³ãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸï¼ã„ã‹ãŒã§ã—ãŸã‹ï¼ŸğŸ’»", 
                'cheerful'
            );
        }
    } catch (error) {
        outputPre.textContent = `ã‚¨ãƒ©ãƒ¼: ${error.message}`;
        outputPre.style.color = 'red';
    }
}

// åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', () => {
    new UnifiedCStudy();
});
</script>
{% endblock %}
